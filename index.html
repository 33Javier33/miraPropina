<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Bóveda Personal</title>
  
  <!-- El Manifest ya estaba aquí correctamente -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a"/>

  <!-- Fuentes e Iconos -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* =========================================
       DISEÑO FINTECH / BANCARIO (V8 - FINAL)
       ========================================= */
    :root {
        /* Colores Corporativos Bancarios */
        --primary-color: #2563eb; /* Royal Blue */
        --primary-dark: #1e40af;
        --primary-light: #eff6ff;
        
        --accent-color: #6366f1; /* Indigo */
        --success-color: #10b981; /* Emerald */
        --danger-color: #ef4444; /* Rose */
        --warning-color: #f59e0b; /* Amber */
        
        /* Fondos y Superficies */
        --bg-main: #f8fafc; /* Slate 50 */
        --bg-card: #ffffff;
        --bg-input: #f1f5f9;
        
        /* Textos */
        --text-primary: #0f172a; /* Slate 900 */
        --text-secondary: #64748b; /* Slate 500 */
        --text-muted: #94a3b8;
        
        /* UI Elements */
        --radius-xl: 24px;
        --radius-lg: 16px;
        --radius-md: 12px;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-card: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-floating: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        
        --menu-width: 280px;
        --header-height: 70px;
    }

    body.dark-mode {
        --bg-main: #0f172a; /* Slate 900 */
        --bg-card: #1e293b; /* Slate 800 */
        --bg-input: #334155;
        --text-primary: #f8fafc;
        --text-secondary: #94a3b8;
        --primary-light: #1e293b;
        --shadow-card: 0 4px 6px -1px rgba(0,0,0,0.5);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--bg-main);
        margin: 0;
        color: var(--text-primary);
        transition: background-color 0.3s ease, color 0.3s ease;
        font-size: 15px;
        line-height: 1.5;
        padding-bottom: 90px; /* Espacio extra footer */
    }

    h1, h2, h3, h4, button { font-family: 'Poppins', sans-serif; letter-spacing: -0.02em; }

    /* --- BOTONES ESTILO FINTECH --- */
    button {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 14px 20px;
        border-radius: var(--radius-md);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        display: inline-flex; justify-content: center; align-items: center; gap: 8px;
        font-size: 0.95rem;
    }
    button:active { transform: scale(0.98); }
    button:hover { background: var(--primary-dark); box-shadow: 0 6px 16px rgba(37, 99, 235, 0.3); }
    button:disabled { background-color: var(--text-muted); cursor: not-allowed; box-shadow: none; opacity: 0.7; }
    
    .reset-button { 
        background-color: transparent; 
        color: var(--danger-color); 
        border: 1px solid rgba(239, 68, 68, 0.3); 
        box-shadow: none; 
    }
    .reset-button:hover { background-color: rgba(239, 68, 68, 0.05); border-color: var(--danger-color); color: var(--danger-color); }
    
    .logout-button { 
        background: rgba(255,255,255,0.1); 
        backdrop-filter: blur(4px);
        color: var(--text-primary); 
        border: 1px solid var(--text-muted); 
        padding: 8px 14px; 
        font-size: 0.85em; 
        box-shadow: none; border-radius: 20px;
        margin-left: 5px;
    }
    .logout-button:hover {
        background: rgba(239, 68, 68, 0.1);
        border-color: var(--danger-color);
        color: var(--danger-color);
    }

    /* --- INPUTS BANCARIOS --- */
    input, select, textarea {
        width: 100%; padding: 14px 16px;
        border: 1px solid transparent; 
        border-radius: var(--radius-md);
        background-color: var(--bg-input); 
        color: var(--text-primary);
        font-family: inherit; font-size: 1rem; 
        outline: none; transition: 0.2s;
        font-weight: 500;
    }
    input:focus, select:focus, textarea:focus { 
        background-color: var(--bg-card);
        border-color: var(--primary-color); 
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); 
    }
    label { font-size: 0.85em; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; display: block; margin-left: 4px; }

    /* --- LAYOUT PRINCIPAL --- */
    .main-container {
        padding: 20px;
        padding-top: calc(var(--header-height) + 20px);
        max-width: 1000px; margin: 0 auto; min-height: 100vh;
        transition: margin-left 0.3s ease;
    }

    @media (min-width: 992px) {
        .main-container { margin-left: var(--menu-width); padding-top: 40px; }
    }

    /* --- HEADER FLOTANTE --- */
    .app-header {
        position: fixed; top: 0; left: 0; right: 0;
        height: var(--header-height);
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(0,0,0,0.05);
        display: flex; justify-content: space-between; align-items: center;
        padding: 0 20px; z-index: 900;
        transition: left 0.3s;
    }
    body.dark-mode .app-header { background: rgba(15, 23, 42, 0.85); border-bottom-color: rgba(255,255,255,0.05); }
    @media (min-width: 992px) { .app-header { left: var(--menu-width); padding: 0 40px; } }

    .app-header h1 {
        margin: 0; font-size: 1.2rem; font-weight: 700;
        color: var(--text-primary);
    }
    .user-info-cluster {
        display: flex; align-items: center; gap: 12px;
    }
    .user-avatar-small {
        width: 36px; height: 36px; border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        color: white; display: flex; align-items: center; justify-content: center;
        font-weight: 600; font-size: 0.9rem;
    }
    #userInfo { font-weight: 600; font-size: 0.9rem; display: none; }
    @media(min-width: 400px) { #userInfo { display: block; } }

    /* --- TARJETA DE CRÉDITO / BALANCE --- */
    .bank-card {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: white;
        padding: 25px;
        border-radius: var(--radius-xl);
        position: relative;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        margin-bottom: 25px;
        border: 1px solid rgba(255,255,255,0.1);
    }
    .bank-card::before {
        content: ''; position: absolute; top: -50%; right: -20%;
        width: 300px; height: 300px;
        background: radial-gradient(circle, rgba(37,99,235,0.4) 0%, rgba(0,0,0,0) 70%);
        border-radius: 50%; pointer-events: none;
    }
    .bank-card-header { display: flex; justify-content: space-between; margin-bottom: 30px; opacity: 0.8; font-size: 0.9rem; }
    .bank-card-balance-label { font-size: 0.9rem; font-weight: 500; color: #94a3b8; }
    .bank-card-balance { font-size: 2.5rem; font-weight: 700; margin: 5px 0 20px 0; letter-spacing: -1px; }
    .bank-card-footer { display: flex; justify-content: space-between; align-items: flex-end; }
    .bank-card-chip { width: 40px; height: 30px; background: rgba(255,255,255,0.2); border-radius: 6px; position: relative; overflow: hidden; }
    .bank-card-chip::after { content:''; position: absolute; left: 50%; top:0; height: 100%; width: 1px; background: rgba(0,0,0,0.3); }
    .total-result.negative-value { color: #ff8a8a !important; }

    /* --- CONTENEDORES --- */
    section {
        background: var(--bg-card); padding: 25px; border-radius: var(--radius-xl);
        box-shadow: var(--shadow-card); margin-bottom: 25px; 
        animation: fadeIn 0.4s ease;
    }
    h2 { font-size: 1.25rem; margin: 0 0 20px 0; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 10px; }
    h2 i { color: var(--primary-color); font-size: 0.9em; }

    /* --- LOGIN BANCARIO --- */
    #login-container { 
        display: flex; justify-content: center; align-items: center; 
        min-height: 100vh; background: var(--bg-main); padding: 20px; 
    }
    #loginSection { 
        width: 100%; max-width: 420px; 
        background: var(--bg-card); 
        padding: 40px 30px; 
        border-radius: var(--radius-xl); 
        box-shadow: var(--shadow-floating);
        text-align: center;
    }
    .brand-logo { 
        width: 60px; height: 60px; background: var(--primary-color); 
        color: white; border-radius: 18px; margin: 0 auto 20px; 
        display: flex; align-items: center; justify-content: center; font-size: 1.8rem;
        box-shadow: 0 10px 20px rgba(37,99,235,0.3);
    }

    /* --- LISTAS DE TRANSACCIONES --- */
    .transaction-list { display: flex; flex-direction: column; gap: 12px; }
    .transaction-item {
        display: flex; justify-content: space-between; align-items: center;
        padding: 16px; background: var(--bg-main); 
        border-radius: var(--radius-lg);
        transition: transform 0.2s;
        border: 1px solid transparent;
    }
    .transaction-item:hover { transform: translateY(-2px); border-color: var(--primary-color); }
    .t-icon { 
        width: 40px; height: 40px; border-radius: 12px; 
        background: var(--primary-light); color: var(--primary-color);
        display: flex; align-items: center; justify-content: center;
        margin-right: 15px; font-size: 1.1rem;
    }
    .t-info { flex: 1; text-align: left; }
    .t-title { font-weight: 600; font-size: 0.95rem; color: var(--text-primary); display: block; }
    .t-date { font-size: 0.8rem; color: var(--text-secondary); }
    .t-amount { font-weight: 700; font-size: 1rem; }
    .t-amount.positive { color: var(--success-color); }
    .t-amount.negative { color: var(--text-primary); }

    /* --- CALENDARIO MODERNO --- */
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 15px; }
    .day-name { text-align: center; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .day {
        aspect-ratio: 1; display: flex; justify-content: center; align-items: center; border-radius: 12px;
        font-size: 0.9rem; font-weight: 500; cursor: pointer; 
        background: var(--bg-input); transition: 0.2s;
        border: 2px solid transparent;
    }
    .day:hover:not(.empty) { border-color: var(--primary-color); }
    .day.marked { background: var(--success-color); color: white; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.4); }
    .day.absent { background: var(--danger-color); color: white; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4); text-decoration: none; }

    /* --- FAB & MENÚ --- */
    .menu-toggle {
        position: fixed; top: 15px; left: 15px; z-index: 1100;
        width: 44px; height: 44px; background: var(--bg-card); color: var(--text-primary);
        border-radius: 12px; box-shadow: var(--shadow-card);
        display: flex; align-items: center; justify-content: center; border: none;
    }
    .side-menu {
        background: var(--bg-card); width: var(--menu-width);
        position: fixed; top: 0; bottom: 0; left: 0; z-index: 1000;
        transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        padding: 30px 20px; border-right: 1px solid rgba(0,0,0,0.05);
    }
    .side-menu.open { transform: translateX(0); }
    .side-menu a {
        padding: 16px; border-radius: var(--radius-md); 
        color: var(--text-secondary); text-decoration: none; font-weight: 500; 
        display: block; margin-bottom: 8px; transition: 0.2s;
    }
    .side-menu a.active-link { background: var(--primary-light); color: var(--primary-color); font-weight: 600; }
    
    .fab-container { position: fixed; bottom: 25px; right: 25px; display: flex; flex-direction: column; gap: 15px; z-index: 1000; }
    .fab { width: 56px; height: 56px; border-radius: 20px; background: var(--text-primary); color: var(--bg-main); box-shadow: 0 8px 20px rgba(0,0,0,0.2); display: flex; justify-content: center; align-items: center; font-size: 1.2rem; cursor: pointer; border: none; transition: 0.3s; position: relative; }
    
    /* Notificación sobre el FAB */
    #note-notification-count {
        position: absolute;
        top: -10px;
        right: -10px;
        background: white;
        color: var(--danger-color);
        border-radius: 50%;
        width: 26px;
        height: 26px;
        font-size: 13px;
        font-weight: 800;
        display: none; 
        align-items: center;
        justify-content: center;
        border: 2px solid var(--danger-color);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .content-panel { display: none; }
    .content-panel.active { display: block; }
    
    .calculation-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .calc-box { background: var(--bg-input); padding: 15px; border-radius: var(--radius-md); text-align: center; }
    .calc-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 5px; }
    .calc-value { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); }

    .form-row, .form-row-date { display: flex; gap: 10px; margin-bottom: 12px; }
    .password-wrapper { position: relative; width: 100%; margin-bottom: 20px; }
    .password-toggle-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); cursor: pointer; }

    /* --- NOTAS / CHAT --- */
    #admin-notes-container {
        background: var(--bg-main); border-radius: var(--radius-lg);
        padding: 20px; 
        height: 65vh; 
        max-height: 600px; 
        overflow-y: auto; border: 1px solid rgba(0,0,0,0.05);
        display: flex; flex-direction: column; gap: 15px;
        scroll-behavior: smooth;
    }
    .note-card {
        padding: 12px 16px; border-radius: 12px 12px 12px 0;
        background: white; color: var(--text-primary);
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        max-width: 85%; align-self: flex-start;
        font-size: 0.95rem;
        position: relative;
    }
    body.dark-mode .note-card { background: #334155; }
    .note-card.user-note {
        align-self: flex-end; border-radius: 12px 12px 0 12px;
        background: var(--primary-color); color: white;
    }

    .modal-backdrop { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
    .modal-content { border-radius: var(--radius-xl); padding: 30px; box-shadow: var(--shadow-floating); border: 1px solid rgba(255,255,255,0.1); }
    
    .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .nav-btn { background: var(--bg-input); color: var(--text-primary); border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; box-shadow: none; width: auto; height: auto; }

    @keyframes pulse-red {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      70% { transform: scale(1.1); box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
    .pulse-notification { 
        animation: pulse-red 2s infinite; 
        background: var(--danger-color) !important; 
        color: white !important;
        display: flex !important;
    }
  </style>
</head>
<body>

<nav id="sideMenu" class="side-menu"></nav>

<div id="mainContainer" class="main-container">
    <button id="menuToggle" class="menu-toggle" style="display: none;">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Botón Ayuda -->
    <button id="help-btn" class="fab" style="position:fixed; bottom:25px; left:25px; top:auto; right:auto; width:45px; height:45px; border-radius:50%; background:var(--bg-card); color:var(--text-primary); font-size:1rem; z-index:1200; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
        <i class="fas fa-question"></i>
    </button>
    
    <!-- Panel Ayuda -->
    <div id="help-panel" style="position:fixed; top:0; left:0; width:300px; height:100%; background:var(--bg-card); z-index:2100; transform:translateX(-100%); transition:0.3s; padding:20px; box-shadow:5px 0 20px rgba(0,0,0,0.1);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0;">Ayuda</h2>
            <button id="close-help-btn" style="background:none; color:var(--text-primary); padding:0; box-shadow:none;"><i class="fas fa-times" style="font-size:1.5rem;"></i></button>
        </div>
        <div class="help-content">
            <div id="help-content-login" class="help-content-section">
                <h3>Acceso Seguro</h3>
                <p style="color:var(--text-secondary);">Ingresa tus credenciales para acceder a tu bóveda personal.</p>
            </div>
            <div id="help-content-main" class="help-content-section">
                <h3>Resumen</h3>
                <p style="color:var(--text-secondary);">Aquí puedes ver tu saldo acumulado, anticipos y estadísticas.</p>
            </div>
        </div>
    </div>
    
    <!-- LOGIN SCREEN -->
    <div id="login-container">
      <section id="loginSection">
        <div class="brand-logo"><i class="fas fa-wallet"></i></div>
        <h2 style="justify-content:center; margin-bottom:10px;">Bóveda Personal</h2>
        <p style="color: var(--text-secondary); margin-bottom: 30px; font-size:0.9rem;">Gestión financiera de propinas</p>
        
        <section id="quickAccessSection" style="display: none; padding: 0; box-shadow: none; background: transparent; margin-bottom:20px;">
            <div id="quickAccessUsers" style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;"></div>
        </section>
        
        <form id="loginForm">
            <div class="form-row">
                <input type="text" id="loginNombre" placeholder="Nombre" required />
                <input type="text" id="loginApellido" placeholder="Apellido" required />
            </div>
            <div class="form-row">
                <select id="loginTipoContrato" required>
                    <option value="">Tipo de Contrato</option>
                    <option value="Planta">Planta</option>
                    <option value="Part Time">Part Time</option>
                </select>
            </div>
            <div class="form-row">
                 <select id="loginSeccion" required>
                    <option value="">Sección</option>
                    <option value="Mesas">Mesas</option>
                    <option value="Máquinas">Máquinas</option>
                    <option value="Bóveda">Bóveda</option>
                    <option value="Técnicos">Técnicos</option>
                    <option value="TGM">TGM</option>
                </select>
            </div>
            <div class="form-row-date">
              <select id="loginDia" required style="flex:1"><option value="">Día</option><script>for(let i=1;i<=31;i++)document.write(`<option value="${i}">${i}</option>`);</script></select>
              <select id="loginMes" required style="flex:1"><option value="">Mes</option><script>for(let i=1;i<=12;i++)document.write(`<option value="${i}">${i}</option>`);</script></select>
              <input type="number" id="loginAnio" placeholder="Año" required style="flex:1"/>
            </div>
            <input type="number" id="loginPuntos" placeholder="Cantidad de Puntos" required style="margin-bottom:12px;"/>
            <div class="password-wrapper">
              <input type="password" id="loginPassword" placeholder="Contraseña de Acceso" required />
              <i class="fas fa-eye password-toggle-icon"></i>
            </div>
            <button type="submit" style="width:100%; font-size:1rem;">Entrar a la Bóveda</button>
            <a href="#" id="forgotPasswordLink" style="color: var(--primary-color); margin-top: 20px; display:block; font-size: 0.85em; text-decoration: none; font-weight:500;">Recuperar Contraseña</a>
        </form>
      </section>
    </div>

    <!-- MAIN APP CONTENT -->
    <div id="main-content" style="display: none;">
      
      <!-- Top Bar Bancario -->
      <div class="app-header">
        <h1>Mi Billetera</h1>
        <div class="user-info-cluster">
            <div style="text-align:right; line-height:1.2;">
                <span id="userInfo" style="display:block; color:var(--text-primary);">Usuario</span>
                <small style="color:var(--text-secondary); font-size:0.7em;">En línea</small>
            </div>
            <div class="user-avatar-small"><i class="fas fa-user"></i></div>
            <button id="logoutBtn" class="logout-button"><i class="fas fa-power-off"></i></button>
        </div>
      </div>
      
      <!-- SECCIÓN: RETIRO DE PROPINA (DASHBOARD) -->
      <section id="retirosPropinaSection" class="content-panel" style="background:transparent; box-shadow:none; padding:0;">
          
          <!-- PLANTA VIEW -->
          <div id="vistaPlanta" style="display: none;">
              <div class="bank-card">
                  <div class="bank-card-header">
                      <span>CUANTA PROPINA </span>
                      <span><i class="fas fa-wifi" style="transform: rotate(90deg);"></i></span>
                  </div>
                  <div class="bank-card-chip"></div>
                  <div class="bank-card-balance-label" style="margin-top:15px; color: rgba(255,255,255,0.7);">Saldo Disponible</div>
                  <div class="bank-card-balance" id="resultadoFinalPlanta">$0</div>
                  <div class="bank-card-footer">
                      <span style="font-family:monospace; opacity:0.8;">**** 2026</span>
                      <span style="font-weight:700; font-style:italic; font-size:1.2em;">COMISIÓN</span>
                  </div>
              </div>

              <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:25px;">
                  <button id="registrarAnticipoBtn" style="background:var(--bg-card); color:var(--text-primary); flex-direction:column; padding:15px 10px; gap:5px; box-shadow:var(--shadow-sm);">
                      <i class="fas fa-arrow-down" style="color:var(--danger-color); font-size:1.2em;"></i>
                      <span style="font-size:0.8em;">Anticipo</span>
                  </button>
                  <button id="openStatsModalBtn" style="background:var(--bg-card); color:var(--text-primary); flex-direction:column; padding:15px 10px; gap:5px; box-shadow:var(--shadow-sm);">
                      <i class="fas fa-chart-pie" style="color:var(--primary-color); font-size:1.2em;"></i>
                      <span style="font-size:0.8em;">Estadísticas</span>
                  </button>
                   <button id="openCalendarPlantaBtn" style="background:var(--bg-card); color:var(--text-primary); flex-direction:column; padding:15px 10px; gap:5px; box-shadow:var(--shadow-sm);">
                      <i class="far fa-calendar-times" style="color:var(--warning-color); font-size:1.2em;"></i>
                      <span style="font-size:0.8em;">Ausencias</span>
                  </button>
              </div>

              <section>
                  <h2><i class="fas fa-file-invoice-dollar"></i> Resumen del Periodo</h2>
                  <div class="calculation-grid">
                      <div class="calc-box">
                          <span class="calc-label">Mis Puntos</span>
                          <span class="calc-value" id="puntosUsuarioDisplayPlanta">0</span>
                      </div>
                      <div class="calc-box">
                          <span class="calc-label">Valor Punto Prom.</span>
                          <span class="calc-value" id="valorPorPuntoDisplayPlanta" style="color:var(--primary-color);">$0</span>
                      </div>
                      <div class="calc-box">
                          <span class="calc-label">Total Recaudado</span>
                          <span class="calc-value" id="totalMontoDividirPlanta">$0</span>
                      </div>
                       <div class="calc-box">
                          <span class="calc-label">Días Faltados</span>
                          <span class="calc-value" id="diasDescontadosPlanta" style="color:var(--danger-color);">0</span>
                      </div>
                  </div>
                  
                  <div class="transaction-list">
                      <div class="transaction-item">
                          <div style="display:flex; align-items:center;">
                              <div class="t-icon" style="background:var(--success-color); color:white;"><i class="fas fa-coins"></i></div>
                              <div class="t-info"><span class="t-title">Subtotal Ganado (Teórico)</span></div>
                          </div>
                          <span class="t-amount positive" id="subtotalDisplayPlanta">$0</span>
                      </div>
                      <div class="transaction-item">
                           <div style="display:flex; align-items:center;">
                              <div class="t-icon" style="background:var(--danger-color); color:white;"><i class="fas fa-user-times"></i></div>
                              <div class="t-info"><span class="t-title">Dinero No Percibido (Ausencias)</span></div>
                          </div>
                          <span class="t-amount negative" id="montoDescontadoPlanta">-$0</span>
                      </div>
                       <div class="transaction-item">
                           <div style="display:flex; align-items:center;">
                              <div class="t-icon" style="background:var(--warning-color); color:white;"><i class="fas fa-hand-holding-usd"></i></div>
                              <div class="t-info"><span class="t-title">Anticipos</span></div>
                          </div>
                          <span class="t-amount negative" id="anticiposDisplayPlanta">-$0</span>
                      </div>
                      <div class="transaction-item">
                           <div style="display:flex; align-items:center;">
                              <div class="t-icon" style="background:var(--primary-color); color:white;"><i class="fas fa-history"></i></div>
                              <div class="t-info">
                                  <span class="t-title">Saldo Anterior</span>
                                  <button class="edit-btn-inline" id="btnEditSaldoPlanta" style="padding:2px; font-size:0.8em; background:none; color:var(--primary-color); box-shadow:none;">Editar</button>
                              </div>
                          </div>
                          <span class="t-amount positive" id="saldoAnteriorDisplayPlanta">$0</span>
                      </div>
                  </div>
                   <span id="divisorDisplayPlanta" style="display:none;"></span>
              </section>

              <section>
                  <h2><i class="fas fa-list"></i> Historial de Anticipos</h2>
                  <div id="anticipos-list-container-planta" class="transaction-list"></div>
                  <button id="resetMesBtn" class="reset-button" style="width:100%; margin-top:15px;">Reiniciar Periodo</button>
              </section>
          </div>

          <!-- PART TIME VIEW -->
          <div id="vistaPartTime" style="display: none;">
              <div class="bank-card" style="background: linear-gradient(135deg, #4338ca 0%, #312e81 100%);">
                  <div class="bank-card-header">
                      <span>CUANTA PROPINA (PT)</span>
                      <span><i class="fas fa-wifi" style="transform: rotate(90deg);"></i></span>
                  </div>
                  <div class="bank-card-chip"></div>
                  <div class="bank-card-balance-label" style="margin-top:15px; color: rgba(255,255,255,0.7);">Saldo Disponible</div>
                  <div class="bank-card-balance" id="resultadoFinalPT">$0</div>
                  <div class="bank-card-footer">
                      <span style="font-family:monospace; opacity:0.8;">**** 2026</span>
                      <span style="font-weight:700; font-style:italic; font-size:1.2em;">COMISIÓN</span>
                  </div>
              </div>

               <div style="display:flex; gap:15px; flex-wrap:wrap;">
                   <div style="flex:1; min-width:300px; background:var(--bg-card); padding:20px; border-radius:var(--radius-xl); box-shadow:var(--shadow-card); text-align:center;">
                        <h4 style="margin-top:0;"><i class="far fa-calendar-check" style="color:var(--success-color);"></i> Gestión de Turnos</h4>
                        <p style="color:var(--text-secondary); font-size:0.85rem; margin-bottom:15px;">Registra los días que asististe para calcular tu parte.</p>
                        <button id="openCalendarPTBtn" style="width:100%; background:var(--bg-input); color:var(--text-primary); box-shadow:none;"><i class="fas fa-calendar-alt"></i> Marcar Días Trabajados</button>
                   </div>
                   
                   <div style="flex:1; min-width:300px; background:var(--bg-card); padding:20px; border-radius:var(--radius-xl); box-shadow:var(--shadow-card);">
                       <div class="calculation-grid">
                          <div class="calc-box"><span class="calc-label">Mis Puntos</span><span class="calc-value" id="puntosUsuarioDisplayPT">0</span></div>
                          <div class="calc-box"><span class="calc-label">Pozo Indiv.</span><span class="calc-value" id="pozoIndividualDisplayPT">$0</span></div>
                       </div>
                       <div class="transaction-list">
                            <div class="transaction-item">
                                <span class="t-title">Valor Punto</span><span class="t-amount" id="valorPorPuntoDisplayPT">$0</span>
                            </div>
                             <div class="transaction-item">
                                <span class="t-title">Subtotal</span><span class="t-amount positive" id="subtotalDisplayPT">$0</span>
                            </div>
                            <div class="transaction-item">
                                <span class="t-title">Anticipos</span><span class="t-amount negative" id="anticiposDisplayPT">-$0</span>
                            </div>
                             <div class="transaction-item">
                                <span class="t-title">Saldo Ant. <button id="btnEditSaldoPT" style="background:none; color:var(--primary-color); padding:0; box-shadow:none;"><i class="fas fa-pencil-alt"></i></button></span>
                                <span class="t-amount positive" id="saldoAnteriorDisplayPT">$0</span>
                            </div>
                       </div>
                       <span id="divisorDisplayPT" style="display:none;"></span>
                        <div id="anticipos-list-container-pt" class="transaction-list" style="margin-top:15px; border-top:1px solid var(--bg-input); padding-top:10px;"></div>
                   </div>
               </div>
               
               <div style="margin-top:20px; display:flex; gap:10px;">
                    <button id="registrarAnticipoBtnPT" style="flex:1; background:var(--primary-color);">+ Anticipo</button> 
               </div>
          </div>
      </section>

      <!-- SECCIÓN: MONTOS (HISTORIAL) -->
      <section id="montosSection" class="content-panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>Transacciones</h2>
            <button id="importarDesdeSheetsBtn" style="padding:8px 15px; font-size:0.8rem; background:var(--text-primary);"><i class="fas fa-sync-alt"></i> Sincronizar</button>
        </div>
        <div id="totalDiario" style="background:var(--primary-light); color:var(--primary-dark); padding:15px; border-radius:var(--radius-md); text-align:center; font-weight:700; margin-bottom:20px;">
            Total recaudado: $0
        </div>
        <div id="tarjetasMontos" style="display:flex; flex-direction:column; gap:15px;"></div>
      </section>

      <!-- SECCIÓN: DATOS DE USUARIO -->
      <section id="datosUsuarioSection" class="content-panel">
          <h2><i class="far fa-id-card"></i> Perfil Financiero</h2>
          <div style="display:flex; flex-direction:column; align-items:center; margin-bottom:30px;">
               <div style="width:80px; height:80px; background:var(--bg-input); border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--text-secondary); font-size:2rem; margin-bottom:10px;">
                   <i class="fas fa-user"></i>
               </div>
               <h3 id="userDataNombre" style="margin:0;">Usuario</h3>
               <span id="userDataContrato" style="color:var(--text-secondary); font-size:0.9rem;">Tipo Contrato</span>
          </div>
          <div class="transaction-list">
              <div class="transaction-item">
                  <span class="t-title">Puntos Asignados</span>
                  <div style="display:flex; align-items:center; gap:10px;">
                      <span id="userDataPuntos" class="t-amount"> <span id="puntosValueDisplay"></span></span>
                      <button id="editPuntosBtn" style="background:var(--bg-input); color:var(--text-primary); padding:5px 10px; border-radius:8px; box-shadow:none;"><i class="fas fa-pencil-alt"></i></button>
                  </div>
              </div>
               <div class="transaction-item">
                  <span class="t-title">Fecha de Ingreso</span>
                  <span id="userDataFechaIngreso" class="t-amount" style="font-weight:500; color:var(--text-secondary);"></span>
              </div>
          </div>
          <div style="margin-top: 30px; display:grid; gap:10px;">
              <button id="changePasswordBtn" style="background:var(--bg-input); color:var(--text-primary); box-shadow:none; justify-content:flex-start;"><i class="fas fa-lock"></i> Cambiar Contraseña</button>
              <button id="exportDataBtn" style="background:var(--bg-input); color:var(--text-primary); box-shadow:none; justify-content:flex-start;"><i class="fas fa-file-download"></i> Exportar Respaldo JSON</button>
               <button id="importDataBtn" style="background:var(--bg-input); color:var(--text-primary); box-shadow:none; justify-content:flex-start;"><i class="fas fa-file-upload"></i> Restaurar Respaldo</button>
          </div>
      </section>
      
      <!-- SECCIÓN: NOTAS -->
      <section id="notasSection" class="content-panel">
          <h2><i class="far fa-comments"></i> Mensajes Seguros</h2>
          <div id="admin-notes-container"></div>
          <form id="responseForm" style="margin-top: 15px; display:flex; gap:10px;">
              <textarea id="responseMessage" placeholder="Escribir mensaje..." rows="1" style="resize:none; border-radius:20px; padding:12px 20px;"></textarea>
              <button type="button" id="sendResponseBtn" style="border-radius:50%; width:50px; height:50px; padding:0;"><i class="fas fa-paper-plane"></i></button>
          </form>
      </section>
    </div> 
</div>

<div class="fab-container">
    <!-- ICONO FLOTANTE DE NOTIFICACIÓN -->
    <button id="notification-fab" class="fab pulse-notification" style="display:none;">
        <i class="fas fa-bell"></i>
        <span id="note-notification-count">0</span>
    </button>
    <button id="theme-toggle" class="fab"><i class="fas fa-moon"></i></button>
</div>

<footer>
    <div style="text-align:center; padding:30px 20px; color:var(--text-secondary); font-size:0.8rem;">
        <div style="font-weight:600; margin-bottom:8px; color:var(--text-primary);">CarlosPN Interactive®</div>
        <div style="font-size:0.75rem; opacity:0.8;"><i class="fas fa-shield-alt"></i> Conexión Segura</div>
    </div>
</footer>

<div id="toast-container" style="position:fixed; top:90px; right:20px; z-index:3000;"></div>

<!-- MODALES -->
<div id="statsModal" class="modal-backdrop" style="display: none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:2000; justify-content:center; align-items:center;">
    <div class="modal-content" style="background:var(--bg-card); width:90%; max-width:450px;">
        <div class="modal-header" style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h4><i class="fas fa-chart-line"></i> Análisis</h4>
            <button id="closeStatsModalBtn" style="background:none; color:var(--text-primary); padding:0; box-shadow:none; font-size:1.5rem;">&times;</button>
        </div>
        <div class="modal-body">
            <div class="stat-cards" id="statCardsContainer" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;"></div>
            <div class="chart-controls" style="display:flex; justify-content:center; gap:10px; margin-bottom:15px;">
                <button id="dailyViewBtn" class="active" style="padding:5px 15px; font-size:0.8rem;">Diario</button>
                <button id="weeklyViewBtn" style="padding:5px 15px; font-size:0.8rem; background:var(--bg-input); color:var(--text-primary);">Semanal</button>
            </div>
            <div class="chart-container" style="height:250px; width:100%;"><canvas id="tipChart"></canvas></div>
        </div>
    </div>
</div>

<div id="calendarPlantaModal" class="modal-backdrop" style="display: none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:2000; justify-content:center; align-items:center;">
    <div class="modal-content" style="background:var(--bg-card); width:90%; max-width:400px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h4>Marcar Ausencias</h4><button id="closeCalendarPlantaBtn" style="background:none; color:var(--text-primary); border:none; font-size:1.5rem;">&times;</button></div>
        <div class="modal-body">
            <p style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 15px; background: var(--bg-input); padding: 10px; border-radius: 8px;">Toca los días que <strong style="color:var(--danger-color)">NO</strong> trabajaste.</p>
            <div id="calendar-container-planta"></div>
        </div>
    </div>
</div>

<div id="calendarPTModal" class="modal-backdrop" style="display: none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:2000; justify-content:center; align-items:center;">
    <div class="modal-content" style="background:var(--bg-card); width:90%; max-width:400px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h4>Días Trabajados</h4><button id="closeCalendarPTBtn" style="background:none; color:var(--text-primary); border:none; font-size:1.5rem;">&times;</button></div>
        <div class="modal-body">
            <p style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 15px; background: var(--bg-input); padding: 10px; border-radius: 8px;">Marca los días que <strong style="color:var(--success-color)">SÍ</strong> estuviste presente.</p>
            <div id="calendar-container"></div>
        </div>
    </div>
</div>

<div id="addAnticipoModal" class="modal-backdrop" style="display: none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:2000; justify-content:center; align-items:center;">
    <div class="modal-content" style="background:var(--bg-card); width:90%; max-width:350px;">
        <h4>Nuevo Anticipo</h4>
        <label>Monto ($)</label><input type="text" id="addAnticipoMontoInput" inputmode="numeric" style="font-size:1.2rem; font-weight:bold;"/>
        <label style="margin-top:10px;">Fecha</label><input type="date" id="addAnticipoFechaInput"/>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="reset-button" id="cancelAddAnticipoBtn" style="flex:1;">Cancelar</button>
            <button id="saveAddAnticipoBtn" style="flex:1;">Guardar</button>
        </div>
    </div>
</div>

<div id="editAnticipoModal" class="modal-backdrop" style="display: none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:2000; justify-content:center; align-items:center;">
    <div class="modal-content" style="background:var(--bg-card); width:90%; max-width:350px;">
        <h4>Editar Anticipo</h4>
        <label>Monto</label><input type="text" id="editAnticipoMontoInput" inputmode="numeric"/>
        <label style="margin-top:10px;">Fecha</label><input type="date" id="editAnticipoFechaInput"/>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="reset-button" id="cancelEditAnticipoBtn" style="flex:1;">Cancelar</button>
            <button id="saveEditAnticipoBtn" style="flex:1;">Actualizar</button>
        </div>
    </div>
</div>

<div id="saldoAnteriorModal" class="modal-backdrop" style="display: none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:2000; justify-content:center; align-items:center;">
    <div class="modal-content" style="background:var(--bg-card); width:90%; max-width:350px;">
        <h4>Saldo Mes Anterior</h4>
        <label>Monto a favor (+)</label><input type="number" id="saldoAnteriorInput" placeholder="0" style="font-size:1.2rem;"/>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="reset-button" id="cancelSaldoBtn" style="flex:1;">Cancelar</button>
            <button id="saveSaldoBtn" style="flex:1;">Confirmar</button>
        </div>
    </div>
</div>

<div id="divisorPTModal" class="modal-backdrop" style="display: none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:2000; justify-content:center; align-items:center;">
    <div class="modal-content" style="background:var(--bg-card);"><div class="modal-header"><h4>Editar Divisor</h4></div><div class="modal-body"><label>Divisor:</label><input type="text" id="divisorPTInput" inputmode="numeric"/></div><div class="modal-footer" style="margin-top:20px; text-align:right;"><button class="reset-button" id="cancelDivisorPTBtn">Cancelar</button><button id="saveDivisorPTBtn">Guardar</button></div></div>
</div>
<div id="phoneModal" class="modal-backdrop" style="display: none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:2000; justify-content:center; align-items:center;">
    <div class="modal-content" style="background:var(--bg-card); width:90%; max-width:350px;">
        <h4>Seguridad</h4>
        <p style="color:var(--text-secondary); margin-bottom:15px; font-size:0.9rem;">Vincula tu celular para recuperar tu cuenta.</p>
        <label>Teléfono:</label><input type="tel" id="phoneInput" placeholder="Ej: 912345678"/>
        <button id="savePhoneBtn" style="width:100%; margin-top:20px;">Vincular</button>
    </div>
</div>
<div id="forgotPasswordModal" class="modal-backdrop" style="display: none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:2000; justify-content:center; align-items:center;">
    <div class="modal-content" style="background:var(--bg-card); width:90%; max-width:350px;">
        <h4>Recuperación</h4>
        <div id="verifyPhoneContainer">
            <label>Teléfono Registrado:</label><input type="tel" id="recoverPhoneInput"/>
            <div id="recoveryResult" style="margin-top:10px; font-size:0.9rem;"></div>
        </div>
        <div id="newPasswordContainer" style="display: none;">
            <label>Nueva Contraseña:</label>
            <div class="password-wrapper"><input type="password" id="newPasswordInput"/><i class="fas fa-eye password-toggle-icon"></i></div>
        </div>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="reset-button" id="cancelForgotBtn" style="flex:1;">Cerrar</button>
            <button id="verifyPhoneBtn" style="flex:1;">Verificar</button>
            <button id="saveNewPasswordBtn" style="display: none; flex:1;">Guardar</button>
        </div>
    </div>
</div>
<div id="changePasswordModal" class="modal-backdrop" style="display: none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:2000; justify-content:center; align-items:center;">
    <div class="modal-content" style="background:var(--bg-card); width:90%; max-width:350px;">
        <h4>Cambiar Clave</h4>
        <label>Nueva Contraseña:</label>
        <div class="password-wrapper"><input type="password" id="newPasswordLoggedInInput"/><i class="fas fa-eye password-toggle-icon"></i></div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="reset-button" id="cancelChangePasswordBtn" style="flex:1;">Cancelar</button>
            <button id="saveNewPasswordLoggedInBtn" style="flex:1;">Actualizar</button>
        </div>
    </div>
</div>
<div id="editPuntosModal" class="modal-backdrop" style="display: none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:2000; justify-content:center; align-items:center;">
    <div class="modal-content" style="background:var(--bg-card); width:90%; max-width:350px;">
        <h4>Ajustar Puntos</h4>
        <label>Cantidad:</label><input type="number" id="editPuntosInput"/>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="reset-button" id="cancelEditPuntosBtn" style="flex:1;">Cancelar</button>
            <button id="saveEditPuntosBtn" style="flex:1;">Guardar</button>
        </div>
    </div>
</div>

<input type="file" id="importFileInput" style="display: none;" accept="application/json">

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- URLs ---
    const SCRIPT_URL_NOTAS = 'https://script.google.com/macros/s/AKfycbwhKQTp9kER_H87XLekd3d69u5PK5ZpfpGzKdAtYcfKM0qTUuF5apPvB2UNYSyS2-FR/exec';
    const SCRIPT_URL_RECAUDACION_EXTERNA = 'https://script.google.com/macros/s/AKfycbxdiAMbUy2nTuXvvIuF_-KF-ed0s7jxXvh4X2T5u88jl9FSZdrDkNVgVNc7akhpIwCX/exec';
    const SCRIPT_URL_RECAUDACION = 'https://script.google.com/macros/s/AKfycbxna9EH5LZPTPCPws58pGro6qCrZ8_zNwvUkUHS28BYfd8CsAcD1MRcqlITbDm4lTk/exec'; 
    const SCRIPT_URL_LOGIN = 'https://script.google.com/macros/s/AKfycbzCs74u0wnowFhgAbYM_EL11eEyOH4GivGzwg1v0ovMLW6QvwqOuL9HRhxmAwL9m8X6/exec';

    // --- VARIABLES GLOBALES ---
    const loginContainer = document.getElementById('login-container');
    const mainContent = document.getElementById('main-content');
    const menuToggle = document.getElementById('menuToggle');
    const sideMenu = document.getElementById('sideMenu');
    
    let loggedInUser = null;
    let currentEditAnticipoId = null;
    let pendingLoginUser = null; 
    
    let notesInterval = null; 
    let sheetsInterval = null;
    let statusCheckInterval = null; 
    let heartbeatInterval = null; 
    let allFetchedNotes = [];
    let tipChart = null;
    let divisoresDiariosExternos = {};
    let lastActivityTime = Date.now(); 

    let currentViewMonth = new Date().getMonth();
    let currentViewYear = new Date().getFullYear();

    // Variable para rastrear el último mensaje conocido
    let lastKnownNoteId = localStorage.getItem('lastKnownNoteId') || 0;

    // --- MODO OSCURO ---
    const themeToggleBtn = document.getElementById('theme-toggle');
    if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
        themeToggleBtn.querySelector('i').classList.replace('fa-moon', 'fa-sun');
    }
    themeToggleBtn.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        const icon = themeToggleBtn.querySelector('i');
        if (isDark) { icon.classList.replace('fa-moon', 'fa-sun'); } 
        else { icon.classList.replace('fa-sun', 'fa-moon'); }
    });
    
    // Al pulsar el FAB de notificación, vamos a la sección de notas
    document.getElementById('notification-fab').addEventListener('click', () => { 
        activatePanel('notasSection'); 
    });

    // --- FUNCIONES LOCALSTORAGE ---
    function getAppData() { return JSON.parse(localStorage.getItem('appData')) || { usuarios: {}, userData: {} }; }
    function saveAppData(data) { localStorage.setItem('appData', JSON.stringify(data)); }
    function getUserData() {
        const appData = getAppData();
        const userId = loggedInUser.id;
        if (!appData.userData[userId]) {
            appData.userData[userId] = { montosPorFecha: {}, anticipos: [], divisor: 0, diasTrabajados: [], diasAusencia: [], divisorPartTime: 1, divisorDelDia: null, saldoAnterior: 0 };
            saveAppData(appData);
        }
        if (!appData.userData[userId].diasAusencia) appData.userData[userId].diasAusencia = [];
        if (appData.userData[userId].saldoAnterior === undefined) appData.userData[userId].saldoAnterior = 0;
        return appData.userData[userId];
    }
    function saveUserData(userData) {
        const appData = getAppData();
        const userId = loggedInUser.id;
        appData.userData[userId] = userData;
        saveAppData(appData);
    }
    
    // --- UTILIDADES ---
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.style.padding = '12px 20px'; toast.style.marginBottom = '10px'; toast.style.borderRadius = '10px'; toast.style.background = 'var(--bg-card)'; toast.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)'; toast.style.borderLeft = `5px solid ${type === 'error' ? 'var(--danger-color)' : (type === 'info' ? 'var(--primary-color)' : 'var(--success-color)')}`; toast.style.color = 'var(--text-primary)'; toast.style.fontWeight = '500'; toast.style.animation = 'fadeIn 0.3s';
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 4000);
    }
    function showLoadingOverlay(message = 'Verificando...') {
        let overlay = document.getElementById('loading-overlay');
        if (!overlay) {
            overlay = document.createElement('div'); overlay.id = 'loading-overlay';
            Object.assign(overlay.style, { position: 'fixed', top: '0', left: '0', width: '100%', height: '100%', backgroundColor: 'rgba(0,0,0,0.7)', color: 'white', display: 'flex', justifyContent: 'center', alignItems: 'center', zIndex: '10000', fontSize: '1.5em', transition: 'opacity 0.3s' });
            overlay.innerHTML = `<div style="text-align: center;"><i class="fas fa-circle-notch fa-spin" style="font-size: 2em; margin-bottom: 15px; color:var(--primary-color);"></i><div id="loading-message"></div></div>`;
            document.body.appendChild(overlay);
        }
        overlay.querySelector('#loading-message').textContent = message; overlay.style.opacity = '1'; overlay.style.display = 'flex';
    }
    function hideLoadingOverlay() { const overlay = document.getElementById('loading-overlay'); if (overlay) { overlay.style.opacity = '0'; setTimeout(() => { overlay.style.display = 'none'; }, 300); } }
    function formatNumberWithPoints(value) { if (value === 'Actualizando...') return value; if (value === null || value === undefined || isNaN(value)) { return "0"; } return Math.round(value).toString().replace(/\B(?=(\d{3})+(?!\d))/g, "."); }
    function formatDate(dateString) { if (!dateString) return ''; const [year, month, day] = dateString.split('-'); return `${day}/${month}/${year}`; }
    function getTodayDateString() { return new Date().toISOString().split('T')[0]; }
    function setupNumericInputFormatting(el) { if(el) el.addEventListener('input', e => { let v = e.target.value.replace(/\./g, ''); e.target.dataset.cleanValue = (isNaN(v) || v === '') ? '' : v; e.target.value = (isNaN(v) || v === '') ? '' : formatNumberWithPoints(parseInt(v, 10)); }); }
    function formatNoteDate(isoString) { if (!isoString) return 'Fecha desconocida'; const date = new Date(isoString); return date.toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); }

    function normalizarFecha(fechaInput) {
        if (!fechaInput) return null;
        if (fechaInput instanceof Date) {
            const year = fechaInput.getFullYear();
            const month = String(fechaInput.getMonth() + 1).padStart(2, '0');
            const day = String(fechaInput.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        let str = String(fechaInput).trim();
        if (str.includes('T')) str = str.split('T')[0];
        if (str.includes('/')) {
            const parts = str.split('/');
            if (parts.length === 3) return `${parts[2]}-${String(parts[1]).padStart(2, '0')}-${String(parts[0]).padStart(2, '0')}`;
        }
        if (str.includes('-')) {
            const parts = str.split('-');
            if (parts.length === 3) return `${parts[0]}-${String(parts[1]).padStart(2, '0')}-${String(parts[2]).padStart(2, '0')}`;
        }
        const d = new Date(str);
        if (!isNaN(d.getTime())) {
             const year = d.getFullYear();
             const month = String(d.getMonth() + 1).padStart(2, '0');
             const day = String(d.getDate()).padStart(2, '0');
             return `${year}-${month}-${day}`;
        }
        return str;
    }

    async function enviarDatosLoginASheets(user) {
      if (!user) return { status: 'success' };
      try {
        const response = await fetch(SCRIPT_URL_LOGIN, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(user) });
        return await response.json();
      } catch (error) { return { status: 'error', message: 'Error de conexión.' }; }
    }

    async function sendHeartbeat() {
        if (!loggedInUser) return;
        try { await fetch(SCRIPT_URL_LOGIN, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: 'updateStatus', id: loggedInUser.id, status: 'Activo' }) }); } catch (e) { console.error("Error heartbeat", e); }
    }

    async function sendDisconnectSignal() {
        if (!loggedInUser) return;
        try { await fetch(SCRIPT_URL_LOGIN, { method: 'POST', keepalive: true, headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: 'updateStatus', id: loggedInUser.id, status: 'Desconectado' }) }); } catch (e) { console.error("Error disconnect", e); }
    }

    const normalize = (str) => String(str).replace(/^'/, "").trim().toLowerCase();

    async function verificarEstadoSesion() {
        if (!loggedInUser) return;
        try {
            const response = await fetch(SCRIPT_URL_LOGIN + '?action=read&v=' + Date.now());
            if (!response.ok) return;
            const users = await response.json();
            const me = users.find(u => normalize(u['ID de Usuario']) === normalize(loggedInUser.id));

            if (me) {
                if (me.Estado === 'KICK') { alert('Tu sesión ha sido cerrada por el administrador.'); await sendDisconnectSignal(); forceLogout(); return; }

                let changed = false;
                const appData = getAppData();
                const localUser = appData.userData[loggedInUser.id];
                
                const serverSaldo = Number(me.SaldoAnterior || 0);
                if (localUser.saldoAnterior !== serverSaldo) { localUser.saldoAnterior = serverSaldo; changed = true; }

                let serverAusencias = me.DiasAusencia || [];
                if (typeof serverAusencias === 'string') { try { serverAusencias = JSON.parse(serverAusencias); } catch(e){ serverAusencias = []; } }
                serverAusencias = (Array.isArray(serverAusencias) ? serverAusencias : []).map(normalizarFecha);

                const currentAusenciasStr = JSON.stringify(localUser.diasAusencia ? localUser.diasAusencia.map(normalizarFecha).sort() : []);
                const serverAusenciasStr = JSON.stringify(serverAusencias.sort());

                if (currentAusenciasStr !== serverAusenciasStr) { localUser.diasAusencia = serverAusencias; changed = true; }

                if (changed) {
                    saveUserData(localUser);
                    actualizarCalculoRetiro();
                    if (loggedInUser.tipo === 'Planta') { const calPlanta = document.getElementById('calendar-container-planta'); if (calPlanta && calendarPlantaModal.style.display !== 'none') { renderCalendar(calPlanta, true); } }
                    showToast('Datos actualizados por administración', 'info');
                }
            }
        } catch (e) { console.error("Error verificando sesión", e); }
    }

    function forceLogout() {
        if (notesInterval) clearInterval(notesInterval);
        if (sheetsInterval) clearInterval(sheetsInterval);
        if (statusCheckInterval) clearInterval(statusCheckInterval);
        if (heartbeatInterval) clearInterval(heartbeatInterval);
        localStorage.removeItem('loggedInUser'); 
        loggedInUser = null;
        location.reload();
    }

    document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'hidden') { sendDisconnectSignal(); } else { sendHeartbeat(); } });
    window.addEventListener('beforeunload', () => { sendDisconnectSignal(); });

    const setupMenu = () => {
        sideMenu.innerHTML = '<div style="font-size:1.5rem; font-weight:bold; margin-bottom:30px; padding:0 15px; color:var(--primary-color);">Bóveda</div>';
        [{id: 'retirosPropinaSection', title: 'Mi Billetera', icon: 'fas fa-wallet'}, {id: 'montosSection', title: 'Movimientos', icon: 'fas fa-exchange-alt'}, {id: 'datosUsuarioSection', title: 'Perfil', icon: 'fas fa-user-shield'}, {id: 'notasSection', title: 'Mensajes', icon: 'fas fa-envelope'}].forEach(sectionInfo => {
            const link = document.createElement('a'); link.href = '#'; link.innerHTML = `<i class="${sectionInfo.icon}" style="width:25px;"></i> ${sectionInfo.title}`; link.className = 'menu-link'; link.dataset.target = sectionInfo.id; sideMenu.appendChild(link);
        });
        sideMenu.addEventListener('click', (e) => { const link = e.target.closest('.menu-link'); if (link) { e.preventDefault(); activatePanel(link.dataset.target); } });
    };

    function activatePanel(panelId) {
        document.querySelectorAll('#main-content > section.content-panel').forEach(panel => panel.classList.remove('active'));
        const targetPanel = document.getElementById(panelId);
        if (targetPanel) {
            targetPanel.classList.add('active'); localStorage.setItem('activePanel', panelId);
            if (panelId === 'montosSection') cargarYMostrarMontos();
            if (panelId === 'notasSection') { 
                cargarNotas(); 
                markNotesAsRead(); 
            }
            if (panelId === 'datosUsuarioSection') populateUserDataSection();
            if (panelId === 'retirosPropinaSection') actualizarCalculoRetiro(); 
        }
        document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active-link'));
        const activeLink = document.querySelector(`.menu-link[data-target="${panelId}"]`);
        if(activeLink) activeLink.classList.add('active-link');
        if (window.innerWidth < 992) { sideMenu.classList.remove('open'); }
    }
    menuToggle.addEventListener('click', (e) => { e.stopPropagation(); sideMenu.classList.toggle('open'); });
    document.addEventListener('click', (e) => { if (window.innerWidth < 992) { const menu = document.getElementById('sideMenu'); const btn = document.getElementById('menuToggle'); if (menu.classList.contains('open') && !menu.contains(e.target) && !btn.contains(e.target)) { menu.classList.remove('open'); } } });

    const helpBtn = document.getElementById('help-btn'); const helpPanel = document.getElementById('help-panel'); const closeHelpBtn = document.getElementById('close-help-btn');
    helpBtn.addEventListener('click', () => { helpPanel.style.transform = 'translateX(0)'; });
    closeHelpBtn.addEventListener('click', () => helpPanel.style.transform = 'translateX(-100%)');

    function checkLogin() {
        const user = JSON.parse(localStorage.getItem('loggedInUser'));
        if (user && user.id) {
            loggedInUser = user; loginContainer.style.display = 'none'; mainContent.style.display = 'block'; menuToggle.style.display = 'flex';
            document.getElementById('userInfo').textContent = `${user.nombre} ${user.apellido}`;
            setupMenu(); initApp(); resetInactivityTimer();
            sendHeartbeat();
        } else { loginContainer.style.display = 'flex'; mainContent.style.display = 'none'; displayRecentLogins(); }
    }
    function updateRecentLogins(user) { let recent = JSON.parse(localStorage.getItem('recentLogins')) || []; recent = recent.filter(u => u.id !== user.id); recent.unshift(user); if (recent.length > 3) recent.pop(); localStorage.setItem('recentLogins', JSON.stringify(recent)); }
    function displayRecentLogins() {
        const recentLogins = JSON.parse(localStorage.getItem('recentLogins')) || []; const container = document.getElementById('quickAccessUsers'); const section = document.getElementById('quickAccessSection'); container.innerHTML = ''; 
        if (recentLogins.length > 0) {
            section.style.display = 'block'; 
            recentLogins.forEach(user => {
                const userDiv = document.createElement('div'); userDiv.style.cursor = 'pointer'; userDiv.style.textAlign = 'center';
                userDiv.innerHTML = `<div style="width:50px; height:50px; background:var(--bg-input); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 5px; color:var(--text-primary); border:1px solid var(--primary-color); position:relative;">${user.nombre.charAt(0).toUpperCase()}<span class="delete-user-btn" data-user-id="${user.id}" style="position:absolute; top:-5px; right:-5px; background:var(--danger-color); color:white; width:18px; height:18px; font-size:10px; border-radius:50%; display:flex; align-items:center; justify-content:center;">&times;</span></div><span style="font-size:0.75rem;">${user.nombre}</span>`;
                userDiv.addEventListener('click', (e) => {
                    if(e.target.classList.contains('delete-user-btn')) { e.stopPropagation(); if(confirm('¿Eliminar del acceso rápido?')) { let current = JSON.parse(localStorage.getItem('recentLogins')) || []; current = current.filter(u => u.id !== user.id); localStorage.setItem('recentLogins', JSON.stringify(current)); displayRecentLogins(); } return; }
                    document.getElementById('loginNombre').value = user.nombre || ''; document.getElementById('loginApellido').value = user.apellido || ''; document.getElementById('loginTipoContrato').value = user.tipo || ''; document.getElementById('loginSeccion').value = user.seccion || ''; document.getElementById('loginDia').value = user.dia || ''; document.getElementById('loginMes').value = user.mes || ''; document.getElementById('loginAnio').value = user.anio || ''; document.getElementById('loginPuntos').value = user.puntos || ''; const pw = document.getElementById('loginPassword'); if(pw) { pw.value = ''; pw.focus(); }
                }); container.appendChild(userDiv);
            });
        } else { section.style.display = 'none'; }
    }

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const rawNombre = document.getElementById('loginNombre').value.trim(); const rawApellido = document.getElementById('loginApellido').value.trim(); const generatedId = `${rawNombre.toLowerCase()}-${rawApellido.toLowerCase()}`;
        const appData = getAppData(); const localUser = appData.usuarios[generatedId];
        
        if (localUser && localUser.password) { if (localUser.password !== document.getElementById('loginPassword').value) { showToast('Contraseña incorrecta', 'error'); return; } }

        const user = { id: generatedId, nombre: rawNombre, apellido: rawApellido, tipo: document.getElementById('loginTipoContrato').value, seccion: document.getElementById('loginSeccion').value, dia: document.getElementById('loginDia').value, mes: document.getElementById('loginMes').value, anio: document.getElementById('loginAnio').value, puntos: parseFloat(document.getElementById('loginPuntos').value), password: document.getElementById('loginPassword').value, telefono: (localUser && localUser.telefono) ? localUser.telefono : '' };
        
        showLoadingOverlay(); 
        const res = await enviarDatosLoginASheets(user); 
        
        if (res.status === 'success') {
            try {
                const responseData = await fetch(SCRIPT_URL_LOGIN + '?action=read&v=' + Date.now());
                const usersData = await responseData.json();
                const me = usersData.find(u => normalize(u['ID de Usuario']) === normalize(user.id));
                const appData = getAppData();
                if (!appData.userData[user.id]) { appData.userData[user.id] = { montosPorFecha: {}, anticipos: [], divisor: 0, dTrabajados: [], diasAusencia: [], divisorPartTime: 1, saldoAnterior: 0 }; }
                if (me) {
                    appData.userData[user.id].saldoAnterior = Number(me.SaldoAnterior) || 0;
                    let serverAusencias = me.DiasAusencia || [];
                    if (typeof serverAusencias === 'string') { try { serverAusencias = JSON.parse(serverAusencias); } catch(e) { serverAusencias = []; } }
                    appData.userData[user.id].diasAusencia = (Array.isArray(serverAusencias) ? serverAusencias : []).map(normalizarFecha);
                }
                saveAppData(appData);
            } catch(e) { console.error("Error syncing on login", e); }

            await fetch(SCRIPT_URL_LOGIN, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: 'updateStatus', id: user.id, status: 'Activo' }) });

            if(!user.telefono && appData.usuarios[user.id] && appData.usuarios[user.id].telefono) user.telefono = appData.usuarios[user.id].telefono;
            if(!user.telefono) { pendingLoginUser = user; hideLoadingOverlay(); document.getElementById('phoneModal').style.display = 'flex'; return; }
            
            appData.usuarios[user.id] = user; saveAppData(appData); updateRecentLogins(user); localStorage.setItem('loggedInUser', JSON.stringify(user)); 
            location.reload();
        } else { hideLoadingOverlay(); showToast(res.message, 'error'); }
    });

    document.getElementById('savePhoneBtn').addEventListener('click', async () => {
        const phoneVal = document.getElementById('phoneInput').value.trim(); if(!phoneVal) { showToast('Por favor, ingresa tu número.', 'error'); return; }
        if(pendingLoginUser) { const btn = document.getElementById('savePhoneBtn'); btn.textContent = 'Guardando...'; btn.disabled = true; pendingLoginUser.telefono = phoneVal; const appData = getAppData(); appData.usuarios[pendingLoginUser.id] = pendingLoginUser; saveAppData(appData); await enviarDatosLoginASheets(pendingLoginUser); localStorage.setItem('loggedInUser', JSON.stringify(pendingLoginUser)); updateRecentLogins(pendingLoginUser); location.reload(); }
    });

    const statsModal = document.getElementById('statsModal');
    document.getElementById('openStatsModalBtn').addEventListener('click', () => { updateStatisticsUI('daily'); document.getElementById('dailyViewBtn').classList.add('active'); document.getElementById('weeklyViewBtn').classList.remove('active'); statsModal.style.display = 'flex'; });
    document.getElementById('closeStatsModalBtn').addEventListener('click', () => statsModal.style.display = 'none');
    document.getElementById('dailyViewBtn').addEventListener('click', () => { document.getElementById('dailyViewBtn').classList.add('active'); document.getElementById('weeklyViewBtn').classList.remove('active'); updateStatisticsUI('daily'); });
    document.getElementById('weeklyViewBtn').addEventListener('click', () => { document.getElementById('weeklyViewBtn').classList.add('active'); document.getElementById('dailyViewBtn').classList.remove('active'); updateStatisticsUI('weekly'); });

    function updateStatisticsUI(view = 'daily') {
        const today = new Date(); const day = today.getDate(); let startDate, endDate;
        if (day >= 15) { startDate = new Date(today.getFullYear(), today.getMonth(), 15); endDate = new Date(today.getFullYear(), today.getMonth() + 1, 14); } else { startDate = new Date(today.getFullYear(), today.getMonth() - 1, 15); endDate = new Date(today.getFullYear(), today.getMonth(), 14); }
        const userData = getUserData(); if (!userData) return;
        const montosPorFecha = userData.montosPorFecha || {}; const startDateStr = startDate.toISOString().split('T')[0]; const endDateStr = endDate.toISOString().split('T')[0];
        const fechasDelCiclo = Object.keys(montosPorFecha).filter(f => f >= startDateStr && f <= endDateStr).sort();
        const diasAusentes = new Set((userData.diasAusencia || []).map(d => normalizarFecha(d)));

        let vppAcumulado = 0, poolAcumulado = 0, dailyVppData = [];
        fechasDelCiclo.forEach(fecha => {
            const poolDia = montosPorFecha[fecha].reduce((sum, m) => sum + m.monto, 0); 
            const divisorDia = divisoresDiariosExternos[fecha] || 0;
            const fechaNorm = normalizarFecha(fecha);
            const isAbsent = diasAusentes.has(fechaNorm) && poolDia === 0;
            const vppDia = (!isAbsent && divisorDia > 0) ? (poolDia / divisorDia) : 0; 
            vppAcumulado += vppDia; 
            poolAcumulado += poolDia; 
            dailyVppData.push({ fecha, vpp: vppDia, pool: poolDia });
        });
        
        const diasTranscurridos = dailyVppData.length; const promedioVppDiario = diasTranscurridos > 0 ? vppAcumulado / diasTranscurridos : 0; const vppProyectado = promedioVppDiario * 30; const gananciaProyectada = vppProyectado * loggedInUser.puntos;
        const statContainer = document.getElementById('statCardsContainer'); if (statContainer) { statContainer.innerHTML = `<div class="stat-card" style="background:var(--bg-input); padding:10px; border-radius:10px; text-align:center;"><span style="display:block; font-size:0.8rem;">VPP Acumulado</span><span style="font-weight:bold; color:var(--primary-color); font-size:1.1rem;">$${formatNumberWithPoints(vppAcumulado)}</span></div><div class="stat-card" style="background:var(--bg-input); padding:10px; border-radius:10px; text-align:center;"><span style="display:block; font-size:0.8rem;">Pool Acumulado</span><span style="font-weight:bold; font-size:1.1rem;">$${formatNumberWithPoints(poolAcumulado)}</span></div><div class="stat-card" style="background:var(--bg-input); padding:10px; border-radius:10px; text-align:center;"><span style="display:block; font-size:0.8rem;">VPP Proyectado</span><span style="font-weight:bold; color:var(--success-color); font-size:1.1rem;">$${formatNumberWithPoints(vppProyectado)}</span></div><div class="stat-card" style="background:var(--bg-input); padding:10px; border-radius:10px; text-align:center;"><span style="display:block; font-size:0.8rem;">Ganancia Est.</span><span style="font-weight:bold; color:var(--success-color); font-size:1.1rem;">$${formatNumberWithPoints(gananciaProyectada)}</span></div>`; }
        if (view === 'weekly') { const weeklyData = []; let currentWeekVpp = 0, count = 0, weekIndex = 1; dailyVppData.forEach((d, index) => { currentWeekVpp += d.vpp; count++; if (count === 7 || index === dailyVppData.length - 1) { weeklyData.push({ fecha: `Semana ${weekIndex}`, vpp: currentWeekVpp / count }); currentWeekVpp = 0; count = 0; weekIndex++; } }); renderTipChart(weeklyData, 'weekly'); } else { renderTipChart(dailyVppData, 'daily'); }
    }
    function renderTipChart(data, viewMode) {
        const canvas = document.getElementById('tipChart'); if (!canvas) return; const ctx = canvas.getContext('2d');
        let labels, values; if(viewMode === 'weekly') { labels = data.map(d => d.fecha); values = data.map(d => d.vpp); } else { labels = data.map(d => formatDate(d.fecha).substring(0, 5)); values = data.map(d => d.vpp); }
        if (tipChart) tipChart.destroy(); tipChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: viewMode === 'weekly' ? 'Promedio VPP Semanal' : 'VPP Diario', data: values, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, scales:{x:{grid:{display:false}}, y:{grid:{color: 'rgba(0,0,0,0.05)'}}} } });
    }

    async function importarDesdeSheets(isSilent = false) { if (!loggedInUser) return; try { const response = await fetch(`${SCRIPT_URL_RECAUDACION}?action=get`); const result = await response.json(); if (result.status === 'success') { const userData = getUserData(); userData.montosPorFecha = {}; result.data.forEach(dato => { if (!userData.montosPorFecha[dato.fecha]) userData.montosPorFecha[dato.fecha] = []; userData.montosPorFecha[dato.fecha].push({ area: dato.tipo, monto: parseFloat(dato.monto) }); }); saveUserData(userData); } } catch (e) { console.error(e); } }
    async function obtenerDivisoresExternos(isSilent = true) { try { const res = await fetch(`${SCRIPT_URL_RECAUDACION_EXTERNA}?action=getDivisores`); const result = await res.json(); if (result.status === 'success') { divisoresDiariosExternos = result.data; localStorage.setItem('cachedDivisores', JSON.stringify(divisoresDiariosExternos)); } } catch (e) { console.error(e); } }
    async function obtenerYActualizarValorPorPuntoExterno() { if (!loggedInUser || loggedInUser.tipo !== 'Planta') return; try { await fetch(`${SCRIPT_URL_RECAUDACION_EXTERNA}?action=get&v=${Date.now()}`); } catch (e) { console.error(e); } }
    function mostrarActualizandoEnCampos() { ['valorPorPuntoDisplayPlanta', 'divisorDisplayPlanta', 'valorPorPuntoDisplayPT', 'divisorDisplayPT'].forEach(id => { const el = document.getElementById(id); if(el) el.textContent = '...'; }); }

    function cargarYMostrarMontos() {
        const userData = getUserData(); const container = document.getElementById('tarjetasMontos'); container.innerHTML = ''; let totalGeneral = 0; 
        const fechas = Object.keys(userData.montosPorFecha).sort((a,b) => b.localeCompare(a));
        fechas.forEach(fecha => {
            const totalDia = userData.montosPorFecha[fecha].reduce((s, m) => s + m.monto, 0); totalGeneral += totalDia;
            const tarjeta = document.createElement('div'); tarjeta.className = 'transaction-item';
            tarjeta.innerHTML = `<div style="display:flex;align-items:center;"><div class="t-icon"><i class="fas fa-calendar-day"></i></div><div class="t-info"><span class="t-title">${formatDate(fecha)}</span><span class="t-date">${userData.montosPorFecha[fecha].length} registros</span></div></div><div style="text-align:right;"><span class="t-amount">$${formatNumberWithPoints(totalDia)}</span></div>`;
            tarjeta.onclick = ()=>{ let det = ''; userData.montosPorFecha[fecha].forEach(m => det+=`\n${m.area}: $${formatNumberWithPoints(m.monto)}`); alert(det); };
            container.appendChild(tarjeta);
        }); document.getElementById('totalDiario').textContent = `Total Recaudado: $${formatNumberWithPoints(totalGeneral)}`; actualizarCalculoRetiro();
    }

    function actualizarCalculoRetiro() { if (!loggedInUser) return; loggedInUser.tipo === 'Planta' ? actualizarCalculoPlanta() : actualizarCalculoPartTime(); }

    function actualizarCalculoPlanta() {
        const userData = getUserData(); const puntosUsuario = loggedInUser.puntos || 0; const diasAusentesManuales = new Set((userData.diasAusencia || []).map(d => normalizarFecha(d)));
        let gananciaAcumuladaConPlata = 0; let totalRecaudadoPeriodo = 0; let totalGanadoTeorico = 0; let contadorDiasFaltados = 0;
        const fechasHistorial = Object.keys(userData.montosPorFecha).sort();
        fechasHistorial.forEach(fecha => {
            const poolDia = userData.montosPorFecha[fecha].reduce((sum, item) => sum + item.monto, 0); totalRecaudadoPeriodo += poolDia;
            const divisorDia = divisoresDiariosExternos[fecha] || 0;
            if (divisorDia > 0) { const valorPuntoDia = poolDia / divisorDia; const gananciaDia = valorPuntoDia * puntosUsuario; totalGanadoTeorico += gananciaDia; gananciaAcumuladaConPlata += gananciaDia; }
        });
        const promedioPorDia = fechasHistorial.length > 0 ? totalGanadoTeorico / fechasHistorial.length : 0;
        const fechasConPlataSet = new Set(fechasHistorial.map(f => normalizarFecha(f)));
        diasAusentesManuales.forEach(fechaAus => { if (!fechasConPlataSet.has(fechaAus)) { contadorDiasFaltados++; } });
        const montoDescontado = contadorDiasFaltados * promedioPorDia; const anticipos = (userData.anticipos || []).reduce((s, a) => s + a.monto, 0); const saldoAnterior = userData.saldoAnterior || 0;
        const finalAmount = totalGanadoTeorico - montoDescontado - anticipos + saldoAnterior;
        document.getElementById('puntosUsuarioDisplayPlanta').textContent = puntosUsuario; document.getElementById('totalMontoDividirPlanta').textContent = `$${formatNumberWithPoints(totalRecaudadoPeriodo)}`;
        const valorPuntoPromedio = totalGanadoTeorico / (puntosUsuario || 1); document.getElementById('valorPorPuntoDisplayPlanta').textContent = `$${formatNumberWithPoints(valorPuntoPromedio)}`; 
        document.getElementById('diasDescontadosPlanta').textContent = contadorDiasFaltados; document.getElementById('montoDescontadoPlanta').textContent = `-$${formatNumberWithPoints(montoDescontado)}`; 
        document.getElementById('subtotalDisplayPlanta').textContent = `$${formatNumberWithPoints(totalGanadoTeorico)}`; document.getElementById('anticiposDisplayPlanta').textContent = `-$${formatNumberWithPoints(anticipos)}`; 
        document.getElementById('saldoAnteriorDisplayPlanta').textContent = `+$${formatNumberWithPoints(saldoAnterior)}`;
        const resultadoEl = document.getElementById('resultadoFinalPlanta'); resultadoEl.textContent = `$${formatNumberWithPoints(finalAmount)}`; 
        if(finalAmount < 0) resultadoEl.classList.add('negative-value'); else resultadoEl.classList.remove('negative-value');
        renderAnticiposList('#anticipos-list-container-planta');
    }

    function actualizarCalculoPartTime() {
        const userData = getUserData(); const pts = loggedInUser.puntos || 0; const today = new Date();
        let startCycle, endCycle; if (today.getDate() >= 15) { startCycle = new Date(today.getFullYear(), today.getMonth(), 15); endCycle = new Date(today.getFullYear(), today.getMonth() + 1, 14); } else { startCycle = new Date(today.getFullYear(), today.getMonth() - 1, 15); endCycle = new Date(today.getFullYear(), today.getMonth(), 14); }
        const startStr = startCycle.toISOString().split('T')[0]; const endStr = endCycle.toISOString().split('T')[0];
        const diasTrabajados = (userData.diasTrabajados || []).filter(d => d >= startStr && d <= endStr);
        let pozoIndividual = 0; let sumaValorPunto = 0;
        diasTrabajados.forEach(fecha => {
            const poolDia = (userData.montosPorFecha[fecha] || []).reduce((s, m) => s + m.monto, 0); const divisorDia = divisoresDiariosExternos[fecha] || 0;
            if (divisorDia > 0) { pozoIndividual += poolDia; sumaValorPunto += (poolDia / divisorDia); }
        });
        const subtotal = sumaValorPunto * pts; const anticipos = (userData.anticipos || []).reduce((s, a) => s + a.monto, 0); const saldoAnterior = userData.saldoAnterior || 0;
        const finalAmount = subtotal - anticipos + saldoAnterior;
        document.getElementById('puntosUsuarioDisplayPT').textContent = pts; document.getElementById('pozoIndividualDisplayPT').textContent = `$${formatNumberWithPoints(pozoIndividual)}`;
        document.getElementById('valorPorPuntoDisplayPT').textContent = `$${formatNumberWithPoints(sumaValorPunto)}`; document.getElementById('subtotalDisplayPT').textContent = `$${formatNumberWithPoints(subtotal)}`;
        document.getElementById('anticiposDisplayPT').textContent = `-$${formatNumberWithPoints(anticipos)}`; document.getElementById('saldoAnteriorDisplayPT').textContent = `+$${formatNumberWithPoints(saldoAnterior)}`;
        const resEl = document.getElementById('resultadoFinalPT'); resEl.textContent = `$${formatNumberWithPoints(finalAmount)}`;
        if(finalAmount < 0) resEl.classList.add('negative-value'); else resEl.classList.remove('negative-value');
        renderAnticiposList('#anticipos-list-container-pt');
    }

    function renderAnticiposList(selector) {
        const container = document.querySelector(selector); if (!container) return; container.innerHTML = ''; const anticipos = getUserData().anticipos || [];
        if (!anticipos.length) container.innerHTML = '<div style="text-align:center; padding:15px; color:var(--text-secondary); font-size:0.9rem;">Sin movimientos recientes</div>';
        else anticipos.forEach(a => { container.innerHTML += `<div class="transaction-item"><div style="display:flex;align-items:center;"><div class="t-icon" style="background:var(--warning-color); color:white;"><i class="fas fa-money-bill-wave"></i></div><div class="t-info"><span class="t-title">Anticipo</span><span class="t-date">${formatDate(a.fecha)}</span></div></div><div style="text-align:right;"><span class="t-amount" style="color:var(--text-primary);">-$${formatNumberWithPoints(a.monto)}</span><div style="margin-top:5px;"><button class="edit-anticipo-btn" data-id="${a.id}" data-monto="${a.monto}" data-fecha="${a.fecha}" style="padding:2px 5px; background:none; color:var(--primary-color); box-shadow:none;"><i class="fas fa-pencil-alt"></i></button><button class="delete-anticipo-btn" data-id="${a.id}" style="padding:2px 5px; background:none; color:var(--danger-color); box-shadow:none;"><i class="fas fa-trash"></i></button></div></div></div>`; });
        container.querySelectorAll('.delete-anticipo-btn').forEach(btn => { btn.addEventListener('click', (e) => { if(confirm('¿Eliminar anticipo?')) { const id = e.target.closest('button').dataset.id; const ud = getUserData(); ud.anticipos = ud.anticipos.filter(a => a.id != id); saveUserData(ud); actualizarCalculoRetiro(); } }); });
        container.querySelectorAll('.edit-anticipo-btn').forEach(btn => { btn.addEventListener('click', (e) => { const btnEl = e.target.closest('button'); currentEditAnticipoId = btnEl.dataset.id; document.getElementById('editAnticipoMontoInput').value = formatNumberWithPoints(btnEl.dataset.monto); document.getElementById('editAnticipoFechaInput').value = btnEl.dataset.fecha; document.getElementById('editAnticipoModal').style.display = 'flex'; }); });
    }

    // --- SISTEMA DE NOTAS Y NOTIFICACIONES (FIXED & FULL) ---
    async function fetchFromNotasScript(params) { const url = new URL(SCRIPT_URL_NOTAS); Object.keys(params).forEach(key => url.searchParams.append(key, params[key])); try { const response = await fetch(url); return await response.json(); } catch (error) { console.error('Error notas', error); return { status: 'error' }; } }
    async function postToNotasScript(params, data) { const url = new URL(SCRIPT_URL_NOTAS); Object.keys(params).forEach(key => url.searchParams.append(key, params[key])); try { await fetch(url, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'text/plain;charset=utf-8'}, body: JSON.stringify(data) }); return { status: 'success' }; } catch (error) { return { status: 'error' }; } }
    
    function checkForUnread(notes) { 
        if (!loggedInUser || notes.length === 0) return; 

        const notificationFab = document.getElementById('notification-fab'); 
        const countEl = document.getElementById('note-notification-count'); 
        
        // Si el panel de notas está activo, no mostramos la notificación y marcamos como leído.
        if (localStorage.getItem('activePanel') === 'notasSection') {
            markNotesAsRead();
            return;
        }

        const lastRead = parseInt(localStorage.getItem(`lastReadTimestamp_${loggedInUser.id}`), 10) || 0; 
        
        // Buscamos cualquier mensaje nuevo de CUALQUIER autor que no seas tú mismo
        const unreadNotes = notes.filter(n => {
            const isMe = n.autor.includes(loggedInUser.nombre);
            const noteTimestamp = new Date(n.fecha).getTime();
            return !isMe && (noteTimestamp > lastRead);
        });

        if (unreadNotes.length > 0) { 
            countEl.textContent = unreadNotes.length; 
            notificationFab.style.display = 'flex'; 
            countEl.style.display = 'flex'; 
            notificationFab.classList.add('pulse-notification');
            
            const latestNote = unreadNotes[unreadNotes.length - 1];
            const latestNoteId = new Date(latestNote.fecha).getTime();
            
            if (latestNoteId > lastKnownNoteId) {
                lastKnownNoteId = latestNoteId;
                localStorage.setItem('lastKnownNoteId', lastKnownNoteId.toString());
                showToast("Nuevo mensaje recibido", "info");
            }
        } else { 
            notificationFab.style.display = 'none'; 
            countEl.style.display = 'none'; 
            notificationFab.classList.remove('pulse-notification');
        } 
    }
    
    async function cargarNotas() { 
        if(!loggedInUser) return; 
        const container = document.getElementById('admin-notes-container'); 
        const isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 100;
        
        const response = await fetchFromNotasScript({ action: 'getNotes' }); 
        if (response.status === 'success' && response.data) { 
            allFetchedNotes = response.data; 
            allFetchedNotes.sort((a, b) => new Date(a.fecha) - new Date(b.fecha)); 
            container.innerHTML = ''; 
            allFetchedNotes.forEach(note => { 
                const isMe = note.autor.includes(loggedInUser.nombre);
                const card = document.createElement('div'); 
                card.className = `note-card ${isMe ? 'user-note' : ''}`; 
                card.innerHTML = `<div style="font-size:0.75em; color:${isMe ? 'rgba(255,255,255,0.8)' : 'var(--text-muted)'}; margin-bottom:5px;"><strong>${note.autor}</strong> - ${formatNoteDate(note.fecha)}</div><div class="note-body">${note.mensaje}</div>`; 
                container.appendChild(card); 
            }); 
            
            if (isNearBottom || container.innerHTML === '' || localStorage.getItem('activePanel') === 'notasSection') {
                container.scrollTop = container.scrollHeight; 
            }
            
            checkForUnread(allFetchedNotes); 
        } 
    }
    
    function markNotesAsRead() { 
        if(loggedInUser) { 
            // Sincronizamos el tiempo de lectura con el momento actual del servidor de datos
            const latestMessageTS = allFetchedNotes.length > 0 
                ? Math.max(...allFetchedNotes.map(n => new Date(n.fecha).getTime())) 
                : Date.now();

            localStorage.setItem(`lastReadTimestamp_${loggedInUser.id}`, latestMessageTS.toString()); 
            document.getElementById('notification-fab').style.display = 'none'; 
            document.getElementById('note-notification-count').style.display = 'none';
        } 
    }
    
    document.getElementById('sendResponseBtn').addEventListener('click', async () => { 
        const input = document.getElementById('responseMessage'); const msg = input.value.trim(); if (!msg) return; 
        const btn = document.getElementById('sendResponseBtn'); btn.disabled = true; 
        await postToNotasScript({ action: 'addNote' }, { autor: `${loggedInUser.nombre} ${loggedInUser.apellido}`, mensaje: msg }); 
        input.value = ''; btn.disabled = false; cargarNotas();
    });

    // --- CALENDARIOS Y MODALES ---
    const calendarPlantaModal = document.getElementById('calendarPlantaModal'); const openCalendarPlantaBtn = document.getElementById('openCalendarPlantaBtn'); const closeCalendarPlantaBtn = document.getElementById('closeCalendarPlantaBtn');
    if (openCalendarPlantaBtn) openCalendarPlantaBtn.addEventListener('click', () => { const calPlanta = document.getElementById('calendar-container-planta'); if (calPlanta) renderCalendar(calPlanta, true); calendarPlantaModal.style.display = 'flex'; });
    if (closeCalendarPlantaBtn) closeCalendarPlantaBtn.addEventListener('click', () => calendarPlantaModal.style.display = 'none');

    const calendarPTModal = document.getElementById('calendarPTModal'); const openCalendarPTBtn = document.getElementById('openCalendarPTBtn'); const closeCalendarPTBtn = document.getElementById('closeCalendarPTBtn');
    if (openCalendarPTBtn) openCalendarPTBtn.addEventListener('click', () => { const calPT = document.getElementById('calendar-container'); if (calPT) renderCalendar(calPT, false); calendarPTModal.style.display = 'flex'; });
    if (closeCalendarPTBtn) closeCalendarPTBtn.addEventListener('click', () => calendarPTModal.style.display = 'none');

    const saldoAnteriorModal = document.getElementById('saldoAnteriorModal'); const btnEditSaldoPlanta = document.getElementById('btnEditSaldoPlanta'); const btnEditSaldoPT = document.getElementById('btnEditSaldoPT'); const saldoAnteriorInput = document.getElementById('saldoAnteriorInput');
    function openSaldoModal() { const userData = getUserData(); saldoAnteriorInput.value = userData.saldoAnterior || ''; saldoAnteriorModal.style.display = 'flex'; saldoAnteriorInput.focus(); }
    if (btnEditSaldoPlanta) btnEditSaldoPlanta.addEventListener('click', openSaldoModal); if (btnEditSaldoPT) btnEditSaldoPT.addEventListener('click', openSaldoModal);
    document.getElementById('cancelSaldoBtn').addEventListener('click', () => saldoAnteriorModal.style.display = 'none');
    document.getElementById('saveSaldoBtn').addEventListener('click', async () => { const monto = parseFloat(saldoAnteriorInput.value); if (isNaN(monto)) return; const userData = getUserData(); userData.saldoAnterior = monto; saveUserData(userData); saldoAnteriorModal.style.display = 'none'; actualizarCalculoRetiro(); showToast('Saldo actualizado'); if(loggedInUser) { const payload = { ...loggedInUser, saldoAnterior: monto, diasAusencia: userData.diasAusencia }; await enviarDatosLoginASheets(payload); } });

    function renderCalendar(container, isPlanta = false, year = currentViewYear, month = currentViewMonth) {
        currentViewYear = year; currentViewMonth = month;
        const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0); const daysInMonth = lastDay.getDate(); const startingDay = (firstDay.getDay() + 6) % 7; 
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        let html = `<div class="calendar-nav"><button class="nav-btn" id="prevMonthBtn"><i class="fas fa-chevron-left"></i></button><div style="font-weight:bold; color:var(--primary-color);">${monthNames[month]} ${year}</div><button class="nav-btn" id="nextMonthBtn"><i class="fas fa-chevron-right"></i></button></div><div class="calendar-grid">`;
        ["L", "M", "M", "J", "V", "S", "D"].forEach(d => html += `<div class="day-name">${d}</div>`); 
        for (let i = 0; i < startingDay; i++) html += `<div class="day empty" style="background:transparent; cursor:default;"></div>`;
        const userData = getUserData();
        let markedDays = isPlanta ? new Set((userData.diasAusencia || []).map(normalizarFecha)) : new Set((userData.diasTrabajados || []).map(normalizarFecha));
        for (let i = 1; i <= daysInMonth; i++) { 
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`; 
            const isMarked = markedDays.has(dateStr);
            let classModifier = isMarked ? (isPlanta ? 'absent' : 'marked') : '';
            html += `<div class="day ${classModifier}" data-date="${dateStr}">${i}</div>`; 
        }
        html += `</div>`; container.innerHTML = html;
        container.querySelector('#prevMonthBtn').onclick = (e) => { e.stopPropagation(); let nm = currentViewMonth - 1; let ny = currentViewYear; if(nm < 0) { nm = 11; ny--; } renderCalendar(container, isPlanta, ny, nm); };
        container.querySelector('#nextMonthBtn').onclick = (e) => { e.stopPropagation(); let nm = currentViewMonth + 1; let ny = currentViewYear; if(nm > 11) { nm = 0; ny++; } renderCalendar(container, isPlanta, ny, nm); };
        container.querySelectorAll('.day:not(.empty)').forEach(dayEl => { 
            dayEl.addEventListener('click', async () => { 
                const date = dayEl.dataset.date; const ud = getUserData(); 
                if (isPlanta) { 
                    let absDays = new Set((ud.diasAusencia || []).map(normalizarFecha)); 
                    if (absDays.has(date)) { absDays.delete(date); } else { absDays.add(date); }
                    ud.diasAusencia = Array.from(absDays); saveUserData(ud); renderCalendar(container, isPlanta, currentViewYear, currentViewMonth); actualizarCalculoRetiro();
                    if(loggedInUser) { const payload = { ...loggedInUser, diasAusencia: ud.diasAusencia, saldoAnterior: ud.saldoAnterior }; enviarDatosLoginASheets(payload); }
                } else { 
                    let wDays = new Set((ud.diasTrabajados || []).map(normalizarFecha)); if (wDays.has(date)) wDays.delete(date); else wDays.add(date); ud.diasTrabajados = Array.from(wDays); saveUserData(ud); renderCalendar(container, isPlanta, currentViewYear, currentViewMonth); actualizarCalculoRetiro(); 
                } 
            }); 
        });
    }

    const addAnticipoModal = document.getElementById('addAnticipoModal');
    document.getElementById('registrarAnticipoBtn').addEventListener('click', () => { document.getElementById('addAnticipoMontoInput').value = ''; document.getElementById('addAnticipoMontoInput').dataset.cleanValue = ''; document.getElementById('addAnticipoFechaInput').value = getTodayDateString(); addAnticipoModal.style.display = 'flex'; document.getElementById('addAnticipoMontoInput').focus(); });
    
    const regAntPT = document.getElementById('registrarAnticipoBtnPT');
    if(regAntPT) {
        regAntPT.addEventListener('click', () => { 
            document.getElementById('addAnticipoMontoInput').value = ''; 
            document.getElementById('addAnticipoMontoInput').dataset.cleanValue = '';
            document.getElementById('addAnticipoFechaInput').value = getTodayDateString(); 
            addAnticipoModal.style.display = 'flex'; 
            document.getElementById('addAnticipoMontoInput').focus(); 
        });
    }

    document.getElementById('cancelAddAnticipoBtn').addEventListener('click', () => addAnticipoModal.style.display = 'none');
    document.getElementById('saveAddAnticipoBtn').addEventListener('click', () => { const montoRaw = document.getElementById('addAnticipoMontoInput').dataset.cleanValue || document.getElementById('addAnticipoMontoInput').value; const monto = parseInt(montoRaw); const fecha = document.getElementById('addAnticipoFechaInput').value; if (!monto || !fecha) { showToast('Datos incompletos', 'error'); return; } const userData = getUserData(); userData.anticipos.push({ id: Date.now(), monto, fecha }); saveUserData(userData); actualizarCalculoRetiro(); addAnticipoModal.style.display = 'none'; showToast('Anticipo registrado'); });

    document.getElementById('cancelEditAnticipoBtn').addEventListener('click', () => document.getElementById('editAnticipoModal').style.display = 'none');
    document.getElementById('saveEditAnticipoBtn').addEventListener('click', () => { const montoRaw = document.getElementById('editAnticipoMontoInput').dataset.cleanValue || document.getElementById('editAnticipoMontoInput').value; const monto = parseInt(montoRaw); const fecha = document.getElementById('editAnticipoFechaInput').value; const userData = getUserData(); const idx = userData.anticipos.findIndex(a => a.id == currentEditAnticipoId); if (idx !== -1) { userData.anticipos[idx].monto = monto; userData.anticipos[idx].fecha = fecha; saveUserData(userData); actualizarCalculoRetiro(); document.getElementById('editAnticipoModal').style.display = 'none'; showToast('Actualizado'); } });

    const editPuntosModal = document.getElementById('editPuntosModal');
    document.getElementById('editPuntosBtn').addEventListener('click', () => { document.getElementById('editPuntosInput').value = loggedInUser.puntos; editPuntosModal.style.display = 'flex'; });
    document.getElementById('cancelEditPuntosBtn').addEventListener('click', () => editPuntosModal.style.display = 'none');
    document.getElementById('saveEditPuntosBtn').addEventListener('click', async () => { const newPuntos = parseFloat(document.getElementById('editPuntosInput').value); if (newPuntos > 0) { loggedInUser.puntos = newPuntos; localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser)); const appData = getAppData(); if(appData.usuarios[loggedInUser.id]) { appData.usuarios[loggedInUser.id].puntos = newPuntos; saveAppData(appData); } populateUserDataSection(); actualizarCalculoRetiro(); editPuntosModal.style.display = 'none'; await enviarDatosLoginASheets(loggedInUser); } });

    document.getElementById('resetMesBtn').addEventListener('click', () => { if(confirm('¿Reiniciar periodo? Se borrarán anticipos, días y saldo.')) { const ud = getUserData(); ud.anticipos = []; ud.diasTrabajados = []; ud.diasAusencia = []; ud.saldoAnterior = 0; saveUserData(ud); if (loggedInUser.tipo === 'Planta') { const cal = document.getElementById('calendar-container-planta'); if(cal) renderCalendar(cal, true); } else { const cal = document.getElementById('calendar-container'); if(cal) renderCalendar(cal, false); } actualizarCalculoRetiro(); showToast('Mes reiniciado.'); } });

    document.getElementById('exportDataBtn').addEventListener('click', () => { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(getAppData())); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", "respaldo_boveda.json"); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); });
    document.getElementById('importDataBtn').addEventListener('click', () => { if(confirm('¿Restaurar respaldo? Se sobrescribirán los datos actuales.')) document.getElementById('importFileInput').click(); });
    document.getElementById('importFileInput').addEventListener('change', (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const importedData = JSON.parse(e.target.result); if (importedData && importedData.usuarios && importedData.userData) { saveAppData(importedData); showToast('Datos restaurados. Recargando...', 'success'); setTimeout(() => location.reload(), 1500); } else { showToast('Archivo inválido', 'error'); } } catch(ex) { showToast('Error al leer archivo', 'error'); } }; reader.readAsText(file); });

    function initApp() {
        divisoresDiariosExternos = JSON.parse(localStorage.getItem('cachedDivisores')) || {};
        const lastPanel = localStorage.getItem('activePanel') || 'retirosPropinaSection'; activatePanel(lastPanel);
        if (loggedInUser.tipo === 'Planta') { document.getElementById('vistaPlanta').style.display = 'block'; const calPlanta = document.getElementById('calendar-container-planta'); if (calPlanta) renderCalendar(calPlanta, true); } else { document.getElementById('vistaPartTime').style.display = 'block'; }
        const syncFinancials = async () => { mostrarActualizandoEnCampos(); try { await importarDesdeSheets(true); if(loggedInUser.tipo === 'Planta') await obtenerYActualizarValorPorPuntoExterno(); await obtenerDivisoresExternos(true); } catch(e) { console.error("Error sync", e); } finally { cargarYMostrarMontos(); actualizarCalculoRetiro(); } };
        
        syncFinancials();
        if (notesInterval) clearInterval(notesInterval); notesInterval = setInterval(cargarNotas, 10000);
        if (sheetsInterval) clearInterval(sheetsInterval); sheetsInterval = setInterval(syncFinancials, 300000);
        if (statusCheckInterval) clearInterval(statusCheckInterval); statusCheckInterval = setInterval(verificarEstadoSesion, 5000); 
        if (heartbeatInterval) clearInterval(heartbeatInterval); heartbeatInterval = setInterval(sendHeartbeat, 60000); 

        document.getElementById('logoutBtn').onclick = () => { if (localStorage.getItem('loggedInUser')) { showToast('Cerrando sesión...', 'info'); sendDisconnectSignal().then(() => forceLogout()); } };
        document.getElementById('importarDesdeSheetsBtn').onclick = async function() { const btn = this; const originalText = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true; try { await importarDesdeSheets(false); cargarYMostrarMontos(); actualizarCalculoRetiro(); showToast('Sincronizado'); } catch(e) { showToast('Error sync', 'error'); } finally { btn.innerHTML = originalText; btn.disabled = false; } };
    }

    function resetInactivityTimer() { if (localStorage.getItem('loggedInUser')) lastActivityTime = Date.now(); }
    function checkInactivity() { if (!localStorage.getItem('loggedInUser')) return; if (Date.now() - lastActivityTime > 660000) { sendDisconnectSignal(); forceLogout(); } }
    ['mousemove', 'mousedown', 'keypress', 'touchmove', 'scroll', 'click'].forEach(evt => document.addEventListener(evt, resetInactivityTimer, true));
    setInterval(checkInactivity, 10000);

    setupNumericInputFormatting(document.getElementById('addAnticipoMontoInput')); setupNumericInputFormatting(document.getElementById('editAnticipoMontoInput'));

    function populateUserDataSection() { if (!loggedInUser) return; document.getElementById('userDataNombre').textContent = `${loggedInUser.nombre} ${loggedInUser.apellido}`; document.getElementById('userDataContrato').textContent = loggedInUser.tipo; document.getElementById('puntosValueDisplay').textContent = loggedInUser.puntos; const fechaIngresoEl = document.getElementById('userDataFechaIngreso'); if (loggedInUser.dia && loggedInUser.mes) fechaIngresoEl.textContent = `${String(loggedInUser.dia).padStart(2, '0')}/${String(loggedInUser.mes).padStart(2, '0')}/${loggedInUser.anio}`; else fechaIngresoEl.textContent = loggedInUser.anio || 'N/A'; }

    const changePassModal = document.getElementById('changePasswordModal'); const changePassInput = document.getElementById('newPasswordLoggedInInput');
    document.getElementById('changePasswordBtn').addEventListener('click', () => { changePassInput.value = ''; changePassModal.style.display = 'flex'; changePassInput.focus(); });
    document.getElementById('cancelChangePasswordBtn').addEventListener('click', () => changePassModal.style.display = 'none');
    document.getElementById('saveNewPasswordLoggedInBtn').addEventListener('click', async () => { const newPass = changePassInput.value.trim(); if (!newPass || newPass.length < 4) { showToast('Contraseña muy corta.', 'error'); return; } const btn = document.getElementById('saveNewPasswordLoggedInBtn'); btn.textContent = 'Guardando...'; btn.disabled = true; try { loggedInUser.password = newPass; localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser)); const appData = getAppData(); if (appData.usuarios[loggedInUser.id]) { appData.usuarios[loggedInUser.id].password = newPass; saveAppData(appData); } await enviarDatosLoginASheets(loggedInUser); showToast('Contraseña actualizada.'); changePassModal.style.display = 'none'; updateRecentLogins(loggedInUser); displayRecentLogins(); } catch (error) { showToast('Error al guardar.', 'error'); } finally { btn.textContent = 'Actualizar'; btn.disabled = false; } });
    document.querySelectorAll('.password-toggle-icon').forEach(icon => { icon.addEventListener('click', () => { const input = icon.previousElementSibling; if (input.type === 'password') { input.type = 'text'; icon.classList.replace('fa-eye', 'fa-eye-slash'); } else { input.type = 'password'; icon.classList.replace('fa-eye-slash', 'fa-eye'); } }); });

    checkLogin();
});

// --- SERVICE WORKER REGISTRATION (NUEVO) ---
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('Service Worker registrado: ', reg))
            .catch(err => console.warn('Error registrando SW: ', err));
    });
}
// ------------------------------------------
</script>
</body>
</html>