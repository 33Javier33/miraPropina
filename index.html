<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro Personal de Montos</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007bff"/>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
        --menu-width: 250px;
        --primary-color: #007bff;
        --secondary-color: #4CAF50;
        --danger-color: #dc3545;
        --success-color: #28a745;
        --error-color: #dc3545;
        --info-color: #17a2b8;
        --edit-color: #ffc107;
        
        /* Light Theme */
        --bg-main: #f0f2f5;
        --bg-content: #ffffff;
        --bg-accent: #eef7ff;
        --text-primary: #222;
        --text-secondary: #555;
        --border-color: #ddd;
        --shadow-color: rgba(0,0,0,0.05);
        --user-chat-bg: var(--primary-color);
    }

    body.dark-mode {
        /* Dark Theme */
        --bg-main: #121212;
        --bg-content: #1e1e1e;
        --bg-accent: #2a2a3a;
        --text-primary: #e0e0e0;
        --text-secondary: #b0b0b0;
        --border-color: #444;
        --shadow-color: rgba(0,0,0,0.2);
        --user-chat-bg: #0056b3;
    }

    body {
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        background-color: var(--bg-main);
        margin: 0;
        color: var(--text-primary);
        transition: margin-left 0.3s ease, background-color 0.3s, color 0.3s;
    }
    
    /* --- MENÚ TOGGLE --- */
    .menu-toggle {
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 1002;
        width: 45px;
        height: 50px;
        background-color: var(--secondary-color);
        border: none;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        transition: left 0.3s ease;
        padding: 5px 0;
    }
    .menu-toggle span.bar { 
        display: block; 
        width: 22px; 
        height: 2px; 
        background-color: white; 
        margin: 2px 0; 
        transition: all 0.3s ease; 
    }
    .menu-toggle-label {
        color: white;
        font-size: 9px;
        font-weight: bold;
        margin-top: 3px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .side-menu.open + .main-container .menu-toggle { left: calc(var(--menu-width) + 15px); }
    
    .menu-toggle.active span.bar:nth-child(1) { transform: translateY(6px) rotate(45deg); }
    .menu-toggle.active span.bar:nth-child(2) { opacity: 0; }
    .menu-toggle.active span.bar:nth-child(3) { transform: translateY(-6px) rotate(-45deg); }
    .menu-toggle.active .menu-toggle-label { opacity: 0.5; }

    .side-menu {
        position: fixed; top: 0; left: 0; width: var(--menu-width); height: 100%;
        background-color: #2c3e50; z-index: 1001; transform: translateX(-100%);
        transition: transform 0.3s ease; display: flex; flex-direction: column;
        padding-top: 20px; box-shadow: 5px 0 15px rgba(0,0,0,0.1);
    }
    .side-menu.open { transform: translateX(0); }
    .side-menu .menu-header { color: white; font-size: 1.4em; font-weight: 700; text-align: center; padding: 20px 10px; border-bottom: 1px solid #4a627a; }
    .side-menu a { color: white; text-decoration: none; padding: 15px 20px; display: block; transition: background-color 0.2s ease, padding-left 0.2s ease; border-bottom: 1px solid #3e5268; }
    .side-menu a:hover, .side-menu a.active-link { background-color: var(--secondary-color); padding-left: 25px; }
    
    .main-container { transition: margin-left 0.3s ease; padding: 20px; }
    .content-panel { display: none; }
    .content-panel.active { display: block; animation: fadeIn 0.5s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    @media (min-width: 992px) {
        body { margin-left: var(--menu-width); }
        .menu-toggle { display: none; }
        .side-menu { transform: translateX(0); }
    }
    
    .app-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
        padding-left: 50px;
    }
     @media (min-width: 992px) {
        .app-header {
            padding-left: 0;
        }
    }
    .app-header h1 {
        margin: 0;
        font-size: 1.8em;
    }
    .user-info-cluster {
        text-align: right;
    }

    #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; }
    .toast { background-color: var(--success-color); color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 1em; opacity: 0; transform: translateX(100%); transition: all 0.4s ease; }
    .toast.show { opacity: 1; transform: translateX(0); }
    .toast.error { background-color: var(--error-color); }
    .toast.info { background-color: var(--info-color); }

    h1 { text-align: center; margin-bottom: 20px; font-size: 2em; }
    section { margin-bottom: 30px; background: var(--bg-content); padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px var(--shadow-color); }
    h2 { margin-top: 0; margin-bottom: 15px; font-size: 1.7em; border-bottom: 2px solid var(--bg-main); padding-bottom: 10px; }
    h3 { margin-top: 0; margin-bottom: 10px; font-size: 1.3em; color: var(--text-primary); }
    #totalDiario { font-weight: bold; font-size: 1.5em; margin: 15px 0; color: var(--primary-color); text-align: center; }
    form { display: flex; flex-wrap: wrap; gap: 10px; }
    input, select, button, textarea { padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1em; background-color: var(--bg-content); color: var(--text-primary); }
    input:focus, textarea:focus { border-color: var(--secondary-color); outline: none; }
    button { background-color: var(--secondary-color); color: #fff; border: none; font-weight: bold; cursor: pointer; flex-grow: 1; display: inline-flex; justify-content: center; align-items: center; gap: 8px; }
    button:hover { opacity: 0.9; }
    button:disabled { background-color: #aaa; cursor: not-allowed; }
    .reset-button { background-color: var(--danger-color); }
    .edit-button-modal { background-color: var(--edit-color); color: #212529;}
    #importarDesdeSheetsBtn { background-color: var(--info-color); }
    .logout-button { background-color: var(--danger-color); font-weight: normal; padding: 8px 12px; font-size: 0.9em; flex-grow: 0; }
    #tarjetasMontos { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
    .tarjeta { background-color: var(--bg-content); border-radius: 12px; box-shadow: 0 4px 12px var(--shadow-color); padding: 15px; border-left: 4px solid var(--primary-color); }
    .tarjeta h3 { margin: 0 0 8px 0; font-size: 1.1em; cursor: pointer; display: flex; justify-content: space-between; }
    .tarjeta h3 .total-in-header { font-weight: bold; color: var(--primary-color); }
    .tarjeta h3::after { content: '▼'; transition: transform 0.2s ease-in-out; }
    .tarjeta.collapsed h3::after { transform: rotate(-90deg); }
    .tarjeta.collapsed .montos-list { display: none; }
    .montos-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 8px; margin-top: 10px; }
    .monto-item { background-color: var(--bg-main); padding: 8px; border-radius: 6px; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; }
    .delete-button { background: none; border: none; font-size: 1.2em; color: var(--danger-color); cursor: pointer; }
    
    .retiro-container, .retiro-container-pt { background-color: var(--bg-accent); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
    .calculation-item { margin-bottom: 12px; font-size: 1.1em; display: flex; justify-content: space-between; align-items: center; }
    .calculation-item strong { color: var(--text-primary); }
    .final-calculation { border-top: 2px solid var(--border-color); padding-top: 15px; margin-top: 15px; }
    .total-result { font-size: 1.8em; font-weight: bold; color: var(--primary-color); }
    
    .negative-value { color: var(--danger-color) !important; }

    .retiro-actions { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
    .anticipos-list-container { margin-top: 10px; max-height: 160px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px; padding: 10px; background-color: var(--bg-content); }
    .anticipo-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; border-bottom: 1px solid var(--border-color); font-size: 0.95em; }
    .anticipo-item:last-child { border-bottom: none; }
    .anticipo-item .actions { display: flex; gap: 8px; }
    .anticipo-item-btn { background: none; border: none; cursor: pointer; font-size: 1.2em; padding: 0 5px; color: var(--text-secondary); }
    .delete-anticipo-btn { color: var(--danger-color); }
    .edit-anticipo-btn { color: var(--edit-color); }
    
    .part-time-layout { display: flex; flex-wrap: wrap; gap: 20px; }
    .calendar-section { flex: 1; min-width: 300px; }
    .calculation-section-pt { flex: 1; min-width: 300px; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: bold; }
    .calendar-header button { padding: 5px 10px; background-color: var(--bg-accent); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; flex: 0; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
    .day-name { font-weight: bold; color: var(--text-secondary); padding-bottom: 5px; }
    .day { padding: 8px; border-radius: 4px; background-color: var(--bg-content); cursor: pointer; border: 1px solid var(--border-color); }
    .day:hover { background-color: var(--bg-accent); }
    .day.marked { background-color: var(--success-color); color: #fff; font-weight: bold; }
    .day.empty { background-color: transparent; border: none; cursor: default; }

    .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background-color: var(--bg-content); padding: 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 400px; display: flex; flex-direction: column; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .modal-header h4 { margin: 0; font-size: 1.3em; }
    .modal-close-btn { background: none; border: none; font-size: 1.8em; cursor: pointer; padding: 0 5px; color: var(--text-secondary); }
    .modal-body { flex-grow: 1; overflow-y: auto; }
    .modal-body label { display: block; margin-bottom: 5px; font-weight: bold; }
    .modal-body input { width: 100%; box-sizing: border-box; margin-bottom: 10px; padding: 10px; }
    .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    
    #statsModal .modal-content {
        max-width: 90%;
        width: 800px;
        height: 80vh;
    }
    @media (max-width: 820px) {
      #statsModal .modal-content {
          width: 95%;
          max-width: 95%;
      }
    }
    
    .password-wrapper { position: relative; width: 100%; flex-grow: 1; }
    .password-wrapper input { width: 100%; box-sizing: border-box; padding-right: 40px; }
    .password-toggle-icon { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); cursor: pointer; color: var(--text-secondary); }

    .quick-access-container { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-top: 10px; }
    .quick-access-user { position: relative; display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; background-color: var(--bg-main); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); transition: all 0.2s ease; min-width: 80px; }
    .quick-access-user:hover { transform: translateY(-3px); box-shadow: 0 4px 8px var(--shadow-color); border-color: var(--primary-color); }
    .quick-access-avatar { width: 50px; height: 50px; border-radius: 50%; background-color: var(--secondary-color); color: white; display: flex; justify-content: center; align-items: center; font-size: 1.8em; font-weight: bold; }
    .quick-access-name { font-size: 0.9em; font-weight: 500; }
    .delete-user-btn { position: absolute; top: -5px; right: -5px; width: 24px; height: 24px; background-color: #ddd; color: #555; border: 2px solid var(--bg-content); border-radius: 50%; font-size: 14px; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; line-height: 1; opacity: 0.7; transition: all 0.2s ease; padding: 0; flex-grow: 0; }
    .delete-user-btn:hover { background-color: var(--danger-color); color: white; transform: scale(1.1); opacity: 1; }
    .forgot-password-link { text-align: center; display: block; margin-top: 15px; color: var(--primary-color); text-decoration: none; font-size: 0.9em; }
    .forgot-password-link:hover { text-decoration: underline; }
    #recoveryResult { padding: 10px; border-radius: 6px; display: none; margin-top: 15px; font-weight: bold; word-break: break-word; }
    #recoveryResult.success { background-color: #e8f5e9; color: #2e7d32; display: block; }
    #recoveryResult.error { background-color: #ffebee; color: #c62828; display: block; }

    footer { text-align: center; padding: 20px; margin-top: 30px; color: #777; font-size: 0.9em; border-top: 1px solid var(--border-color); }

    .user-data-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px 20px; }
    .data-item { background-color: var(--bg-main); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
    .data-item-label { font-weight: bold; color: var(--text-secondary); display: block; margin-bottom: 5px; font-size: 0.9em; }
    .data-item-value { font-size: 1.2em; color: var(--primary-color); display: flex; align-items: center; }
    .edit-btn-inline { background: none; border: none; cursor: pointer; color: var(--primary-color); margin-left: 10px; font-size: 0.9em; padding: 5px; flex-grow: 0; }
    .edit-btn-inline:hover { color: var(--secondary-color); }
    #changePasswordBtn { width: 100%; margin-top: 20px; background-color: var(--edit-color); color: #212529; }

    .help-button { position: fixed; top: 15px; right: 15px; width: 40px; height: 40px; background-color: var(--info-color); color: white; border: none; border-radius: 50%; font-size: 1.5em; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.15); z-index: 1002; display: flex; justify-content: center; align-items: center; }
    .help-panel { position: fixed; top: 0; right: 0; width: 350px; height: 100%; background-color: var(--bg-content); box-shadow: -5px 0 15px var(--shadow-color); transform: translateX(100%); transition: transform 0.3s ease-in-out; z-index: 1010; display: flex; flex-direction: column; }
    .help-panel.open { transform: translateX(0); }
    .help-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
    .help-header h2 { margin: 0; font-size: 1.5em; border: none; padding: 0; }
    .close-help-btn { background: none; border: none; font-size: 1.8em; cursor: pointer; padding: 0 5px; color: var(--text-secondary); }
    .help-content { padding: 20px; overflow-y: auto; flex-grow: 1; }
    .help-content h3 { text-align: left; margin-top: 20px; border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; font-size: 1.2em; }
    .help-content p, .help-content li { line-height: 1.6; font-size: 0.95em; }
    .help-content .note { background-color: var(--bg-accent); border-left: 4px solid var(--primary-color); padding: 15px; margin: 15px 0; border-radius: 4px; font-size: 0.9em; }
    .help-content .formula { text-align: center; font-size: 1em; margin: 10px 0; padding: 10px; background-color: var(--bg-main); border-radius: 4px; font-weight: bold; }
    .help-content i { color: var(--secondary-color); margin-right: 5px; }
    @media (max-width: 480px) { .help-panel { width: 100%; } }
    .help-content-section { display: none; }
    .help-content-section.active-help { display: block; }

    .fab-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; align-items: center; gap: 15px; }
    .fab { width: 50px; height: 50px; background-color: var(--secondary-color); color: white; border: none; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.5em; box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer; transition: transform 0.2s ease, background-color 0.2s; position: relative; }
    .fab:hover { transform: scale(1.1); }
    
    #notification-fab {
        background-color: var(--danger-color);
        animation: blink 1.5s infinite ease-in-out;
    }
    #notification-fab:hover {
        background-color: #c82333;
    }
    @keyframes blink {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
    }
    #note-notification-count {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: var(--primary-color);
        color: white;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        font-size: 12px;
        font-weight: bold;
        display: flex;
        justify-content: center;
        align-items: center;
        border: 2px solid var(--bg-content);
    }
    
    .loading-indicator {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px;
        gap: 10px;
        color: var(--text-secondary);
        font-size: 1.1em;
        animation: fadeIn 0.5s;
    }
    .loading-indicator i {
        font-size: 1.5em;
    }

    #admin-notes-container { display: flex; flex-direction: column; gap: 15px; max-height: 50vh; overflow-y: auto; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 20px;}
    .note-card { background-color: var(--bg-accent); border-radius: 8px; padding: 15px; border-left: 5px solid var(--primary-color); max-width: 80%; }
    .note-header { font-size: 0.85em; color: var(--text-secondary); border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-bottom: 10px; }
    .note-header .author { font-weight: bold; color: var(--primary-color); text-transform: capitalize; }
    .note-body { font-size: 1em; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; }
    
    .note-card.user-note {
        align-self: flex-end;
        border-left: none;
        border-right: 5px solid var(--secondary-color);
        background-color: #e8f5e9;
    }
    body.dark-mode .note-card.user-note {
        background-color: #2a3b2b;
    }
    
    #responseForm textarea { width: 100%; box-sizing: border-box; resize: vertical; min-height: 80px; }
    #sendResponseBtn { width: 100%; }

    /* Login Form Layout Adjustments */
    #loginForm {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .form-row, .form-row-date {
        display: flex;
        gap: 10px;
        width: 100%;
    }
    
    #loginForm > input,
    #loginForm > .password-wrapper,
    #loginForm > button,
    #loginForm > a {
        width: 100%;
        box-sizing: border-box;
    }

    .form-row > input,
    .form-row > select,
    .form-row-date > select,
    .form-row-date > input {
        flex: 1;
        min-width: 0; 
    }
     .form-row-date > input {
        flex: 1.5; 
    }
    .form-row-date > label {
        flex-grow: 0;
        flex-shrink: 0; 
        align-self: center;
        font-size: 0.9em;
        color: var(--text-secondary);
    }

    /* --- Statistics Styles (used inside modal) --- */
    .stat-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }
    .stat-card {
        background-color: var(--bg-accent);
        padding: 20px;
        border-radius: 8px;
        text-align: center;
    }
    .stat-card .label {
        font-size: 0.9em;
        color: var(--text-secondary);
        margin-bottom: 8px;
        display: block;
    }
    .stat-card .value {
        font-size: 1.8em;
        font-weight: bold;
        color: var(--primary-color);
    }
    .stat-card .value.projection {
        color: var(--secondary-color);
    }
    .stat-card .disclaimer {
        font-size: 0.75em;
        margin-top: 10px;
        color: var(--text-secondary);
    }
    .chart-controls {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
    }
    .chart-controls button {
        flex-grow: 0;
        padding: 8px 16px;
    }
    .chart-controls button.active {
        background-color: var(--primary-color);
    }
    .chart-container {
        position: relative;
        height: 40vh;
        min-height: 300px;
        width: 100%;
    }

  </style>
</head>
<body>

<nav id="sideMenu" class="side-menu"></nav>

<div id="mainContainer" class="main-container">
    <!-- BOTÓN MENÚ CON ETIQUETA NUEVA -->
    <button id="menuToggle" class="menu-toggle" style="display: none;">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="menu-toggle-label">MENÚ</span>
    </button>
    
    <button id="help-btn" class="help-button">?</button>
    <div id="help-panel" class="help-panel">
        <div class="help-header">
            <h2 id="help-title">Ayuda</h2>
            <button id="close-help-btn" class="close-help-btn">&times;</button>
        </div>
        <div class="help-content">
            <div id="help-content-login" class="help-content-section">
                <h3>¿Cómo Empezar?</h3>
                <p>Bienvenido/a al registro personal. Aquí te explicamos cómo acceder.</p>
                <div class="note">
                    <strong>Si es tu Primera Vez (Registro):</strong>
                    <ol>
                        <li>Completa <strong>todos</strong> los campos del formulario (nombre, tipo de contrato, puntos, etc.).</li>
                        <li>Crea una contraseña segura.</li>
                        <li>Presiona "Ingresar o Registrar". Tu cuenta se creará y se te pedirá un número de teléfono para protegerla.</li>
                    </ol>
                </div>
                <div class="note">
                    <strong>Si ya Tienes una Cuenta (Ingreso):</strong>
                    <ul>
                        <li>Usa el "Acceso Rápido" para rellenar tus datos o ingrésalos manually.</li>
                        <li>Escribe tu contraseña y presiona "Ingresar o Registrar".</li>
                    </ul>
                </div>
                 <div class="note">
                    <strong>¿Olvidaste tu Contraseña?</strong>
                    <p>Haz clic en el enlace "¿Olvidaste tu contraseña?", ingresa el número de teléfono que registraste y sigue los pasos para crear una nueva.</p>
                </div>
            </div>

            <div id="help-content-main" class="help-content-section">
                <h3>Explicación de las Secciones</h3>
                <p>La aplicación se divide en varias partes clave para que organices tu información:</p>
                <ul>
                    <li><strong>Retiro de Propina:</strong> ¡La nueva pantalla principal! Aquí ves el resultado final de todos los cálculos según tu tipo de contrato (Planta o Part-Time). Es el resumen que te dice cuánto debes retirar. Desde aquí puedes abrir las <strong>Estadísticas</strong> para ver gráficos y proyecciones.</li>
                    <li><strong>Montos por Noche:</strong> En esta sección puedes ver el desglose de todas las propinas recaudadas cada día del mes. Los datos se importan automáticamente y aquí puedes revisarlos en detalle.</li>
                    <li><strong>Mis Datos:</strong> Aquí puedes verificar que tu información personal sea correcta, como tu nombre, tipo de contrato y, lo más importante, la <strong>cantidad de puntos</strong> que tienes asignados. También puedes cambiar tu contraseña y realizar respaldos de datos desde aquí.</li>
                    <li><strong>Notas Admin:</strong> Un canal de comunicación directo para ver los mensajes del administrador y enviar respuestas.</li>
                </ul>

                <h3>Conceptos Clave del Cálculo</h3>
                <p>Para entender los cálculos, primero debes conocer estos términos:</p>
                <ul>
                    <li><strong>Puntos:</strong> Son los puntos que tienes asignados personalmente. Puedes editarlos desde la sección "Mis Datos".</li>
                    <li><strong>Total Recaudado:</strong> Es la suma de todos los montos de propina del mes.</li>
                    <li><strong>Divisor:</strong> Es el total de puntos que participan en la repartición (General para Planta, Personal para Part-Time).</li>
                    <li><strong>Anticipos:</strong> Dinero que retiraste por adelantado y que se descuenta del total.</li>
                </ul>

                <h3>Detalle de los Cálculos (Personal de Planta)</h3>
                <div class="note">
                    <p><strong>Paso A: Calcular el Valor por Punto</strong><br>La app toma el "Total Recaudado" del mes y lo divide por el "Divisor General".</p>
                    <div class="formula">Valor por Punto = Total Recaudado / Divisor General</div>

                    <p><strong>Paso B: Calcular tu Subtotal</strong><br>Luego, multiplica ese "Valor por Punto" por "Mis Puntos".</p>
                    <div class="formula">Subtotal = Valor por Punto × Mis Puntos</div>

                    <p><strong>Paso C: Calcular el Total Final</strong><br>Finalmente, a tu subtotal se le restan los "Anticipos".</p>
                    <div class="formula">Total a Retirar = Subtotal - Total Anticipos</div>
                </div>

                <h3>Detalle de los Cálculos (Personal Part-Time)</h3>
                <div class="note">
                    <p><strong>Paso A: Marcar Días y Calcular Pozo</strong><br>En el calendario, debes marcar los días que trabajaste para que la app sume las propinas de <strong>solo esos días</strong> en tu "Pozo Individual".</p>

                    <p><strong>Paso B: Calcular el Valor por Punto</strong><br>La app divide tu "Pozo Individual" por tu "Divisor Personal". Este divisor corresponde al divisor registrado en el <strong>último día</strong> que marcaste en el calendario.</p>
                    <div class="formula">Valor por Punto = Pozo Individual / Divisor Personal (Último Día)</div>

                    <p><strong>Paso C y D: Calcular Subtotal y Total Final</strong><br>Finalmente, el "Valor por Punto" se multiplica por "Mis Puntos" y se restan tus "Anticipos".</p>
                </div>

                <h3><i class="fas fa-comments"></i> Notas y Comunicación</h3>
                <div class="note">
                    <p>La sección <strong>"Notas Admin"</strong> es tu canal directo para comunicarte con la administración.</p>
                    <ul>
                        <li><strong>Enviar Mensajes:</strong> Escribe tu consulta o respuesta en el cuadro de texto y presiona "Enviar".</li>
                        <li><strong>Notificaciones:</strong> Cuando recibas un mensaje nuevo del administrador, verás un <strong>icono de nota parpadeante</strong> <i class="fas fa-envelope-open-text" style="color: var(--danger-color);"></i> en la esquina inferior derecha, con un número que indica cuántos mensajes nuevos tienes.</li>
                        <li><strong>Marcar como Leído:</strong> Para quitar la notificación, simplemente entra a la sección "Notas Admin" desde el menú.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div id="login-container">
      <section id="loginSection">
        <h2>Ingresar a tu Registro</h2>
        
        <section id="quickAccessSection" style="display: none; padding: 10px; box-shadow: none;">
            <h4 style="text-align: center; margin:0 0 15px 0; font-size: 1em; color: #555;">Acceso Rápido</h4>
            <div id="quickAccessUsers" class="quick-access-container">
            </div>
        </section>
        <form id="loginForm">
            <div class="form-row">
                <input type="text" id="loginNombre" placeholder="Nombre" required />
                <input type="text" id="loginApellido" placeholder="Apellido" required />
            </div>
            <div class="form-row">
                <select id="loginTipoContrato" required>
                    <option value="">Tipo de Contrato</option>
                    <option value="Planta">Planta</option>
                    <option value="Part Time">Part Time</option>
                </select>
                <select id="loginSeccion" required>
                    <option value="">Selecciona tu Sección</option>
                    <option value="Mesas">Mesas</option>
                    <option value="Máquinas">Máquinas</option>
                    <option value="Bóveda">Bóveda</option>
                    <option value="Otros">Otros</option>
                </select>
            </div>
            <div class="form-row-date">
              <label for="loginDia">F. Ingreso:</label>
              <select id="loginDia" required>
                <option value="">Día</option>
                <script>for(let i=1;i<=31;i++)document.write(`<option value="${i}">${i}</option>`);</script>
              </select>
              <select id="loginMes" required>
                <option value="">Mes</option>
                <script>for(let i=1;i<=12;i++)document.write(`<option value="${i}">${i}</option>`);</script>
              </select>
              <input type="number" id="loginAnio" placeholder="Año" required />
            </div>
            <input type="number" id="loginPuntos" placeholder="Cantidad de Puntos" required />
            <div class="password-wrapper">
              <input type="password" id="loginPassword" placeholder="Contraseña" required />
              <i class="fas fa-eye password-toggle-icon"></i>
            </div>
            <button type="submit">Ingresar o Registrar</button>
            <a href="#" id="forgotPasswordLink" class="forgot-password-link">¿Olvidaste tu contraseña?</a>
        </form>
      </section>
    </div>

    <div id="main-content" style="display: none;">
      <div class="app-header">
        <h1>Registro Personal</h1>
        <div class="user-info-cluster">
            <span id="userInfo"></span>
            <button id="logoutBtn" class="logout-button">Cerrar Sesión</button>
        </div>
      </div>
      
      <section id="retirosPropinaSection" class="content-panel">
          <h2 id="titulo-retiro">Retiro de Propina</h2>
          <div id="vistaPlanta" style="display: none;">
              <div class="retiro-container">
                  <div class="calculation-item"><strong>Mis Puntos:</strong> <span id="puntosUsuarioDisplayPlanta">0</span></div>
                  <hr>
                  <div class="calculation-item"><strong>Total Recaudado:</strong> <span id="totalMontoDividirPlanta">$0</span></div>
                  <div class="calculation-item"><strong>Divisor Registrado (Último):</strong> <span id="divisorDisplayPlanta">No registrado</span></div>
                  <div class="calculation-item" style="color: var(--info-color); font-weight: bold;"><strong>Valor por Punto:</strong> <span id="valorPorPuntoDisplayPlanta">$0</span></div>
                  <hr>
                  <div class="calculation-item"><strong>Subtotal (Puntos x Valor):</strong> <span id="subtotalDisplayPlanta">$0</span></div>
                  <div class="calculation-item"><strong>Total Anticipos:</strong> <span id="anticiposDisplayPlanta">-$0</span></div>
                  <div id="anticipos-list-container-planta" class="anticipos-list-container"></div>
                  <div class="calculation-item final-calculation">
                      <strong class="total-result">Total a Retirar:</strong> 
                      <span id="resultadoFinalPlanta" class="total-result">$0</span>
                  </div>
              </div>
          </div>
          <div id="vistaPartTime" style="display: none;">
              <div class="part-time-layout">
                  <div class="calendar-section">
                      <h4>Marca tus días trabajados:</h4>
                      <div id="calendar-container"></div>
                  </div>
                  <div class="calculation-section-pt">
                      <div class="retiro-container-pt">
                          <div class="calculation-item"><strong>Mis Puntos:</strong> <span id="puntosUsuarioDisplayPT">0</span></div>
                          <hr>
                          <div class="calculation-item"><strong>Días trabajados:</strong> <span id="diasTrabajadosDisplayPT">0</span></div>
                          <div class="calculation-item"><strong>Pozo Individual:</strong> <span id="pozoIndividualDisplayPT">$0</span></div>
                          <div class="calculation-item">
                               <strong title="Corresponde al divisor del último día de trabajo que marcaste en el calendario.">Divisor Personal (Auto):</strong>
                               <span id="divisorDisplayPT">0</span>
                          </div>
                          <div class="calculation-item" style="color: var(--info-color); font-weight: bold;"><strong>Valor por Punto:</strong> <span id="valorPorPuntoDisplayPT">$0</span></div>
                          <hr>
                          <div class="calculation-item"><strong>Subtotal:</strong> <span id="subtotalDisplayPT">$0</span></div>
                          <div class="calculation-item"><strong>Total Anticipos:</strong> <span id="anticiposDisplayPT">-$0</span></div>
                          <div id="anticipos-list-container-pt" class="anticipos-list-container"></div>
                          <div class="calculation-item final-calculation">
                              <strong class="total-result">Total a Retirar:</strong> 
                              <span id="resultadoFinalPT" class="total-result">$0</span>
                          </div>
                          <button id="registrarDivisorPTBtn" style="width:100%; margin-top:10px; display: none;">Editar Divisor Personal</button>
                      </div>
                  </div>
              </div>
          </div>
          <div class="retiro-actions">
              <button id="openStatsModalBtn" style="background-color: var(--primary-color);">Ver Estadísticas</button>
              <button id="registrarAnticipoBtn">Registrar Anticipo</button>
              <button id="resetMesBtn" class="reset-button">Reiniciar Mes</button>
          </div>
      </section>

      <section id="montosSection" class="content-panel">
        <h2>Montos por Noche</h2>
        <button id="importarDesdeSheetsBtn" style="width: 100%; margin-bottom: 15px;">Sincronizar con Sheets</button>
        <div id="totalDiario">Total recaudado: $0</div>
        <div id="tarjetasMontos"></div>
      </section>

      <section id="datosUsuarioSection" class="content-panel">
          <h2>Mis Datos</h2>
          <div class="user-data-container">
              <div class="data-item">
                  <span class="data-item-label">Nombre Completo</span>
                  <span id="userDataNombre" class="data-item-value"></span>
              </div>
              <div class="data-item">
                  <span class="data-item-label">Tipo de Contrato</span>
                  <span id="userDataContrato" class="data-item-value"></span>
              </div>
              <div class="data-item">
                  <span class="data-item-label">Puntos Asignados</span>
                  <span id="userDataPuntos" class="data-item-value">
                      <span id="puntosValueDisplay"></span>
                      <button id="editPuntosBtn" class="edit-btn-inline" title="Editar Puntos">✏️</button>
                  </span>
              </div>
              <div class="data-item">
                  <span class="data-item-label">Fecha de Ingreso</span>
                  <span id="userDataFechaIngreso" class="data-item-value"></span>
              </div>
          </div>
          <button id="changePasswordBtn">Cambiar Contraseña</button>
          
          <div style="margin-top: 30px; border-top: 1px solid var(--border-color); padding-top: 20px;">
              <h3>Respaldo y Recuperación</h3>
              <p style="font-size: 0.9em; color: var(--text-secondary);">Guarda una copia de seguridad de todos los datos de la aplicación (incluyendo todos los usuarios registrados en este dispositivo) o restaura desde un archivo previo.</p>
              <div style="display: flex; gap: 10px; margin-top: 15px;">
                  <button id="exportDataBtn" style="background-color: var(--info-color);">
                      <i class="fas fa-download"></i> Exportar Datos (JSON)
                  </button>
                  <button id="importDataBtn" style="background-color: var(--edit-color); color: #212529;">
                      <i class="fas fa-upload"></i> Importar Datos (JSON)
                  </button>
              </div>
          </div>
      </section>
      
      <section id="notasSection" class="content-panel">
          <h2>Comunicación con Administración</h2>
          <div id="admin-notes-container">
              </div>
          <form id="responseForm" style="margin-top: 20px;">
              <textarea id="responseMessage" placeholder="Escribe tu respuesta o consulta aquí..." rows="4"></textarea>
              <button type="button" id="sendResponseBtn">Enviar Respuesta</button>
          </form>
      </section>
    </div> 
</div>

<div class="fab-container">
    <button id="notification-fab" class="fab" title="Nuevas Notas" style="display: none;">
        <i class="fas fa-envelope-open-text"></i>
        <span id="note-notification-count"></span>
    </button>
    <button id="theme-toggle" class="fab" title="Cambiar Tema">
        <i class="fas fa-moon"></i>
    </button>
</div>


<footer>
    CarlosPN Interactive®
</footer>

<div id="toast-container"></div>

<div id="statsModal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h4>Estadísticas y Proyecciones</h4>
            <button id="closeStatsModalBtn" class="modal-close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <div class="stat-cards" id="statCardsContainer"></div>
            <div class="chart-controls">
                <button id="dailyViewBtn" class="active">Vista Diaria</button>
                <button id="weeklyViewBtn">Vista Semanal</button>
            </div>
            <div class="chart-container">
                <canvas id="tipChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div id="addAnticipoModal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h4>Registrar Anticipo</h4></div>
        <div class="modal-body">
            <label for="addAnticipoMontoInput">Monto:</label>
            <input type="text" id="addAnticipoMontoInput" inputmode="numeric" required />
            <label for="addAnticipoFechaInput">Fecha:</label>
            <input type="date" id="addAnticipoFechaInput" required />
        </div>
        <div class="modal-footer">
            <button class="reset-button" id="cancelAddAnticipoBtn">Cancelar</button>
            <button id="saveAddAnticipoBtn">Guardar</button>
        </div>
    </div>
</div>
<div id="editAnticipoModal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h4>Editar Anticipo</h4></div>
        <div class="modal-body">
            <label for="editAnticipoMontoInput">Monto:</label>
            <input type="text" id="editAnticipoMontoInput" inputmode="numeric" required />
            <label for="editAnticipoFechaInput">Fecha:</label>
            <input type="date" id="editAnticipoFechaInput" required />
        </div>
        <div class="modal-footer">
            <button class="reset-button" id="cancelEditAnticipoBtn">Cancelar</button>
            <button class="edit-button-modal" id="saveEditAnticipoBtn">Guardar Cambios</button>
        </div>
    </div>
</div>
<div id="divisorModal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h4>Registrar Divisor General</h4></div>
        <div class="modal-body">
            <label for="divisorInput">Divisor:</label>
            <input type="text" id="divisorInput" inputmode="numeric" required />
        </div>
        <div class="modal-footer">
            <button class="reset-button" id="cancelDivisorBtn">Cancelar</button>
            <button id="saveDivisorBtn">Guardar</button>
        </div>
    </div>
</div>
<div id="divisorPTModal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h4>Editar Divisor Personal</h4></div>
        <div class="modal-body">
            <label for="divisorPTInput">Divisor:</label>
            <input type="text" id="divisorPTInput" inputmode="numeric" required />
        </div>
        <div class="modal-footer">
            <button class="reset-button" id="cancelDivisorPTBtn">Cancelar</button>
            <button id="saveDivisorPTBtn">Guardar</button>
        </div>
    </div>
</div>

<div id="phoneModal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h4>¡Bienvenido(a)!</h4></div>
        <div class="modal-body">
            <p>Para proteger tu cuenta, por favor ingresa tu número de teléfono. Lo usaremos para cambiar tu contraseña si la olvidas.</p>
            <label for="phoneInput">Número de Teléfono:</label>
            <input type="tel" id="phoneInput" placeholder="Ej: 912345678" required />
        </div>
        <div class="modal-footer">
            <button id="savePhoneBtn">Guardar y Continuar</button>
        </div>
    </div>
</div>
<div id="forgotPasswordModal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h4>Cambiar Contraseña</h4></div>
        <div class="modal-body">
            <div id="verifyPhoneContainer">
                <p>Ingresa tu número de teléfono para verificar tu identidad.</p>
                <label for="recoverPhoneInput">Número de Teléfono:</label>
                <input type="tel" id="recoverPhoneInput" placeholder="Tu número de teléfono" required />
                 <div id="recoveryResult"></div>
            </div>
            <div id="newPasswordContainer" style="display: none;">
                <p>Verificación exitosa. Ahora puedes establecer tu nueva contraseña.</p>
                <label for="newPasswordInput">Nueva Contraseña:</label>
                <div class="password-wrapper">
                    <input type="password" id="newPasswordInput" required />
                    <i class="fas fa-eye password-toggle-icon"></i>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="reset-button" id="cancelForgotBtn">Cancelar</button>
            <button id="verifyPhoneBtn">Verificar</button>
            <button id="saveNewPasswordBtn" style="display: none;">Guardar Nueva Contraseña</button>
        </div>
    </div>
</div>
<div id="changePasswordModal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h4>Actualizar Contraseña</h4></div>
        <div class="modal-body">
             <label for="newPasswordLoggedInInput">Ingresa tu nueva contraseña:</label>
             <div class="password-wrapper">
                <input type="password" id="newPasswordLoggedInInput" required />
                <i class="fas fa-eye password-toggle-icon"></i>
             </div>
        </div>
        <div class="modal-footer">
            <button class="reset-button" id="cancelChangePasswordBtn">Cancelar</button>
            <button id="saveNewPasswordLoggedInBtn">Guardar Cambios</button>
        </div>
    </div>
</div>

<div id="editPuntosModal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h4>Editar Puntos Asignados</h4></div>
        <div class="modal-body">
            <label for="editPuntosInput">Nueva cantidad de puntos:</label>
            <input type="number" id="editPuntosInput" required />
        </div>
        <div class="modal-footer">
            <button class="reset-button" id="cancelEditPuntosBtn">Cancelar</button>
            <button id="saveEditPuntosBtn">Guardar Puntos</button>
        </div>
    </div>
</div>

<input type="file" id="importFileInput" style="display: none;" accept="application/json">


<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Lógica del Modo Oscuro ---
    const themeToggleBtn = document.getElementById('theme-toggle');
    if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
        themeToggleBtn.querySelector('i').classList.replace('fa-moon', 'fa-sun');
    }
    themeToggleBtn.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        const icon = themeToggleBtn.querySelector('i');
        if (isDark) {
            icon.classList.replace('fa-moon', 'fa-sun');
        } else {
            icon.classList.replace('fa-sun', 'fa-moon');
        }
    });

    // --- URLs de los scripts ---
    const SCRIPT_URL_NOTAS = 'https://script.google.com/macros/s/AKfycbwhKQTp9kER_H87XLekd3d69u5PK5ZpfpGzKdAtYcfKM0qTUuF5apPvB2UNYSyS2-FR/exec';
    const SCRIPT_URL_RECAUDACION_EXTERNA = 'https://script.google.com/macros/s/AKfycbxdiAMbUy2nTuXvvIuF_-KF-ed0s7jxXvh4X2T5u88jl9FSZdrDkNVgVNc7akhpIwCX/exec';
    const SCRIPT_URL_RECAUDACION = 'https://script.google.com/macros/s/AKfycbxna9EH5LZPTPCPws58pGro6qCrZ8_zNwvUkUHS28BYfd8CsAcD1MRcqlITbDm4lTk/exec'; 
    const SCRIPT_URL_LOGIN = 'https://script.google.com/macros/s/AKfycbyuUqSHgmrGYOUife2U_zZss6EvqDOAHZbXZGknDipaE12cOhTRYndFbN1Efmk1cCRa/exec';

    // --- Función de Cierre de Sesión ---
    function logout() {
        if (localStorage.getItem('loggedInUser')) {
            showToast('Se ha cerrado la sesión por seguridad.', 'info');
            if (notesInterval) clearInterval(notesInterval);
            if (sheetsInterval) clearInterval(sheetsInterval);
            localStorage.removeItem('loggedInUser');
            loggedInUser = null;
            setTimeout(() => location.reload(), 1500);
        }
    }
    
    // --- Variables globales y de estado ---
    const loginContainer = document.getElementById('login-container');
    const mainContent = document.getElementById('main-content');
    const menuToggle = document.getElementById('menuToggle');
    const sideMenu = document.getElementById('sideMenu');
    const mainContainer = document.getElementById('mainContainer');
    let loggedInUser = null;
    let currentEditAnticipoId = null;
    let pendingLoginUser = null; 
    let userToChangePasswordId = null; 
    let notesInterval = null; 
    let sheetsInterval = null;
    let allFetchedNotes = [];
    let tipChart = null;
    let divisoresDiariosExternos = {};
    let lastActivityTime = Date.now(); 

    // --- Funciones de gestión de datos (localStorage) ---
    function getAppData() { return JSON.parse(localStorage.getItem('appData')) || { usuarios: {}, userData: {} }; }
    function saveAppData(data) { localStorage.setItem('appData', JSON.stringify(data)); }
    function getUserData() {
        const appData = getAppData();
        const userId = loggedInUser.id;
        if (!appData.userData[userId]) {
            appData.userData[userId] = { montosPorFecha: {}, anticipos: [], divisor: 0, diasTrabajados: [], divisorPartTime: 1, divisorDelDia: null };
            saveAppData(appData);
        }
        return appData.userData[userId];
    }
    function saveUserData(userData) {
        const appData = getAppData();
        const userId = loggedInUser.id;
        appData.userData[userId] = userData;
        saveAppData(appData);
    }
    
    function mostrarActualizandoEnCampos() {
        const ids = [
            'valorPorPuntoDisplayPlanta', 'divisorDisplayPlanta', 
            'valorPorPuntoDisplayPT', 'divisorDisplayPT'
        ];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.textContent = 'Actualizando...';
        });
    }

    async function enviarDatosLoginASheets(user) {
      if (!user || !SCRIPT_URL_LOGIN.startsWith('https://')) {
        return { status: 'success', message: 'Función desactivada localmente.' };
      }
      try {
        const response = await fetch(SCRIPT_URL_LOGIN, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(user),
        });
        return await response.json();
      } catch (error) {
        return { status: 'error', message: 'Error de conexión.' };
      }
    }

    // --- Funciones de utilidad ---
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`; toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 400); }, 3000);
    }

    function showLoadingOverlay(message = 'Verificando...') {
        let overlay = document.getElementById('loading-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'loading-overlay';
            Object.assign(overlay.style, {
                position: 'fixed', top: '0', left: '0', width: '100%', height: '100%',
                backgroundColor: 'rgba(0, 0, 0, 0.7)', color: 'white',
                display: 'flex', justifyContent: 'center', alignItems: 'center',
                zIndex: '10000', fontSize: '1.5em', transition: 'opacity 0.3s'
            });
            overlay.innerHTML = `<div style="text-align: center;"><i class="fas fa-spinner fa-spin" style="font-size: 2em; margin-bottom: 15px;"></i><div id="loading-message"></div></div>`;
            document.body.appendChild(overlay);
        }
        overlay.querySelector('#loading-message').textContent = message;
        overlay.style.opacity = '1'; overlay.style.display = 'flex';
    }

    function hideLoadingOverlay() {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
            overlay.style.opacity = '0';
            setTimeout(() => { overlay.style.display = 'none'; }, 300);
        }
    }

    function formatNumberWithPoints(value) { 
        if (value === 'Actualizando...') return value;
        if (value === null || value === undefined || isNaN(value)) { return "0"; } 
        return Math.round(value).toString().replace(/\B(?=(\d{3})+(?!\d))/g, "."); 
    }
    function formatDate(dateString) { if (!dateString) return ''; const [year, month, day] = dateString.split('-'); return `${day}/${month}/${year}`; }
    function getTodayDateString() { return new Date().toISOString().split('T')[0]; }
    function setupNumericInputFormatting(el) { if(el) el.addEventListener('input', e => { let v = e.target.value.replace(/\./g, ''); e.target.dataset.cleanValue = (isNaN(v) || v === '') ? '' : v; e.target.value = (isNaN(v) || v === '') ? '' : formatNumberWithPoints(parseInt(v, 10)); }); }
    function formatNoteDate(isoString) { if (!isoString) return 'Fecha desconocida'; const date = new Date(isoString); return date.toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); }

    // --- Lógica del menú ---
    const setupMenu = () => {
        sideMenu.innerHTML = '<div class="menu-header">Menú</div>';
        const orderedSections = [
            {id: 'retirosPropinaSection', title: 'Retiro de Propina'},
            {id: 'montosSection', title: 'Montos por Noche'},
            {id: 'datosUsuarioSection', title: 'Mis Datos'},
            {id: 'notasSection', title: 'Notas Admin'}
        ];
        orderedSections.forEach(sectionInfo => {
            const link = document.createElement('a');
            link.href = '#'; link.textContent = sectionInfo.title; link.className = 'menu-link'; link.dataset.target = sectionInfo.id;
            sideMenu.appendChild(link);
        });
        sideMenu.addEventListener('click', (e) => {
            if (e.target.classList.contains('menu-link')) {
                e.preventDefault(); activatePanel(e.target.dataset.target);
            }
        });
    };

    function activatePanel(panelId) {
        document.querySelectorAll('#main-content > section.content-panel').forEach(panel => panel.classList.remove('active'));
        const targetPanel = document.getElementById(panelId);
        if (targetPanel) {
            targetPanel.classList.add('active');
            localStorage.setItem('activePanel', panelId);
            if (panelId === 'montosSection') cargarYMostrarMontos();
            if (panelId === 'notasSection') { cargarNotas(); markNotesAsRead(); }
            if (panelId === 'datosUsuarioSection') populateUserDataSection();
            if (panelId === 'retirosPropinaSection') actualizarCalculoRetiro(); 
        }
        document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active-link'));
        const activeLink = document.querySelector(`.menu-link[data-target="${panelId}"]`);
        if(activeLink) activeLink.classList.add('active-link');
        if (window.innerWidth < 992) { sideMenu.classList.remove('open'); menuToggle.classList.remove('active'); }
    }

    menuToggle.addEventListener('click', (e) => {
        e.stopPropagation(); sideMenu.classList.toggle('open'); menuToggle.classList.toggle('active');
    });
    
    // --- CERRAR MENÚ AL HACER CLIC FUERA ---
    document.addEventListener('click', (e) => {
        if (window.innerWidth < 992) { // Solo en móvil
            const menu = document.getElementById('sideMenu');
            const btn = document.getElementById('menuToggle');
            // Si el menú está abierto y el clic NO fue en el menú NI en el botón
            if (menu.classList.contains('open') && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.remove('open');
                btn.classList.remove('active');
            }
        }
    });

    // --- AYUDA ---
    const helpBtn = document.getElementById('help-btn');
    const helpPanel = document.getElementById('help-panel');
    const closeHelpBtn = document.getElementById('close-help-btn');

    helpBtn.addEventListener('click', () => {
        helpPanel.classList.add('open');
        document.querySelectorAll('.help-content-section').forEach(s => s.classList.remove('active-help'));
        if (loggedInUser) {
            document.getElementById('help-content-main').classList.add('active-help');
            document.getElementById('help-title').textContent = 'Guía de Uso';
        } else {
            document.getElementById('help-content-login').classList.add('active-help');
            document.getElementById('help-title').textContent = 'Ayuda de Acceso';
        }
    });
    closeHelpBtn.addEventListener('click', () => helpPanel.classList.remove('open'));

    // --- SESIÓN ---
    function checkLogin() {
        const user = JSON.parse(localStorage.getItem('loggedInUser'));
        if (user && user.id) {
            loggedInUser = user;
            loginContainer.style.display = 'none'; 
            mainContent.style.display = 'block'; 
            menuToggle.style.display = 'flex';
            document.getElementById('userInfo').textContent = `${user.nombre} ${user.apellido}`;
            setupMenu(); initApp();
            resetInactivityTimer(); // Iniciar timer al login
        } else {
            loginContainer.style.display = 'block'; 
            mainContent.style.display = 'none'; 
            displayRecentLogins();
        }
    }

    // --- NUEVO: Función para actualizar la lista de usuarios recientes ---
    function updateRecentLogins(user) {
        let recent = JSON.parse(localStorage.getItem('recentLogins')) || [];
        recent = recent.filter(u => u.id !== user.id); // Evitar duplicados
        recent.unshift(user); // Agregar al principio
        if (recent.length > 5) recent.pop(); // Mantener solo los últimos 5
        localStorage.setItem('recentLogins', JSON.stringify(recent));
    }

    function displayRecentLogins() {
        const recentLogins = JSON.parse(localStorage.getItem('recentLogins')) || [];
        const container = document.getElementById('quickAccessUsers');
        const section = document.getElementById('quickAccessSection'); 
        
        container.innerHTML = ''; 
        
        if (recentLogins.length > 0) {
            section.style.display = 'block'; 
            
            recentLogins.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'quick-access-user';
                userDiv.innerHTML = `
                    <button class="delete-user-btn" data-user-id="${user.id}">&times;</button>
                    <div class="quick-access-avatar">${user.nombre.charAt(0).toUpperCase()}</div>
                    <div class="quick-access-name">${user.nombre}</div>
                `;
                
                // Click para RELLENAR EL FORMULARIO
                userDiv.addEventListener('click', (e) => {
                    if(e.target.classList.contains('delete-user-btn')) {
                        e.stopPropagation();
                        if(confirm('¿Estás seguro de que quieres eliminar a este usuario del acceso rápido?')) {
                            let current = JSON.parse(localStorage.getItem('recentLogins')) || [];
                            current = current.filter(u => u.id !== user.id);
                            localStorage.setItem('recentLogins', JSON.stringify(current));
                            displayRecentLogins();
                        }
                        return;
                    }
                    
                    // RELLENO EXPLÍCITO Y ROBUSTO
                    const nombreInput = document.getElementById('loginNombre');
                    const apellidoInput = document.getElementById('loginApellido');
                    const contratoSelect = document.getElementById('loginTipoContrato');
                    const seccionSelect = document.getElementById('loginSeccion');
                    const diaSelect = document.getElementById('loginDia');
                    const mesSelect = document.getElementById('loginMes');
                    const anioInput = document.getElementById('loginAnio');
                    const puntosInput = document.getElementById('loginPuntos');
                    const passwordInput = document.getElementById('loginPassword');

                    if(nombreInput) nombreInput.value = user.nombre || '';
                    if(apellidoInput) apellidoInput.value = user.apellido || '';
                    if(contratoSelect) contratoSelect.value = user.tipo || '';
                    if(seccionSelect) seccionSelect.value = user.seccion || '';
                    if(diaSelect) diaSelect.value = user.dia || '';
                    if(mesSelect) mesSelect.value = user.mes || '';
                    if(anioInput) anioInput.value = user.anio || '';
                    if(puntosInput) puntosInput.value = user.puntos || '';
                    
                    if(passwordInput) {
                        passwordInput.value = '';
                        passwordInput.focus();
                    }
                });

                container.appendChild(userDiv);
            });
        } else {
            section.style.display = 'none'; 
        }
    }

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const user = {
            id: `${document.getElementById('loginNombre').value.toLowerCase()}-${document.getElementById('loginApellido').value.toLowerCase()}`,
            nombre: document.getElementById('loginNombre').value.trim(),
            apellido: document.getElementById('loginApellido').value.trim(),
            tipo: document.getElementById('loginTipoContrato').value,
            seccion: document.getElementById('loginSeccion').value,
            dia: document.getElementById('loginDia').value,
            mes: document.getElementById('loginMes').value,
            anio: document.getElementById('loginAnio').value,
            puntos: parseFloat(document.getElementById('loginPuntos').value),
            password: document.getElementById('loginPassword').value,
            telefono: ''
        };
        showLoadingOverlay();
        const res = await enviarDatosLoginASheets(user);
        hideLoadingOverlay();
        if (res.status === 'success') {
            const appData = getAppData();
            appData.usuarios[user.id] = user;
            saveAppData(appData);
            
            updateRecentLogins(user); 
            
            localStorage.setItem('loggedInUser', JSON.stringify(user));
            location.reload();
        } else { showToast(res.message, 'error'); }
    });

    // --- ESTADÍSTICAS ---
    const statsModal = document.getElementById('statsModal');
    const openStatsModalBtn = document.getElementById('openStatsModalBtn');
    const closeStatsModalBtn = document.getElementById('closeStatsModalBtn');
    const dailyViewBtn = document.getElementById('dailyViewBtn');
    const weeklyViewBtn = document.getElementById('weeklyViewBtn');

    openStatsModalBtn.addEventListener('click', () => {
        updateStatisticsUI('daily');
        dailyViewBtn.classList.add('active');
        weeklyViewBtn.classList.remove('active');
        statsModal.style.display = 'flex';
    });
    closeStatsModalBtn.addEventListener('click', () => statsModal.style.display = 'none');
    
    dailyViewBtn.addEventListener('click', () => {
        dailyViewBtn.classList.add('active');
        weeklyViewBtn.classList.remove('active');
        updateStatisticsUI('daily');
    });
    
    weeklyViewBtn.addEventListener('click', () => {
        weeklyViewBtn.classList.add('active');
        dailyViewBtn.classList.remove('active');
        updateStatisticsUI('weekly');
    });

    function updateStatisticsUI(view = 'daily') {
        const today = new Date();
        const day = today.getDate();
        let startDate, endDate;

        if (day >= 15) {
            startDate = new Date(today.getFullYear(), today.getMonth(), 15);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 14);
        } else {
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 15);
            endDate = new Date(today.getFullYear(), today.getMonth(), 14);
        }

        const userData = getUserData();
        // PROTECCIÓN 1: Asegurar que userData exista
        if (!userData) return;
        
        const montosPorFecha = userData.montosPorFecha || {};
        const startDateStr = startDate.toISOString().split('T')[0];
        const endDateStr = endDate.toISOString().split('T')[0];

        const fechasDelCiclo = Object.keys(montosPorFecha).filter(f => f >= startDateStr && f <= endDateStr).sort();

        let vppAcumulado = 0;
        let poolAcumulado = 0;
        let dailyVppData = [];

        fechasDelCiclo.forEach(fecha => {
            const poolDia = montosPorFecha[fecha].reduce((sum, m) => sum + m.monto, 0);
            const divisorDia = divisoresDiariosExternos[fecha] || 0;
            const vppDia = divisorDia > 0 ? (poolDia / divisorDia) : 0;
            
            poolAcumulado += poolDia;
            vppAcumulado += vppDia;
            dailyVppData.push({ fecha, vpp: vppDia, pool: poolDia });
        });

        const diasTranscurridos = dailyVppData.length;
        const promedioVppDiario = diasTranscurridos > 0 ? vppAcumulado / diasTranscurridos : 0;
        const vppProyectado = promedioVppDiario * 30;
        const gananciaProyectada = vppProyectado * loggedInUser.puntos;

        // PROTECCIÓN 2: Asegurar que el elemento exista antes de escribir
        const statContainer = document.getElementById('statCardsContainer');
        if (statContainer) {
            statContainer.innerHTML = `
                <div class="stat-card"><span class="label">VPP Acumulado</span><span class="value">$${formatNumberWithPoints(vppAcumulado)}</span></div>
                <div class="stat-card"><span class="label">Pool Total Acumulado</span><span class="value">$${formatNumberWithPoints(poolAcumulado)}</span></div>
                <div class="stat-card"><span class="label">VPP Proyectado (Día 14)</span><span class="value projection">$${formatNumberWithPoints(vppProyectado)}</span></div>
                <div class="stat-card"><span class="label">Ganancia Est. (Mes)</span><span class="value" style="color:var(--secondary-color)">$${formatNumberWithPoints(gananciaProyectada)}</span><p class="disclaimer">*Calculado sobre tus ${loggedInUser.puntos} puntos.</p></div>
            `;
        }

        if (view === 'weekly') {
            const weeklyData = [];
            let currentWeekVpp = 0;
            let count = 0;
            let weekIndex = 1;
            
            dailyVppData.forEach((d, index) => {
                currentWeekVpp += d.vpp;
                count++;
                
                if (count === 7 || index === dailyVppData.length - 1) {
                    weeklyData.push({
                        fecha: `Semana ${weekIndex}`,
                        vpp: currentWeekVpp / count
                    });
                    currentWeekVpp = 0;
                    count = 0;
                    weekIndex++;
                }
            });
            renderTipChart(weeklyData, 'weekly');
        } else {
            renderTipChart(dailyVppData, 'daily');
        }
    }

    function renderTipChart(data, viewMode) {
        // PROTECCIÓN 3: Verificar que el canvas exista
        const canvas = document.getElementById('tipChart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        let labels, values;
        if(viewMode === 'weekly') {
            labels = data.map(d => d.fecha);
            values = data.map(d => d.vpp);
        } else {
            labels = data.map(d => formatDate(d.fecha).substring(0, 5));
            values = data.map(d => d.vpp);
        }

        if (tipChart) tipChart.destroy();
        tipChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: viewMode === 'weekly' ? 'Promedio VPP Semanal' : 'VPP Diario',
                    data: values,
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    fill: true, tension: 0.3
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    // --- RECAUDACIÓN Y SYNC ---
    async function importarDesdeSheets(isSilent = false) {
        if (!loggedInUser) return;
        try {
            const response = await fetch(`${SCRIPT_URL_RECAUDACION}?action=get`);
            const result = await response.json();
            if (result.status === 'success') {
                const userData = getUserData();
                userData.montosPorFecha = {};
                result.data.forEach(dato => {
                    if (!userData.montosPorFecha[dato.fecha]) userData.montosPorFecha[dato.fecha] = [];
                    userData.montosPorFecha[dato.fecha].push({ area: dato.tipo, monto: parseFloat(dato.monto) });
                });
                saveUserData(userData);
            }
        } catch (e) { console.error(e); }
    }

    async function obtenerDivisoresExternos(isSilent = true) {
        try {
            const res = await fetch(`${SCRIPT_URL_RECAUDACION_EXTERNA}?action=getDivisores`);
            const result = await res.json();
            if (result.status === 'success') {
                divisoresDiariosExternos = result.data;
                localStorage.setItem('cachedDivisores', JSON.stringify(divisoresDiariosExternos));
            }
        } catch (e) { console.error(e); }
    }

    async function obtenerYActualizarValorPorPuntoExterno() {
        if (!loggedInUser || loggedInUser.tipo !== 'Planta') return;
        try {
            const response = await fetch(`${SCRIPT_URL_RECAUDACION_EXTERNA}?action=get&v=${Date.now()}`);
            const result = await response.json();
            if (result.status === 'success') {
                const divRes = await fetch(`${SCRIPT_URL_RECAUDACION_EXTERNA}?action=getDivisores`);
                const divisores = (await divRes.json()).data || {};
                const totalesPorDia = result.data.reduce((acc, d) => { acc[d.fecha] = (acc[d.fecha] || 0) + d.monto; return acc; }, {});
                const totalVpp = Object.keys(totalesPorDia).reduce((sum, f) => divisores[f] > 0 ? sum + (totalesPorDia[f]/divisores[f]) : sum, 0);
                const fechasDiv = Object.keys(divisores).sort();
                const userData = getUserData();
                userData.divisor = totalVpp;
                userData.divisorDelDia = fechasDiv.length ? divisores[fechasDiv[fechasDiv.length - 1]] : null;
                saveUserData(userData);
            }
        } catch (e) { console.error(e); }
    }

    function cargarYMostrarMontos() {
        const userData = getUserData();
        const container = document.getElementById('tarjetasMontos');
        container.innerHTML = '';
        
        let totalGeneral = 0; 
        
        const fechas = Object.keys(userData.montosPorFecha).sort((a,b) => b.localeCompare(a));
        
        fechas.forEach(fecha => {
            const totalDia = userData.montosPorFecha[fecha].reduce((s, m) => s + m.monto, 0);
            
            totalGeneral += totalDia;
            
            const tarjeta = document.createElement('div');
            tarjeta.className = 'tarjeta collapsed';
            tarjeta.innerHTML = `<h3><span>${formatDate(fecha)}</span> <span class="total-in-header">$${formatNumberWithPoints(totalDia)}</span></h3>
                                 <div class="montos-list">
                                    ${userData.montosPorFecha[fecha].map(m => 
                                        `<div class="monto-item"><span>${m.area}</span><span>$${formatNumberWithPoints(m.monto)}</span></div>`
                                    ).join('')}
                                 </div>`;
            
            tarjeta.querySelector('h3').addEventListener('click', () => {
                tarjeta.classList.toggle('collapsed');
            });
            
            container.appendChild(tarjeta);
        });

        document.getElementById('totalDiario').textContent = `Total recaudado: $${formatNumberWithPoints(totalGeneral)}`;
        
        actualizarCalculoRetiro();
    }

    function actualizarCalculoRetiro() { if (!loggedInUser) return; loggedInUser.tipo === 'Planta' ? actualizarCalculoPlanta() : actualizarCalculoPartTime(); }

    function actualizarCalculoPlanta() {
        const userData = getUserData();
        const p = loggedInUser.puntos || 0;
        const vpp = userData.divisor || 0;
        const sub = vpp * p;
        const anticipos = (userData.anticipos || []).reduce((s, a) => s + a.monto, 0);
        const finalAmount = sub - anticipos;
        
        const totalRecaudado = Object.values(userData.montosPorFecha || {})
                                     .flat()
                                     .reduce((acc, item) => acc + item.monto, 0);

        document.getElementById('puntosUsuarioDisplayPlanta').textContent = p;
        document.getElementById('totalMontoDividirPlanta').textContent = `$${formatNumberWithPoints(totalRecaudado)}`;
        document.getElementById('divisorDisplayPlanta').textContent = formatNumberWithPoints(userData.divisorDelDia || 0);
        document.getElementById('valorPorPuntoDisplayPlanta').textContent = `$${formatNumberWithPoints(vpp)}`;
        document.getElementById('subtotalDisplayPlanta').textContent = `$${formatNumberWithPoints(sub)}`;
        document.getElementById('anticiposDisplayPlanta').textContent = `-$${formatNumberWithPoints(anticipos)}`;
        
        const resultadoEl = document.getElementById('resultadoFinalPlanta');
        resultadoEl.textContent = `$${formatNumberWithPoints(finalAmount)}`;
        // Color rojo si es negativo
        if(finalAmount < 0) resultadoEl.classList.add('negative-value');
        else resultadoEl.classList.remove('negative-value');
        
        renderAnticiposList('#anticipos-list-container-planta');
    }

    function actualizarCalculoPartTime() {
        const userData = getUserData();
        const p = loggedInUser.puntos || 0;
        const dias = userData.diasTrabajados || [];
        const pozo = dias.reduce((s, f) => s + (userData.montosPorFecha[f] || []).reduce((ds, m) => ds + m.monto, 0), 0);
        let div = 0;
        if (dias.length) {
            const ultimo = dias.sort((a,b) => b.localeCompare(a))[0];
            div = divisoresDiariosExternos[ultimo] || 0;
        }
        const vpp = div > 0 ? (pozo / div) : 0;
        const sub = vpp * p;
        const anticipos = (userData.anticipos || []).reduce((s, a) => s + a.monto, 0);
        const finalAmount = sub - anticipos;
        
        document.getElementById('puntosUsuarioDisplayPT').textContent = p;
        document.getElementById('pozoIndividualDisplayPT').textContent = `$${formatNumberWithPoints(pozo)}`;
        document.getElementById('divisorDisplayPT').textContent = formatNumberWithPoints(div);
        document.getElementById('valorPorPuntoDisplayPT').textContent = `$${formatNumberWithPoints(vpp)}`;
        document.getElementById('subtotalDisplayPT').textContent = `$${formatNumberWithPoints(sub)}`;
        
        const resultadoEl = document.getElementById('resultadoFinalPT');
        resultadoEl.textContent = `$${formatNumberWithPoints(finalAmount)}`;
         // Color rojo si es negativo
        if(finalAmount < 0) resultadoEl.classList.add('negative-value');
        else resultadoEl.classList.remove('negative-value');
        
        renderAnticiposList('#anticipos-list-container-pt');
    }

    function renderAnticiposList(selector) {
        const container = document.querySelector(selector);
        if (!container) return;
        container.innerHTML = '';
        const anticipos = getUserData().anticipos || [];
        if (!anticipos.length) container.innerHTML = '<p style="color:#888;text-align:center;">No hay anticipos.</p>';
        else anticipos.forEach(a => {
            container.innerHTML += `
            <div class="anticipo-item">
                <span>${formatDate(a.fecha)}</span>
                <strong>$${formatNumberWithPoints(a.monto)}</strong>
                <div class="actions">
                    <button class="anticipo-item-btn edit-anticipo-btn" data-id="${a.id}" data-monto="${a.monto}" data-fecha="${a.fecha}">✏️</button>
                    <button class="anticipo-item-btn delete-anticipo-btn" data-id="${a.id}">🗑️</button>
                </div>
            </div>`;
        });
        
        container.querySelectorAll('.delete-anticipo-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.target.closest('button').dataset.id;
                if(confirm('¿Eliminar anticipo?')) {
                    const ud = getUserData();
                    ud.anticipos = ud.anticipos.filter(a => a.id != id);
                    saveUserData(ud);
                    actualizarCalculoRetiro();
                }
            });
        });

        container.querySelectorAll('.edit-anticipo-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const btnEl = e.target.closest('button');
                currentEditAnticipoId = btnEl.dataset.id;
                document.getElementById('editAnticipoMontoInput').value = formatNumberWithPoints(btnEl.dataset.monto);
                document.getElementById('editAnticipoFechaInput').value = btnEl.dataset.fecha;
                document.getElementById('editAnticipoModal').style.display = 'flex';
            });
        });
    }

    // --- NOTAS ADMIN ---
    async function fetchFromNotasScript(params) {
        const url = new URL(SCRIPT_URL_NOTAS);
        Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Error de red: ${response.statusText}`);
            return await response.json();
        } catch (error) {
            console.error('Error al conectar con el servidor de notas.', error);
            return { status: 'error', message: error.message };
        }
    }

    async function postToNotasScript(params, data) {
        const url = new URL(SCRIPT_URL_NOTAS);
        Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
        try {
            const response = await fetch(url, {
                method: 'POST',
                mode: 'no-cors', 
                redirect: 'follow', 
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(data),
            });
            return { status: 'success' };
        } catch (error) {
            showToast('Error al enviar nota al servidor.', 'error');
            return { status: 'error', message: error.message };
        }
    }

    function checkForUnread(notes) {
        if (!loggedInUser) return;
        const notificationFab = document.getElementById('notification-fab');
        const notificationCount = document.getElementById('note-notification-count');
        const lastReadTimestamp = parseInt(localStorage.getItem(`lastReadTimestamp_${loggedInUser.id}`), 10) || 0;
        const unreadAdminNotes = notes.filter(note => note.autor.toLowerCase() === 'admin' && new Date(note.fecha).getTime() > lastReadTimestamp);
        const unreadCount = unreadAdminNotes.length;
        if (unreadCount > 0) {
            notificationCount.textContent = unreadCount;
            notificationFab.style.display = 'flex';
        } else {
            notificationFab.style.display = 'none';
        }
    }

    async function cargarNotas() {
        if(!loggedInUser) return;
        const container = document.getElementById('admin-notes-container');
        const isInitialLoad = !container.querySelector('.note-card') && !container.querySelector('.loading-indicator');
        if (isInitialLoad) {
            container.innerHTML = `<div class="loading-indicator"><i class="fas fa-spinner fa-spin"></i><span>Cargando mensajes...</span></div>`;
        }
        const response = await fetchFromNotasScript({ action: 'getNotes' });
        if (response.status === 'success' && response.data) {
            allFetchedNotes = response.data;
            allFetchedNotes.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

            const container = document.getElementById('admin-notes-container');
            container.innerHTML = '';
            allFetchedNotes.forEach(note => {
                const card = document.createElement('div');
                card.className = 'note-card';
                card.innerHTML = `<div class="note-header"><strong>${note.autor}</strong> - ${formatNoteDate(note.fecha)}</div><div class="note-body">${note.mensaje}</div>`;
                container.appendChild(card);
            });
            container.scrollTop = container.scrollHeight;
        }
    }
    
    function markNotesAsRead() { /* Lógica de timestamp si se desea */ }

    document.getElementById('sendResponseBtn').addEventListener('click', async () => {
        const input = document.getElementById('responseMessage');
        const sendBtn = document.getElementById('sendResponseBtn');
        const mensajeTexto = input.value.trim(); 

        if (!mensajeTexto) return;

        const originalText = sendBtn.innerHTML;
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

        const container = document.getElementById('admin-notes-container');
        const card = document.createElement('div');
        card.className = 'note-card user-note';
        card.style.opacity = '0.7'; 
        card.innerHTML = `<div class="note-header"><strong>${loggedInUser.nombre} ${loggedInUser.apellido}</strong> - Ahora</div><div class="note-body">${mensajeTexto}</div>`;
        container.appendChild(card);
        container.scrollTop = container.scrollHeight;

        input.value = '';

        try {
            const authorName = `${loggedInUser.nombre} ${loggedInUser.apellido}`;
            await postToNotasScript({ action: 'addNote' }, { autor: authorName, mensaje: mensajeTexto });
            
            card.style.opacity = '1';
            showToast("Mensaje enviado");

        } catch (e) {
            console.error("Error al enviar nota:", e);
            showToast("Error de conexión, pero se intentó enviar", "warning");
            card.style.opacity = '1'; 
        } finally {
            sendBtn.disabled = false;
            sendBtn.innerHTML = originalText;
        }
    });
    
    function renderCalendar(container) {
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth(); 
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDay = (firstDay.getDay() + 6) % 7; 
        
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const dayNames = ["Lu", "Ma", "Mi", "Ju", "Vi", "Sa", "Do"];
        
        let html = `<div class="calendar-header"><span>${monthNames[month]} ${year}</span></div>`;
        html += `<div class="calendar-grid">`;
        dayNames.forEach(d => html += `<div class="day-name">${d}</div>`);
        
        for (let i = 0; i < startingDay; i++) {
            html += `<div class="day empty"></div>`;
        }
        
        const userData = getUserData();
        const workedDays = new Set(userData.diasTrabajados || []);

        for (let i = 1; i <= daysInMonth; i++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            const isMarked = workedDays.has(dateStr);
            html += `<div class="day ${isMarked ? 'marked' : ''}" data-date="${dateStr}">${i}</div>`;
        }
        html += `</div>`;
        container.innerHTML = html;
        
        container.querySelectorAll('.day:not(.empty)').forEach(dayEl => {
            dayEl.addEventListener('click', () => {
                const date = dayEl.dataset.date;
                const ud = getUserData();
                let wDays = new Set(ud.diasTrabajados || []);
                if (wDays.has(date)) wDays.delete(date); else wDays.add(date);
                ud.diasTrabajados = Array.from(wDays);
                saveUserData(ud);
                renderCalendar(container);
                actualizarCalculoRetiro();
            });
        });
    }

    // --- EVENT LISTENERS DE MODALES ---
    
    // 1. ANTICIPOS
    const addAnticipoModal = document.getElementById('addAnticipoModal');
    document.getElementById('registrarAnticipoBtn').addEventListener('click', () => {
        document.getElementById('addAnticipoMontoInput').value = '';
        document.getElementById('addAnticipoFechaInput').value = getTodayDateString();
        addAnticipoModal.style.display = 'flex';
        document.getElementById('addAnticipoMontoInput').focus();
    });
    document.getElementById('cancelAddAnticipoBtn').addEventListener('click', () => addAnticipoModal.style.display = 'none');
    
    document.getElementById('saveAddAnticipoBtn').addEventListener('click', () => {
        const montoRaw = document.getElementById('addAnticipoMontoInput').dataset.cleanValue || document.getElementById('addAnticipoMontoInput').value;
        const monto = parseInt(montoRaw);
        const fecha = document.getElementById('addAnticipoFechaInput').value;
        
        if (!monto || !fecha) { showToast('Complete los campos', 'error'); return; }
        
        const userData = getUserData();
        userData.anticipos.push({ id: Date.now(), monto, fecha });
        saveUserData(userData);
        actualizarCalculoRetiro();
        addAnticipoModal.style.display = 'none';
        showToast('Anticipo registrado');
    });

    // 2. EDITAR ANTICIPO
    document.getElementById('cancelEditAnticipoBtn').addEventListener('click', () => document.getElementById('editAnticipoModal').style.display = 'none');
    document.getElementById('saveEditAnticipoBtn').addEventListener('click', () => {
        const montoRaw = document.getElementById('editAnticipoMontoInput').dataset.cleanValue || document.getElementById('editAnticipoMontoInput').value;
        const monto = parseInt(montoRaw);
        const fecha = document.getElementById('editAnticipoFechaInput').value;
        
        if (!monto || !fecha) return;
        
        const userData = getUserData();
        const idx = userData.anticipos.findIndex(a => a.id == currentEditAnticipoId);
        if (idx !== -1) {
            userData.anticipos[idx].monto = monto;
            userData.anticipos[idx].fecha = fecha;
            saveUserData(userData);
            actualizarCalculoRetiro();
            document.getElementById('editAnticipoModal').style.display = 'none';
            showToast('Anticipo actualizado');
        }
    });
    
    // 3. EDITAR PUNTOS
    const editPuntosModal = document.getElementById('editPuntosModal');
    document.getElementById('editPuntosBtn').addEventListener('click', () => {
        document.getElementById('editPuntosInput').value = loggedInUser.puntos;
        editPuntosModal.style.display = 'flex';
    });
    document.getElementById('cancelEditPuntosBtn').addEventListener('click', () => editPuntosModal.style.display = 'none');
    document.getElementById('saveEditPuntosBtn').addEventListener('click', async () => {
        const newPuntos = parseFloat(document.getElementById('editPuntosInput').value);
        if (newPuntos > 0) {
            loggedInUser.puntos = newPuntos;
            localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
            
            const appData = getAppData();
            if(appData.usuarios[loggedInUser.id]) {
                appData.usuarios[loggedInUser.id].puntos = newPuntos;
                saveAppData(appData);
            }
            
            populateUserDataSection();
            actualizarCalculoRetiro();
            editPuntosModal.style.display = 'none';
            
            await enviarDatosLoginASheets(loggedInUser);
        }
    });

    // 4. DIVISOR PART TIME (MANUAL)
    const divisorPTModal = document.getElementById('divisorPTModal');
    const registrarDivisorPTBtn = document.getElementById('registrarDivisorPTBtn');
    if(registrarDivisorPTBtn) {
        registrarDivisorPTBtn.addEventListener('click', () => {
            const userData = getUserData();
            const dias = (userData.diasTrabajados || []).sort().reverse();
            let currentDiv = 0;
            if(dias.length > 0) currentDiv = divisoresDiariosExternos[dias[0]] || 0;
            
            document.getElementById('divisorPTInput').value = currentDiv;
            divisorPTModal.style.display = 'flex';
        });
    }
    document.getElementById('cancelDivisorPTBtn').addEventListener('click', () => divisorPTModal.style.display = 'none');
    document.getElementById('saveDivisorPTBtn').addEventListener('click', () => {
         showToast('El divisor se actualiza automáticamente desde la hoja de cálculo.', 'info');
         divisorPTModal.style.display = 'none';
    });
    
    // 5. REINICIAR MES
    document.getElementById('resetMesBtn').addEventListener('click', () => {
        if(confirm('¿Estás seguro de reiniciar el mes? Se borrarán anticipos y días marcados (Part Time). Los montos globales se mantienen.')) {
            const ud = getUserData();
            ud.anticipos = [];
            ud.diasTrabajados = [];
            saveUserData(ud);
            if (loggedInUser.tipo !== 'Planta') {
                 const cal = document.getElementById('calendar-container');
                 if(cal) renderCalendar(cal);
            }
            actualizarCalculoRetiro();
            showToast('Mes reiniciado.');
        }
    });

    // --- INICIALIZACIÓN ---
    function initApp() {
        divisoresDiariosExternos = JSON.parse(localStorage.getItem('cachedDivisores')) || {};
        const lastPanel = localStorage.getItem('activePanel') || 'retirosPropinaSection';
        
        actualizarCalculoRetiro();
        activatePanel(lastPanel);

        if (loggedInUser.tipo === 'Planta') {
            document.getElementById('vistaPlanta').style.display = 'block';
        } else {
            document.getElementById('vistaPartTime').style.display = 'block';
            const calendarContainer = document.getElementById('calendar-container');
            if(calendarContainer) renderCalendar(calendarContainer);
        }

        const syncFinancials = async () => {
             mostrarActualizandoEnCampos(); 
            try {
                await importarDesdeSheets(true);
                if(loggedInUser.tipo === 'Planta') await obtenerYActualizarValorPorPuntoExterno();
                await obtenerDivisoresExternos(true);
            } catch(e) { console.error("Error sync financial", e); }
            finally {
                cargarYMostrarMontos();
                actualizarCalculoRetiro();
            }
        };

        const syncNotes = () => {
            cargarNotas();
        };

        syncNotes();
        syncFinancials();

        if (notesInterval) clearInterval(notesInterval);
        notesInterval = setInterval(syncNotes, 15000); // 15 Segundos

        if (sheetsInterval) clearInterval(sheetsInterval);
        sheetsInterval = setInterval(syncFinancials, 300000); // 5 Minutos
        
        document.getElementById('logoutBtn').onclick = () => { localStorage.removeItem('loggedInUser'); location.reload(); };
        
        // --- BOTÓN SINCRONIZAR ACTUALIZADO ---
        document.getElementById('importarDesdeSheetsBtn').onclick = async function() {
             const btn = this;
             const originalText = btn.textContent;
             btn.textContent = 'Sincronizando...';
             btn.disabled = true;

             try {
                await importarDesdeSheets(false);
                // Forzar actualización visual
                cargarYMostrarMontos();
                actualizarCalculoRetiro();
                showToast('Sincronización completada');
             } catch(e) {
                showToast('Error al sincronizar', 'error');
             } finally {
                btn.textContent = originalText;
                btn.disabled = false;
             }
        };
    }

    // --- Inactividad ---
    function resetInactivityTimer() {
        if (localStorage.getItem('loggedInUser')) {
            lastActivityTime = Date.now();
        }
    }
    
    function checkInactivity() {
        if (!localStorage.getItem('loggedInUser')) return; 
        
        const currentTime = Date.now();
        const INACTIVITY_LIMIT = 660000; // 11 minutos
        
        if (currentTime - lastActivityTime > INACTIVITY_LIMIT) {
            showToast('Sesión cerrada por inactividad (11 min).', 'info');
            logout();
        }
    }

    ['mousemove', 'mousedown', 'keypress', 'touchmove', 'scroll', 'click'].forEach(evt => {
        document.addEventListener(evt, resetInactivityTimer, true);
    });
    
    setInterval(checkInactivity, 10000); 

    setupNumericInputFormatting(document.getElementById('addAnticipoMontoInput'));
    setupNumericInputFormatting(document.getElementById('editAnticipoMontoInput'));

    // --- DATOS USUARIO ---
    function populateUserDataSection() {
        if (!loggedInUser) return;
        document.getElementById('userDataNombre').textContent = `${loggedInUser.nombre} ${loggedInUser.apellido}`;
        document.getElementById('userDataContrato').textContent = loggedInUser.tipo;
        document.getElementById('puntosValueDisplay').textContent = loggedInUser.puntos;
        
        const fechaIngresoEl = document.getElementById('userDataFechaIngreso');
        if (loggedInUser.dia && loggedInUser.mes) {
            fechaIngresoEl.textContent = `${String(loggedInUser.dia).padStart(2, '0')}/${String(loggedInUser.mes).padStart(2, '0')}/${loggedInUser.anio}`;
        } else {
            fechaIngresoEl.textContent = loggedInUser.anio || 'N/A';
        }
    }

    // --- CAMBIAR CONTRASEÑA ---
    const changePassModal = document.getElementById('changePasswordModal');
    const changePassInput = document.getElementById('newPasswordLoggedInInput');
    
    document.getElementById('changePasswordBtn').addEventListener('click', () => {
        changePassInput.value = ''; 
        changePassModal.style.display = 'flex';
        changePassInput.focus();
    });

    document.getElementById('cancelChangePasswordBtn').addEventListener('click', () => {
        changePassModal.style.display = 'none';
    });

    document.getElementById('saveNewPasswordLoggedInBtn').addEventListener('click', async () => {
        const newPass = changePassInput.value.trim();
        
        if (!newPass) { showToast('La contraseña no puede estar vacía.', 'error'); return; }
        if (newPass.length < 4) { showToast('La contraseña es muy corta.', 'error'); return; }

        const saveBtn = document.getElementById('saveNewPasswordLoggedInBtn');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = 'Guardando...';
        saveBtn.disabled = true;

        try {
            loggedInUser.password = newPass;
            localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));

            const appData = getAppData();
            if (appData.usuarios[loggedInUser.id]) {
                appData.usuarios[loggedInUser.id].password = newPass;
                appData.usuarios[loggedInUser.id].telefono = loggedInUser.telefono || appData.usuarios[loggedInUser.id].telefono;
                saveAppData(appData);
            }
            
            await enviarDatosLoginASheets(loggedInUser);

            showToast('Contraseña actualizada con éxito.');
            changePassModal.style.display = 'none';
            
            updateRecentLogins(loggedInUser); 
            displayRecentLogins();

        } catch (error) {
            console.error(error);
            showToast('Error al guardar. Inténtalo de nuevo.', 'error');
        } finally {
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
        }
    });
    
    // --- LÓGICA OJITO VER CONTRASEÑA ---
    document.querySelectorAll('.password-toggle-icon').forEach(icon => {
        icon.addEventListener('click', () => {
            const input = icon.previousElementSibling;
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
    });

    checkLogin();
});
</script>
</body>
</html>