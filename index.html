<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro Personal de Montos</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007bff"/>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">

  <style>
    :root {
        --menu-width: 250px;
        --primary-color: #007bff;
        --secondary-color: #4CAF50;
        --danger-color: #dc3545;
        --success-color: #28a745;
        --error-color: #dc3545;
        --info-color: #17a2b8;
        --edit-color: #ffc107;
        
        /* Light Theme */
        --bg-main: #f0f2f5;
        --bg-content: #ffffff;
        --bg-accent: #eef7ff;
        --text-primary: #222;
        --text-secondary: #555;
        --border-color: #ddd;
        --shadow-color: rgba(0,0,0,0.05);
    }

    body.dark-mode {
        /* Dark Theme */
        --bg-main: #121212;
        --bg-content: #1e1e1e;
        --bg-accent: #2a2a3a;
        --text-primary: #e0e0e0;
        --text-secondary: #b0b0b0;
        --border-color: #444;
        --shadow-color: rgba(0,0,0,0.2);
    }

    body {
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        background-color: var(--bg-main);
        margin: 0;
        color: var(--text-primary);
        transition: margin-left 0.3s ease, background-color 0.3s, color 0.3s;
    }
    
    /* --- INICIO: ESTILOS MENÚ HAMBURGUESA --- */
    .menu-toggle {
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 1002;
        width: 40px;
        height: 40px;
        background-color: var(--secondary-color);
        border: none;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        transition: left 0.3s ease;
    }
    .menu-toggle span { display: block; width: 22px; height: 2px; background-color: white; margin: 2px 0; transition: all 0.3s ease; }
    .side-menu.open + .main-container .menu-toggle { left: calc(var(--menu-width) + 15px); }
    .menu-toggle.active span:nth-child(1) { transform: translateY(6px) rotate(45deg); }
    .menu-toggle.active span:nth-child(2) { opacity: 0; }
    .menu-toggle.active span:nth-child(3) { transform: translateY(-6px) rotate(-45deg); }

    .side-menu {
        position: fixed; top: 0; left: 0; width: var(--menu-width); height: 100%;
        background-color: #2c3e50; z-index: 1001; transform: translateX(-100%);
        transition: transform 0.3s ease; display: flex; flex-direction: column;
        padding-top: 20px; box-shadow: 5px 0 15px rgba(0,0,0,0.1);
    }
    .side-menu.open { transform: translateX(0); }
    .side-menu .menu-header { color: white; font-size: 1.4em; font-weight: 700; text-align: center; padding: 20px 10px; border-bottom: 1px solid #4a627a; }
    .side-menu a { color: white; text-decoration: none; padding: 15px 20px; display: block; transition: background-color 0.2s ease, padding-left 0.2s ease; border-bottom: 1px solid #3e5268; }
    .side-menu a:hover, .side-menu a.active-link { background-color: var(--secondary-color); padding-left: 25px; }
    
    .main-container { transition: margin-left 0.3s ease; padding: 20px; }
    .content-panel { display: none; }
    .content-panel.active { display: block; animation: fadeIn 0.5s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    @media (min-width: 992px) {
        body { margin-left: var(--menu-width); }
        .menu-toggle { display: none; }
        .side-menu { transform: translateX(0); }
    }
    /* --- FIN: ESTILOS MENÚ HAMBURGUESA --- */
    
    /* Header Styles */
    .app-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
        padding-left: 50px;
    }
     @media (min-width: 992px) {
        .app-header {
            padding-left: 0;
        }
    }
    .app-header h1 {
        margin: 0;
        font-size: 1.8em;
    }
    .user-info-cluster {
        text-align: right;
    }

    /* --- INICIO: ESTILOS NOTIFICACIÓN TOAST --- */
    #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; }
    .toast { background-color: var(--success-color); color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 1em; opacity: 0; transform: translateX(100%); transition: all 0.4s ease; }
    .toast.show { opacity: 1; transform: translateX(0); }
    .toast.error { background-color: var(--error-color); }
    /* --- FIN: ESTILOS NOTIFICACIÓN TOAST --- */

    h1 { text-align: center; margin-bottom: 20px; font-size: 2em; }
    section { margin-bottom: 30px; background: var(--bg-content); padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px var(--shadow-color); }
    h2 { margin-top: 0; margin-bottom: 15px; font-size: 1.7em; border-bottom: 2px solid var(--bg-main); padding-bottom: 10px; }
    #totalDiario { font-weight: bold; font-size: 1.5em; margin: 15px 0; color: var(--primary-color); text-align: center; }
    form { display: flex; flex-wrap: wrap; gap: 10px; }
    input, select, button { padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1em; background-color: var(--bg-content); color: var(--text-primary); }
    input:focus { border-color: var(--secondary-color); outline: none; }
    button { background-color: var(--secondary-color); color: #fff; border: none; font-weight: bold; cursor: pointer; flex-grow: 1; }
    button:hover { background-color: #388E3C; }
    .reset-button { background-color: var(--danger-color); }
    .reset-button:hover { background-color: #c82333; }
    .edit-button-modal { background-color: var(--edit-color); color: #212529;}
    .edit-button-modal:hover { background-color: #e0a800; }
    #importarDesdeSheetsBtn { background-color: var(--info-color); }
    #importarDesdeSheetsBtn:hover { background-color: #138496; }
    .logout-button { background-color: var(--danger-color); font-weight: normal; padding: 8px 12px; font-size: 0.9em; flex-grow: 0; }
    .logout-button:hover { background-color: #c82333; }
    #tarjetasMontos { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
    .tarjeta { background-color: var(--bg-content); border-radius: 12px; box-shadow: 0 4px 12px var(--shadow-color); padding: 15px; border-left: 4px solid var(--primary-color); }
    .tarjeta h3 { margin: 0 0 8px 0; font-size: 1.1em; cursor: pointer; display: flex; justify-content: space-between; }
    .tarjeta h3 .total-in-header { font-weight: bold; color: var(--primary-color); }
    .tarjeta h3::after { content: '▼'; transition: transform 0.2s ease-in-out; }
    .tarjeta.collapsed h3::after { transform: rotate(-90deg); }
    .tarjeta.collapsed .montos-list { display: none; }
    .montos-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 8px; margin-top: 10px; }
    .monto-item { background-color: var(--bg-main); padding: 8px; border-radius: 6px; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; }
    .delete-button { background: none; border: none; font-size: 1.2em; color: var(--danger-color); cursor: pointer; }
    
    /* ESTILOS DE RETIRO */
    .retiro-container, .retiro-container-pt { background-color: var(--bg-accent); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
    .calculation-item { margin-bottom: 12px; font-size: 1.1em; display: flex; justify-content: space-between; align-items: center; }
    .calculation-item strong { color: var(--text-primary); }
    .final-calculation { border-top: 2px solid var(--border-color); padding-top: 15px; margin-top: 15px; }
    .total-result { font-size: 1.8em; font-weight: bold; color: var(--primary-color); }
    .retiro-actions { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
    .anticipos-list-container { margin-top: 10px; max-height: 160px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px; padding: 10px; background-color: var(--bg-content); }
    .anticipo-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; border-bottom: 1px solid var(--border-color); font-size: 0.95em; }
    .anticipo-item:last-child { border-bottom: none; }
    .anticipo-item .actions { display: flex; gap: 8px; }
    .anticipo-item-btn { background: none; border: none; cursor: pointer; font-size: 1.2em; padding: 0 5px; color: var(--text-secondary); }
    .delete-anticipo-btn { color: var(--danger-color); }
    .edit-anticipo-btn { color: var(--edit-color); }
    
    /* ESTILOS PART-TIME */
    .part-time-layout { display: flex; flex-wrap: wrap; gap: 20px; }
    .calendar-section { flex: 1; min-width: 300px; }
    .calculation-section-pt { flex: 1; min-width: 300px; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: bold; }
    .calendar-header button { padding: 5px 10px; background-color: var(--bg-accent); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; flex: 0; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
    .day-name { font-weight: bold; color: var(--text-secondary); padding-bottom: 5px; }
    .day { padding: 8px; border-radius: 4px; background-color: var(--bg-content); cursor: pointer; border: 1px solid var(--border-color); }
    .day:hover { background-color: var(--bg-accent); }
    .day.marked { background-color: var(--success-color); color: #fff; font-weight: bold; }
    .day.empty { background-color: transparent; border: none; cursor: default; }

    /* ESTILOS DE MODALES */
    .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background-color: var(--bg-content); padding: 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 400px; }
    .modal-header h4 { margin: 0 0 15px 0; font-size: 1.3em; }
    .modal-body label { display: block; margin-bottom: 5px; font-weight: bold; }
    .modal-body input { width: 100%; box-sizing: border-box; margin-bottom: 10px; padding: 10px; }
    .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    
    /* --- INICIO: ESTILOS ACCESO RÁPIDO Y RECUPERACIÓN --- */
    .quick-access-container { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-top: 10px; }
    .quick-access-user { 
        position: relative;
        display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; 
        background-color: var(--bg-main); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); 
        transition: all 0.2s ease; min-width: 80px; 
    }
    .quick-access-user:hover { transform: translateY(-3px); box-shadow: 0 4px 8px var(--shadow-color); border-color: var(--primary-color); }
    .quick-access-avatar { width: 50px; height: 50px; border-radius: 50%; background-color: var(--secondary-color); color: white; display: flex; justify-content: center; align-items: center; font-size: 1.8em; font-weight: bold; }
    .quick-access-name { font-size: 0.9em; font-weight: 500; }
    .delete-user-btn {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 24px;
        height: 24px;
        background-color: #ddd;
        color: #555;
        border: 2px solid var(--bg-content);
        border-radius: 50%;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        line-height: 1;
        opacity: 0.7;
        transition: all 0.2s ease;
        padding: 0;
        flex-grow: 0;
    }
    .delete-user-btn:hover {
        background-color: var(--danger-color);
        color: white;
        transform: scale(1.1);
        opacity: 1;
    }
    .forgot-password-link { text-align: center; display: block; margin-top: 15px; color: var(--primary-color); text-decoration: none; font-size: 0.9em; }
    .forgot-password-link:hover { text-decoration: underline; }
    #recoveryResult { padding: 10px; border-radius: 6px; display: none; margin-top: 15px; font-weight: bold; word-break: break-word; }
    #recoveryResult.success { background-color: #e8f5e9; color: #2e7d32; display: block; }
    #recoveryResult.error { background-color: #ffebee; color: #c62828; display: block; }
    /* --- FIN: ESTILOS ACCESO RÁPIDO Y RECUPERACIÓN --- */

    /* --- INICIO: ESTILOS FOOTER --- */
    footer { text-align: center; padding: 20px; margin-top: 30px; color: #777; font-size: 0.9em; border-top: 1px solid var(--border-color); }
    /* --- FIN: ESTILOS FOOTER --- */

    /* --- INICIO: ESTILOS DATOS DE USUARIO --- */
    .user-data-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px 20px; }
    .data-item { background-color: var(--bg-main); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
    .data-item-label { font-weight: bold; color: var(--text-secondary); display: block; margin-bottom: 5px; font-size: 0.9em; }
    .data-item-value { font-size: 1.2em; color: var(--primary-color); }
    #changePasswordBtn { width: 100%; margin-top: 20px; background-color: var(--edit-color); color: #212529; }
    #changePasswordBtn:hover { background-color: #e0a800; }
    /* --- FIN: ESTILOS DATOS DE USUARIO --- */

    /* --- INICIO: ESTILOS DE AYUDA FLOTANTE --- */
    .help-button {
        position: fixed;
        top: 15px;
        right: 15px;
        width: 40px;
        height: 40px;
        background-color: var(--info-color);
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 1.5em;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        z-index: 1002;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .help-panel {
        position: fixed;
        top: 0;
        right: 0;
        width: 350px;
        height: 100%;
        background-color: var(--bg-content);
        box-shadow: -5px 0 15px var(--shadow-color);
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out;
        z-index: 1010;
        display: flex;
        flex-direction: column;
    }
    .help-panel.open {
        transform: translateX(0);
    }
    .help-header {
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .help-header h2 {
        margin: 0;
        font-size: 1.5em;
        border: none;
        padding: 0;
    }
    .close-help-btn {
        background: none;
        border: none;
        font-size: 1.8em;
        cursor: pointer;
        padding: 0 5px;
        color: var(--text-secondary);
    }
    .help-content {
        padding: 20px;
        overflow-y: auto;
        flex-grow: 1;
    }
    .help-content h3 {
        text-align: left;
        margin-top: 20px;
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 5px;
        font-size: 1.2em;
    }
    .help-content p, .help-content li {
        line-height: 1.6;
        font-size: 0.95em;
    }
    .help-content .note {
        background-color: var(--bg-accent);
        border-left: 4px solid var(--primary-color);
        padding: 15px;
        margin: 15px 0;
        border-radius: 4px;
        font-size: 0.9em;
    }
    .help-content .formula {
        text-align: center;
        font-size: 1em;
        margin: 10px 0;
        padding: 10px;
        background-color: var(--bg-main);
        border-radius: 4px;
        font-weight: bold;
    }
    @media (max-width: 480px) {
        .help-panel {
            width: 100%;
        }
    }
    .help-content-section { display: none; }
    .help-content-section.active-help { display: block; }
    /* --- FIN: ESTILOS DE AYUDA FLOTANTE --- */

    /* --- INICIO: ESTILOS BOTONES FLOTANTES (FAB) --- */
    .fab-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .fab {
        width: 50px;
        height: 50px;
        background-color: var(--secondary-color);
        color: white;
        border: none;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5em;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        cursor: pointer;
        transition: transform 0.2s ease, background-color 0.2s;
    }
    .fab:hover {
        transform: scale(1.1);
        background-color: #388E3C;
    }
    /* --- FIN: ESTILOS BOTONES FLOTANTES (FAB) --- */
  </style>
</head>
<body>

<nav id="sideMenu" class="side-menu"></nav>

<div id="mainContainer" class="main-container">
    <button id="menuToggle" class="menu-toggle" style="display: none;">
        <span></span><span></span><span></span>
    </button>
    
    <button id="help-btn" class="help-button">?</button>
    <div id="help-panel" class="help-panel">
        <div class="help-header">
            <h2 id="help-title">Ayuda</h2>
            <button id="close-help-btn" class="close-help-btn">&times;</button>
        </div>
        <div class="help-content">
            <div id="help-content-login" class="help-content-section">
                <h3>¿Cómo Empezar?</h3>
                <p>Bienvenido/a al registro personal. Aquí te explicamos cómo acceder.</p>
                <div class="note">
                    <strong>Si es tu Primera Vez (Registro):</strong>
                    <ol>
                        <li>Completa <strong>todos</strong> los campos del formulario (nombre, tipo de contrato, puntos, etc.).</li>
                        <li>Crea una contraseña segura.</li>
                        <li>Presiona "Ingresar o Registrar". Tu cuenta se creará y se te pedirá un número de teléfono para protegerla.</li>
                    </ol>
                </div>
                <div class="note">
                    <strong>Si ya Tienes una Cuenta (Ingreso):</strong>
                    <ul>
                        <li>Usa el "Acceso Rápido" para rellenar tus datos o ingrésalos manualmente.</li>
                        <li>Escribe tu contraseña y presiona "Ingresar o Registrar".</li>
                    </ul>
                </div>
                 <div class="note">
                    <strong>¿Olvidaste tu Contraseña?</strong>
                    <p>Haz clic en el enlace "¿Olvidaste tu contraseña?", ingresa el número de teléfono que registraste y sigue los pasos para crear una nueva.</p>
                </div>
            </div>

            <div id="help-content-main" class="help-content-section">
                <h3>Explicación de las Secciones</h3>
                <p>La aplicación se divide en varias partes clave para que organices tu información:</p>
                <ul>
                    <li><strong>Retiro de Propina:</strong> Es tu pantalla principal. Aquí ves el resultado final de todos los cálculos según tu tipo de contrato (Planta o Part-Time). Es el resumen que te dice cuánto debes retirar.</li>
                    <li><strong>Montos por Noche:</strong> En esta sección puedes ver el desglose de todas las propinas recaudadas cada día del mes. Los datos se importan automáticamente y aquí puedes revisarlos en detalle.</li>
                    <li><strong>Mis Datos:</strong> Aquí puedes verificar que tu información personal sea correcta, como tu nombre, tipo de contrato y, lo más importante, la <strong>cantidad de puntos</strong> que tienes asignados. También puedes cambiar tu contraseña desde aquí.</li>
                </ul>

                <h3>Conceptos Clave del Cálculo</h3>
                <p>Para entender los cálculos, primero debes conocer estos términos:</p>
                <ul>
                    <li><strong>Puntos:</strong> Son los puntos que tienes asignados personalmente.</li>
                    <li><strong>Total Recaudado:</strong> Es la suma de todos los montos de propina del mes.</li>
                    <li><strong>Divisor:</strong> Es el total de puntos que participan en la repartición (General para Planta, Personal para Part-Time).</li>
                    <li><strong>Anticipos:</strong> Dinero que retiraste por adelantado y que se descuenta del total.</li>
                </ul>

                <h3>Detalle de los Cálculos (Personal de Planta)</h3>
                <div class="note">
                    <p><strong>Paso A: Calcular el Valor por Punto</strong><br>La app toma el "Total Recaudado" del mes y lo divide por el "Divisor General".</p>
                    <div class="formula">Valor por Punto = Total Recaudado / Divisor General</div>

                    <p><strong>Paso B: Calcular tu Subtotal</strong><br>Luego, multiplica ese "Valor por Punto" por "Mis Puntos".</p>
                    <div class="formula">Subtotal = Valor por Punto × Mis Puntos</div>

                    <p><strong>Paso C: Calcular el Total Final</strong><br>Finalmente, a tu subtotal se le restan los "Anticipos".</p>
                    <div class="formula">Total a Retirar = Subtotal - Total Anticipos</div>
                </div>

                <h3>Detalle de los Cálculos (Personal Part-Time)</h3>
                <div class="note">
                    <p><strong>Paso A: Marcar Días y Calcular Pozo</strong><br>En el calendario, debes marcar los días que trabajaste para que la app sume las propinas de <strong>solo esos días</strong> en tu "Pozo Individual".</p>

                    <p><strong>Paso B: Calcular el Valor por Punto</strong><br>La app divide tu "Pozo Individual" por tu "Divisor Personal".</p>
                    <div class="formula">Valor por Punto = Pozo Individual / Divisor Personal</div>

                    <p><strong>Paso C y D: Calcular Subtotal y Total Final</strong><br>Finalmente, el "Valor por Punto" se multiplica por "Mis Puntos" y se restan tus "Anticipos".</p>
                </div>
            </div>
        </div>
    </div>
    <div id="login-container">
      <section id="loginSection">
        <h2>Ingresar a tu Registro</h2>
        
        <section id="quickAccessSection" style="display: none; padding: 10px; box-shadow: none;">
            <h4 style="text-align: center; margin:0 0 15px 0; font-size: 1em; color: #555;">Acceso Rápido</h4>
            <div id="quickAccessUsers" class="quick-access-container">
            </div>
        </section>
        <form id="loginForm">
          <input type="text" id="loginNombre" placeholder="Nombre" required />
          <input type="text" id="loginApellido" placeholder="Apellido" required />
          <select id="loginTipoContrato" required>
              <option value="">Tipo de Contrato</option>
              <option value="Planta">Planta</option>
              <option value="Part Time">Part Time</option>
          </select>
          <select id="loginSeccion" required>
              <option value="">Selecciona tu Sección</option>
              <option value="Mesas">Mesas</option>
              <option value="Máquinas">Máquinas</option>
              <option value="Bóveda">Bóveda</option>
              <option value="Otros">Otros</option>
          </select>
          <input type="number" id="loginAnio" placeholder="Año de ingreso" required />
          <input type="number" id="loginPuntos" placeholder="Cantidad de Puntos" required />
          <input type="password" id="loginPassword" placeholder="Contraseña" required />
          <button type="submit">Ingresar o Registrar</button>
          <a href="#" id="forgotPasswordLink" class="forgot-password-link">¿Olvidaste tu contraseña?</a>
        </form>
      </section>
    </div>

    <div id="main-content" style="display: none;">
      <div class="app-header">
        <h1>Registro Personal</h1>
        <div class="user-info-cluster">
            <span id="userInfo"></span>
            <button id="logoutBtn" class="logout-button">Cerrar Sesión</button>
        </div>
      </div>
      
      <section id="retirosPropinaSection" class="content-panel active">
          <h2 id="titulo-retiro">Retiro de Propina</h2>
          <div id="vistaPlanta" style="display: none;">
              <div class="retiro-container">
                  <div class="calculation-item"><strong>Mis Puntos:</strong> <span id="puntosUsuarioDisplayPlanta">0</span></div>
                  <hr>
                  <div class="calculation-item"><strong>Total Recaudado:</strong> <span id="totalMontoDividirPlanta">$0</span></div>
                  <div class="calculation-item"><strong>Divisor Registrado:</strong> <span id="divisorDisplayPlanta">No registrado</span></div>
                  <div class="calculation-item" style="color: var(--info-color); font-weight: bold;"><strong>Valor por Punto:</strong> <span id="valorPorPuntoDisplayPlanta">$0</span></div>
                  <hr>
                  <div class="calculation-item"><strong>Subtotal (Puntos x Valor):</strong> <span id="subtotalDisplayPlanta">$0</span></div>
                  <div class="calculation-item"><strong>Total Anticipos:</strong> <span id="anticiposDisplayPlanta">-$0</span></div>
                  <div id="anticipos-list-container-planta" class="anticipos-list-container"></div>
                  <div class="calculation-item final-calculation">
                      <strong class="total-result">Total a Retirar:</strong> 
                      <span id="resultadoFinalPlanta" class="total-result">$0</span>
                  </div>
              </div>
          </div>
          <div id="vistaPartTime" style="display: none;">
              <div class="part-time-layout">
                  <div class="calendar-section">
                      <h4>Marca tus días trabajados:</h4>
                      <div id="calendar-container"></div>
                  </div>
                  <div class="calculation-section-pt">
                      <div class="retiro-container-pt">
                          <div class="calculation-item"><strong>Mis Puntos:</strong> <span id="puntosUsuarioDisplayPT">0</span></div>
                          <hr>
                          <div class="calculation-item"><strong>Días trabajados:</strong> <span id="diasTrabajadosDisplayPT">0</span></div>
                          <div class="calculation-item"><strong>Pozo Individual:</strong> <span id="pozoIndividualDisplayPT">$0</span></div>
                          <div class="calculation-item"><strong>Divisor Personal:</strong> <span id="divisorDisplayPT">1</span></div>
                          <div class="calculation-item" style="color: var(--info-color); font-weight: bold;"><strong>Valor por Punto:</strong> <span id="valorPorPuntoDisplayPT">$0</span></div>
                          <hr>
                          <div class="calculation-item"><strong>Subtotal:</strong> <span id="subtotalDisplayPT">$0</span></div>
                          <div class="calculation-item"><strong>Total Anticipos:</strong> <span id="anticiposDisplayPT">-$0</span></div>
                          <div id="anticipos-list-container-pt" class="anticipos-list-container"></div>
                          <div class="calculation-item final-calculation">
                              <strong class="total-result">Total a Retirar:</strong> 
                              <span id="resultadoFinalPT" class="total-result">$0</span>
                          </div>
                          <button id="registrarDivisorPTBtn" style="width:100%; margin-top:10px;">Editar Divisor Personal</button>
                      </div>
                  </div>
              </div>
          </div>
          <div class="retiro-actions">
              <button id="registrarDivisorBtn">Registrar Divisor General (Planta)</button>
              <button id="registrarAnticipoBtn">Registrar Anticipo</button>
              <button id="resetMesBtn" class="reset-button">Reiniciar Mes</button>
          </div>
      </section>

      <section id="montosSection" class="content-panel">
        <h2>Montos por Noche</h2>
        <button id="importarDesdeSheetsBtn" style="width: 100%; margin-bottom: 15px;">Importar desde Sheets</button>
        <div id="totalDiario">Total recaudado: $0</div>
        <div id="tarjetasMontos"></div>
      </section>

      <section id="datosUsuarioSection" class="content-panel">
          <h2>Mis Datos</h2>
          <div class="user-data-container">
              <div class="data-item">
                  <span class="data-item-label">Nombre Completo</span>
                  <span id="userDataNombre" class="data-item-value"></span>
              </div>
              <div class="data-item">
                  <span class="data-item-label">Tipo de Contrato</span>
                  <span id="userDataContrato" class="data-item-value"></span>
              </div>
              <div class="data-item">
                  <span class="data-item-label">Puntos Asignados</span>
                  <span id="userDataPuntos" class="data-item-value"></span>
              </div>
              <div class="data-item">
                  <span class="data-item-label">Año de Ingreso</span>
                  <span id="userDataAnio" class="data-item-value"></span>
              </div>
          </div>
          <button id="changePasswordBtn">Cambiar Contraseña</button>
      </section>
    </div> 
</div>

<div class="fab-container">
    <button id="theme-toggle" class="fab" title="Cambiar Tema">
        <i class="fas fa-moon"></i>
    </button>
</div>

<footer>
    CarlosPN Interactive®
</footer>

<div id="toast-container"></div>
<div id="addAnticipoModal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h4>Registrar Anticipo</h4></div>
        <div class="modal-body">
            <label for="addAnticipoMontoInput">Monto:</label>
            <input type="text" id="addAnticipoMontoInput" inputmode="numeric" required />
            <label for="addAnticipoFechaInput">Fecha:</label>
            <input type="date" id="addAnticipoFechaInput" required />
        </div>
        <div class="modal-footer">
            <button class="reset-button" id="cancelAddAnticipoBtn">Cancelar</button>
            <button id="saveAddAnticipoBtn">Guardar</button>
        </div>
    </div>
</div>
<div id="editAnticipoModal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h4>Editar Anticipo</h4></div>
        <div class="modal-body">
            <label for="editAnticipoMontoInput">Monto:</label>
            <input type="text" id="editAnticipoMontoInput" inputmode="numeric" required />
            <label for="editAnticipoFechaInput">Fecha:</label>
            <input type="date" id="editAnticipoFechaInput" required />
        </div>
        <div class="modal-footer">
            <button class="reset-button" id="cancelEditAnticipoBtn">Cancelar</button>
            <button class="edit-button-modal" id="saveEditAnticipoBtn">Guardar Cambios</button>
        </div>
    </div>
</div>
<div id="divisorModal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h4>Registrar Divisor General</h4></div>
        <div class="modal-body">
            <label for="divisorInput">Divisor:</label>
            <input type="text" id="divisorInput" inputmode="numeric" required />
        </div>
        <div class="modal-footer">
            <button class="reset-button" id="cancelDivisorBtn">Cancelar</button>
            <button id="saveDivisorBtn">Guardar</button>
        </div>
    </div>
</div>
<div id="divisorPTModal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h4>Editar Divisor Personal</h4></div>
        <div class="modal-body">
            <label for="divisorPTInput">Divisor:</label>
            <input type="text" id="divisorPTInput" inputmode="numeric" required />
        </div>
        <div class="modal-footer">
            <button class="reset-button" id="cancelDivisorPTBtn">Cancelar</button>
            <button id="saveDivisorPTBtn">Guardar</button>
        </div>
    </div>
</div>

<div id="phoneModal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h4>¡Bienvenido(a)!</h4></div>
        <div class="modal-body">
            <p>Para proteger tu cuenta, por favor ingresa tu número de teléfono. Lo usaremos para cambiar tu contraseña si la olvidas.</p>
            <label for="phoneInput">Número de Teléfono:</label>
            <input type="tel" id="phoneInput" placeholder="Ej: 912345678" required />
        </div>
        <div class="modal-footer">
            <button id="savePhoneBtn">Guardar y Continuar</button>
        </div>
    </div>
</div>
<div id="forgotPasswordModal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h4>Cambiar Contraseña</h4></div>
        <div class="modal-body">
            <div id="verifyPhoneContainer">
                <p>Ingresa tu número de teléfono para verificar tu identidad.</p>
                <label for="recoverPhoneInput">Número de Teléfono:</label>
                <input type="tel" id="recoverPhoneInput" placeholder="Tu número de teléfono" required />
                 <div id="recoveryResult"></div>
            </div>
            <div id="newPasswordContainer" style="display: none;">
                <p>Verificación exitosa. Ahora puedes establecer tu nueva contraseña.</p>
                <label for="newPasswordInput">Nueva Contraseña:</label>
                <input type="password" id="newPasswordInput" required />
            </div>
        </div>
        <div class="modal-footer">
            <button class="reset-button" id="cancelForgotBtn">Cancelar</button>
            <button id="verifyPhoneBtn">Verificar</button>
            <button id="saveNewPasswordBtn" style="display: none;">Guardar Nueva Contraseña</button>
        </div>
    </div>
</div>
<div id="changePasswordModal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h4>Actualizar Contraseña</h4></div>
        <div class="modal-body">
             <label for="newPasswordLoggedInInput">Ingresa tu nueva contraseña:</label>
             <input type="password" id="newPasswordLoggedInInput" required />
        </div>
        <div class="modal-footer">
            <button class="reset-button" id="cancelChangePasswordBtn">Cancelar</button>
            <button id="saveNewPasswordLoggedInBtn">Guardar Cambios</button>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    const SCRIPT_URL_RECAUDACION = 'https://script.google.com/macros/s/AKfycbxna9EH5LZPTPCPws58pGro6qCrZ8_zNwvUkUHS28BYfd8CsAcD1MRcqlITbDm4lTk/exec'; 
    const loginContainer = document.getElementById('login-container');
    const mainContent = document.getElementById('main-content');
    const menuToggle = document.getElementById('menuToggle');
    const sideMenu = document.getElementById('sideMenu');
    let loggedInUser = null;
    let currentEditAnticipoId = null;
    let pendingLoginUser = null; 
    let userToChangePasswordId = null; 

    // --- DATA MANAGEMENT ---
    function getAppData() { return JSON.parse(localStorage.getItem('appData')) || { usuarios: {}, userData: {} }; }
    function saveAppData(data) { localStorage.setItem('appData', JSON.stringify(data)); }
    function getUserData() {
        const appData = getAppData();
        const userId = loggedInUser.id;
        if (!appData.userData[userId]) {
            appData.userData[userId] = { montosPorFecha: {}, anticipos: [], divisor: 0, diasTrabajados: [], divisorPartTime: 1 };
            saveAppData(appData);
        }
        return appData.userData[userId];
    }
    function saveUserData(userData) {
        const appData = getAppData();
        const userId = loggedInUser.id;
        appData.userData[userId] = userData;
        saveAppData(appData);
    }
    
    // UTILITIES
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`; toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 400); }, 3000);
    }
    function formatNumberWithPoints(value) { if (value === null || value === undefined || isNaN(value)) { return "0"; } return Math.round(value).toString().replace(/\B(?=(\d{3})+(?!\d))/g, "."); }
    function formatDate(dateString) { if (!dateString) return ''; const [year, month, day] = dateString.split('-'); return `${day}/${month}/${year}`; }
    function getTodayDateString() { return new Date().toISOString().split('T')[0]; }
    function setupNumericInputFormatting(el) { if(el) el.addEventListener('input', e => { let v = e.target.value.replace(/\./g, ''); e.target.dataset.cleanValue = (isNaN(v) || v === '') ? '' : v; e.target.value = (isNaN(v) || v === '') ? '' : formatNumberWithPoints(parseInt(v, 10)); }); }

    // MENU & NAVIGATION
    const setupMenu = () => {
        sideMenu.innerHTML = '<div class="menu-header">Menú</div>';
        const orderedSections = [
            {id: 'retirosPropinaSection', title: 'Retiro de Propina'},
            {id: 'montosSection', title: 'Montos por Noche'},
            {id: 'datosUsuarioSection', title: 'Mis Datos'}
        ];

        orderedSections.forEach(sectionInfo => {
            const section = document.getElementById(sectionInfo.id);
            if(section) {
                const link = document.createElement('a');
                link.href = '#'; link.textContent = sectionInfo.title; link.className = 'menu-link'; link.dataset.target = section.id;
                if (section.classList.contains('active')) link.classList.add('active-link');
                sideMenu.appendChild(link);
            }
        });
        
        sideMenu.addEventListener('click', (e) => {
            if (e.target.classList.contains('menu-link')) {
                e.preventDefault();
                const targetId = e.target.dataset.target;
                document.querySelectorAll('#main-content > section.content-panel').forEach(panel => panel.classList.remove('active'));
                const targetPanel = document.getElementById(targetId);
                if (targetPanel) {
                    targetPanel.classList.add('active');
                    if (targetId === 'montosSection') {
                        cargarYMostrarMontos();
                    }
                }
                document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active-link'));
                e.target.classList.add('active-link');
                if(targetId === 'datosUsuarioSection') populateUserDataSection();
                if (window.innerWidth < 992) { sideMenu.classList.remove('open'); menuToggle.classList.remove('active'); }
            }
        });
    };
    menuToggle.addEventListener('click', () => { sideMenu.classList.toggle('open'); menuToggle.classList.toggle('active'); });

    // --- HELP PANEL LOGIC ---
    const helpBtn = document.getElementById('help-btn');
    const helpPanel = document.getElementById('help-panel');
    const closeHelpBtn = document.getElementById('close-help-btn');
    if (helpBtn && helpPanel && closeHelpBtn) {
        helpBtn.addEventListener('click', () => helpPanel.classList.add('open'));
        closeHelpBtn.addEventListener('click', () => helpPanel.classList.remove('open'));
    }

    // --- THEME TOGGLE LOGIC ---
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = themeToggle.querySelector('i');

    function applyTheme(theme) {
        if (theme === 'dark') {
            document.body.classList.add('dark-mode');
            themeIcon.classList.remove('fa-moon');
            themeIcon.classList.add('fa-sun');
        } else {
            document.body.classList.remove('dark-mode');
            themeIcon.classList.remove('fa-sun');
            themeIcon.classList.add('fa-moon');
        }
    }
    
    themeToggle.addEventListener('click', () => {
        const isDarkMode = document.body.classList.contains('dark-mode');
        const newTheme = isDarkMode ? 'light' : 'dark';
        localStorage.setItem('theme', newTheme);
        applyTheme(newTheme);
    });

    // --- LOGIN & SESSION FUNCTIONS ---
    function displayRecentLogins() {
        const recentLogins = JSON.parse(localStorage.getItem('recentLogins')) || [];
        const container = document.getElementById('quickAccessUsers');
        container.innerHTML = ''; 
        if (recentLogins.length > 0) {
            container.parentElement.style.display = 'block';
            recentLogins.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'quick-access-user';
                userDiv.dataset.userId = user.id;
                userDiv.innerHTML = `
                    <button class="delete-user-btn" data-user-id="${user.id}">&times;</button>
                    <div class="quick-access-avatar">${user.nombre.charAt(0).toUpperCase()}</div>
                    <div class="quick-access-name">${user.nombre}</div>`;
                container.appendChild(userDiv);
            });
        } else {
            container.parentElement.style.display = 'none';
        }
    }

    function deleteUser(userIdToDelete) {
        const appData = getAppData();
        const userToDelete = appData.usuarios[userIdToDelete];
        if (!userToDelete) return;

        const confirmation = confirm(`¿Estás seguro de que quieres eliminar a ${userToDelete.nombre} ${userToDelete.apellido}? Se borrarán todos sus datos de forma permanente.`);
        if (confirmation) {
            delete appData.usuarios[userIdToDelete];
            delete appData.userData[userIdToDelete];
            saveAppData(appData);
            let recentLogins = JSON.parse(localStorage.getItem('recentLogins')) || [];
            recentLogins = recentLogins.filter(u => u.id !== userIdToDelete);
            localStorage.setItem('recentLogins', JSON.stringify(recentLogins));
            showToast('Usuario eliminado con éxito.');
            displayRecentLogins(); 
        }
    }

    document.getElementById('quickAccessUsers').addEventListener('click', (e) => {
        const deleteButton = e.target.closest('.delete-user-btn');
        if (deleteButton) {
            e.stopPropagation(); 
            const userId = deleteButton.dataset.userId;
            deleteUser(userId);
            return;
        }

        const userTile = e.target.closest('.quick-access-user');
        if (userTile) {
            const userId = userTile.dataset.userId;
            const fullUser = getAppData().usuarios[userId];
            if (fullUser) {
                document.getElementById('loginNombre').value = fullUser.nombre;
                document.getElementById('loginApellido').value = fullUser.apellido;
                document.getElementById('loginTipoContrato').value = fullUser.tipo;
                document.getElementById('loginSeccion').value = fullUser.seccion;
                document.getElementById('loginAnio').value = fullUser.anio;
                document.getElementById('loginPuntos').value = fullUser.puntos;
                document.getElementById('loginPassword').value = ''; 
                document.getElementById('loginPassword').focus();   
            }
        }
    });

    function addRecentLogin(user) {
        let recentLogins = JSON.parse(localStorage.getItem('recentLogins')) || [];
        recentLogins = recentLogins.filter(u => u.id !== user.id); 
        recentLogins.unshift({ id: user.id, nombre: user.nombre, apellido: user.apellido });
        recentLogins = recentLogins.slice(0, 4);
        localStorage.setItem('recentLogins', JSON.stringify(recentLogins));
    }

    function completeLogin(user) {
        localStorage.setItem('loggedInUser', JSON.stringify(user));
        addRecentLogin(user);
        location.reload();
    }

    function checkLogin() {
        const user = JSON.parse(localStorage.getItem('loggedInUser'));
        const helpTitle = document.getElementById('help-title');
        const helpContentLogin = document.getElementById('help-content-login');
        const helpContentMain = document.getElementById('help-content-main');
        
        if (helpBtn) helpBtn.style.display = 'flex'; 

        if (user && user.id) {
            loggedInUser = user;
            loginContainer.style.display = 'none'; 
            mainContent.style.display = 'block'; 
            menuToggle.style.display = 'flex';
            document.getElementById('userInfo').textContent = `${user.nombre} ${user.apellido}`;
            
            if(helpTitle) helpTitle.textContent = 'Guía de Uso';
            if(helpContentLogin) helpContentLogin.classList.remove('active-help');
            if(helpContentMain) helpContentMain.classList.add('active-help');

            setupMenu(); 
            initApp();
        } else {
            loginContainer.style.display = 'block'; 
            mainContent.style.display = 'none'; 
            menuToggle.style.display = 'none';

            if(helpTitle) helpTitle.textContent = 'Ayuda de Acceso';
            if(helpContentMain) helpContentMain.classList.remove('active-help');
            if(helpContentLogin) helpContentLogin.classList.add('active-help');
            
            displayRecentLogins();
        }
    }
    
    document.getElementById('loginForm').addEventListener('submit', e => {
        e.preventDefault();
        const nombre = document.getElementById('loginNombre').value.trim();
        const apellido = document.getElementById('loginApellido').value.trim();
        const password = document.getElementById('loginPassword').value;
        if (!nombre || !apellido || !password) { showToast("Nombre, Apellido y Contraseña son requeridos.", "error"); return; }
        const userId = `${nombre.toLowerCase()}-${apellido.toLowerCase()}`;
        const appData = getAppData();
        let existingUser = appData.usuarios[userId];
        
        if (existingUser) { 
            if (existingUser.password === password) {
                existingUser.tipo = document.getElementById('loginTipoContrato').value;
                existingUser.seccion = document.getElementById('loginSeccion').value;
                existingUser.anio = document.getElementById('loginAnio').value;
                existingUser.puntos = parseFloat(document.getElementById('loginPuntos').value) || 0;
                appData.usuarios[userId] = existingUser;
                saveAppData(appData);
                pendingLoginUser = existingUser;
                if (!pendingLoginUser.telefono) {
                    document.getElementById('phoneModal').style.display = 'flex';
                } else {
                    completeLogin(pendingLoginUser);
                }
            } else { 
                showToast('Contraseña incorrecta.', 'error'); 
            }
        } else { 
            const newUser = {
                id: userId, nombre: nombre, apellido: apellido, 
                tipo: document.getElementById('loginTipoContrato').value, 
                seccion: document.getElementById('loginSeccion').value, 
                anio: document.getElementById('loginAnio').value, 
                puntos: parseFloat(document.getElementById('loginPuntos').value) || 0, 
                password: password, telefono: ''
            };
            if (!newUser.tipo || !newUser.seccion || !newUser.anio || newUser.puntos <= 0) { 
                showToast("Completa todos los campos para registrarte.", "error"); return; 
            }
            pendingLoginUser = newUser;
            document.getElementById('phoneModal').style.display = 'flex';
        }
    });
    
    document.getElementById('logoutBtn').addEventListener('click', () => { localStorage.removeItem('loggedInUser'); location.reload(); });
    
    // --- PASSWORD & PHONE MODAL LOGIC ---
    document.getElementById('savePhoneBtn').addEventListener('click', () => {
        const phoneInput = document.getElementById('phoneInput');
        const phone = phoneInput.value.trim();
        if (phone && !isNaN(phone) && phone.length > 5) {
            if (pendingLoginUser) {
                pendingLoginUser.telefono = phone;
                let appData = getAppData();
                appData.usuarios[pendingLoginUser.id] = pendingLoginUser;
                saveAppData(appData);
                document.getElementById('phoneModal').style.display = 'none';
                phoneInput.value = '';
                completeLogin(pendingLoginUser);
            }
        } else {
            showToast("Por favor, ingresa un número de teléfono válido.", "error");
        }
    });

    document.getElementById('forgotPasswordLink').addEventListener('click', (e) => {
        e.preventDefault();
        const modal = document.getElementById('forgotPasswordModal');
        modal.querySelector('#verifyPhoneContainer').style.display = 'block';
        modal.querySelector('#newPasswordContainer').style.display = 'none';
        modal.querySelector('#verifyPhoneBtn').style.display = 'inline-block';
        modal.querySelector('#saveNewPasswordBtn').style.display = 'none';
        modal.querySelector('#recoverPhoneInput').value = '';
        modal.querySelector('#newPasswordInput').value = '';
        modal.querySelector('#recoveryResult').style.display = 'none';
        modal.style.display = 'flex';
    });

    document.getElementById('cancelForgotBtn').addEventListener('click', () => {
        document.getElementById('forgotPasswordModal').style.display = 'none';
        userToChangePasswordId = null;
    });

    document.getElementById('verifyPhoneBtn').addEventListener('click', () => {
        const phone = document.getElementById('recoverPhoneInput').value.trim();
        const resultDiv = document.getElementById('recoveryResult');
        if (!phone) { showToast("Ingresa un número de teléfono.", "error"); return; }

        const allUsers = Object.values(getAppData().usuarios);
        const foundUser = allUsers.find(user => user.telefono === phone);

        if (foundUser) {
            userToChangePasswordId = foundUser.id;
            const modal = document.getElementById('forgotPasswordModal');
            modal.querySelector('#verifyPhoneContainer').style.display = 'none';
            modal.querySelector('#newPasswordContainer').style.display = 'block';
            modal.querySelector('#verifyPhoneBtn').style.display = 'none';
            modal.querySelector('#saveNewPasswordBtn').style.display = 'inline-block';
        } else {
            resultDiv.textContent = 'No se encontró ninguna cuenta con ese número.';
            resultDiv.className = 'error';
            resultDiv.style.display = 'block';
        }
    });
    
    document.getElementById('saveNewPasswordBtn').addEventListener('click', () => {
        const newPassword = document.getElementById('newPasswordInput').value;
        if(newPassword.length < 4){ showToast("La contraseña debe tener al menos 4 caracteres.", "error"); return; }
        if(userToChangePasswordId){
            const appData = getAppData();
            appData.usuarios[userToChangePasswordId].password = newPassword;
            saveAppData(appData);
            showToast("Contraseña cambiada con éxito.");
            document.getElementById('forgotPasswordModal').style.display = 'none';
            userToChangePasswordId = null;
        }
    });

    // --- LOGIC FOR USER DATA SECTION ---
    function populateUserDataSection() {
        if (!loggedInUser) return;
        document.getElementById('userDataNombre').textContent = `${loggedInUser.nombre} ${loggedInUser.apellido}`;
        document.getElementById('userDataContrato').textContent = loggedInUser.tipo;
        document.getElementById('userDataPuntos').textContent = loggedInUser.puntos;
        document.getElementById('userDataAnio').textContent = loggedInUser.anio;
    }
    
    document.getElementById('changePasswordBtn').addEventListener('click', () => {
        document.getElementById('newPasswordLoggedInInput').value = '';
        document.getElementById('changePasswordModal').style.display = 'flex';
    });

    document.getElementById('cancelChangePasswordBtn').addEventListener('click', () => {
        document.getElementById('changePasswordModal').style.display = 'none';
    });
    
    document.getElementById('saveNewPasswordLoggedInBtn').addEventListener('click', () => {
        const newPassword = document.getElementById('newPasswordLoggedInInput').value;
        if (newPassword.length < 4) { showToast("La contraseña debe tener al menos 4 caracteres.", "error"); return; }
        const appData = getAppData();
        appData.usuarios[loggedInUser.id].password = newPassword;
        saveAppData(appData);
        showToast("Contraseña actualizada con éxito.");
        document.getElementById('changePasswordModal').style.display = 'none';
    });


    // DATA IMPORT
    async function importarDesdeSheets() {
        if (!loggedInUser) return;
        const btn = document.getElementById('importarDesdeSheetsBtn');
        btn.textContent = 'Importando...'; btn.disabled = true;
        try {
            const response = await fetch(`${SCRIPT_URL_RECAUDACION}?action=get`);
            if (!response.ok) throw new Error(`Error de red: ${response.statusText}`);
            const result = await response.json();
            if (result.status !== 'success' || !result.data) throw new Error(result.message || 'La respuesta no fue exitosa.');
            
            const userData = getUserData();
            let montosActuales = userData.montosPorFecha || {};
            let registrosNuevos = 0;
            result.data.forEach(dato => {
                const { fecha, tipo, monto } = dato;
                if (!montosActuales[fecha]) montosActuales[fecha] = [];
                const existe = montosActuales[fecha].some(m => m.area === tipo && parseFloat(m.monto) === parseFloat(monto));
                if (!existe) {
                    montosActuales[fecha].push({ area: tipo, monto: parseFloat(monto) });
                    registrosNuevos++;
                }
            });
            if (registrosNuevos > 0) {
                userData.montosPorFecha = montosActuales;
                saveUserData(userData);
                cargarYMostrarMontos();
                showToast(`${registrosNuevos} nuevo(s) registro(s) importado(s).`);
            } else {
                showToast("No se encontraron registros nuevos para importar.");
            }
        } catch (error) {
            showToast('Error al importar desde Sheets: ' + error.message, 'error');
            console.error("Error detallado:", error);
        } finally {
            btn.textContent = 'Importar desde Sheets'; btn.disabled = false;
        }
    }

    // AMOUNTS MANAGEMENT
    function cargarYMostrarMontos() {
        const userData = getUserData();
        const montosPorFecha = userData.montosPorFecha;
        const diasTrabajados = userData.diasTrabajados || [];
        const isPartTime = loggedInUser && loggedInUser.tipo === 'Part Time';
        
        const contenedor = document.getElementById('tarjetasMontos');
        contenedor.innerHTML = '';
        
        let fechasAMostrar = Object.keys(montosPorFecha);

        if (isPartTime) {
            fechasAMostrar = fechasAMostrar.filter(fecha => diasTrabajados.includes(fecha));
        }

        const fechasOrdenadas = fechasAMostrar.sort((a, b) => b.localeCompare(a));
        
        let totalGeneral = 0;
        
        fechasOrdenadas.forEach(fecha => {
            const montos = montosPorFecha[fecha];
            let totalFecha = montos.reduce((sum, m) => sum + parseFloat(m.monto), 0);
            totalGeneral += totalFecha;
            const tarjetaDiv = document.createElement('div');
            tarjetaDiv.className = 'tarjeta collapsed';
            tarjetaDiv.innerHTML = `<h3><span>Fecha: ${formatDate(fecha)}</span><span class="total-in-header">$${formatNumberWithPoints(totalFecha)}</span></h3><div class="montos-list">${montos.map((m, index) => `<div class="monto-item"><span><strong>${m.area}:</strong> $${formatNumberWithPoints(m.monto)}</span><button class="delete-button" data-fecha="${fecha}" data-index="${index}">🗑️</button></div>`).join('')}</div>`;
            contenedor.appendChild(tarjetaDiv);
            tarjetaDiv.querySelector('h3').addEventListener('click', () => tarjetaDiv.classList.toggle('collapsed'));
        });
        document.getElementById('totalDiario').textContent = `Total recaudado: $${formatNumberWithPoints(totalGeneral)}`;
        actualizarCalculoRetiro();
        contenedor.addEventListener('click', e => {
            if (e.target.classList.contains('delete-button')) {
                const { fecha, index } = e.target.dataset;
                const userData = getUserData();
                userData.montosPorFecha[fecha].splice(index, 1);
                if (userData.montosPorFecha[fecha].length === 0) delete userData.montosPorFecha[fecha];
                saveUserData(userData);
                cargarYMostrarMontos(); showToast("Monto eliminado.");
            }
        });
    }
    
    // CALCULATION LOGIC
    function actualizarCalculoRetiro() { if (!loggedInUser) return; loggedInUser.tipo === 'Planta' ? actualizarCalculoPlanta() : actualizarCalculoPartTime(); }
    function actualizarCalculoPlanta() {
        const userData = getUserData();
        const p = loggedInUser.puntos || 0;
        const total = Object.values(userData.montosPorFecha || {}).flat().reduce((s, m) => s + m.monto, 0);
        const div = userData.divisor || 0;
        const anticiposTotal = (userData.anticipos || []).reduce((s, a) => s + a.monto, 0);
        const vpp = div > 0 ? (total / div) : 0; const sub = vpp * p; const res = sub - anticiposTotal;
        document.getElementById('puntosUsuarioDisplayPlanta').textContent = p;
        document.getElementById('totalMontoDividirPlanta').textContent = `$${formatNumberWithPoints(total)}`;
        document.getElementById('divisorDisplayPlanta').textContent = div > 0 ? formatNumberWithPoints(div) : 'N/A';
        document.getElementById('valorPorPuntoDisplayPlanta').textContent = `$${formatNumberWithPoints(vpp)}`;
        document.getElementById('subtotalDisplayPlanta').textContent = `$${formatNumberWithPoints(sub)}`;
        document.getElementById('anticiposDisplayPlanta').textContent = `-$${formatNumberWithPoints(anticiposTotal)}`;
        document.getElementById('resultadoFinalPlanta').textContent = `$${formatNumberWithPoints(res)}`;
        renderAnticiposList('#anticipos-list-container-planta');
    }
    function actualizarCalculoPartTime() {
        const userData = getUserData();
        const p = loggedInUser.puntos || 0, dias = userData.diasTrabajados || [], montos = userData.montosPorFecha || {};
        const pozo = dias.reduce((s, f) => s + (montos[f] || []).reduce((ds, m) => ds + m.monto, 0), 0);
        const div = userData.divisorPartTime || 1;
        const anticiposTotal = (userData.anticipos || []).reduce((s, a) => s + a.monto, 0);
        const vpp = div > 0 ? (pozo / div) : 0; const sub = vpp * p; const res = sub - anticiposTotal;
        document.getElementById('puntosUsuarioDisplayPT').textContent = p;
        document.getElementById('diasTrabajadosDisplayPT').textContent = dias.length;
        document.getElementById('pozoIndividualDisplayPT').textContent = `$${formatNumberWithPoints(pozo)}`;
        document.getElementById('divisorDisplayPT').textContent = formatNumberWithPoints(div);
        document.getElementById('valorPorPuntoDisplayPT').textContent = `$${formatNumberWithPoints(vpp)}`;
        document.getElementById('subtotalDisplayPT').textContent = `$${formatNumberWithPoints(sub)}`;
        document.getElementById('anticiposDisplayPT').textContent = `-$${formatNumberWithPoints(anticiposTotal)}`;
        document.getElementById('resultadoFinalPT').textContent = `$${formatNumberWithPoints(res)}`;
        renderAnticiposList('#anticipos-list-container-pt');
    }
    function renderAnticiposList(containerSelector) {
        const container = document.querySelector(containerSelector);
        if (!container) return;
        const anticipos = getUserData().anticipos || [];
        container.innerHTML = '';
        if (anticipos.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#888; margin:0;">No hay anticipos.</p>';
        } else {
            anticipos.sort((a,b) => b.fecha.localeCompare(a.fecha)).forEach(anticipo => { container.innerHTML += `<div class="anticipo-item"><span>${formatDate(anticipo.fecha)}</span><strong>$${formatNumberWithPoints(anticipo.monto)}</strong><div class="actions"><button class="anticipo-item-btn edit-anticipo-btn" data-id="${anticipo.id}">✏️</button><button class="anticipo-item-btn delete-anticipo-btn" data-id="${anticipo.id}">🗑️</button></div></div>`; });
        }
    }

    // CALENDAR LOGIC
    function renderCalendar(container) {
        let date = new Date();
        const render = () => {
            const month = date.getMonth(), year = date.getFullYear();
            container.innerHTML = `<div class="calendar-header"><button id="prev-month">‹</button><span>${date.toLocaleString("es-ES", { month: "long", year: "numeric" })}</span><button id="next-month">›</button></div><div class="calendar-grid"><div class="day-name">Dom</div><div class="day-name">Lun</div><div class="day-name">Mar</div><div class="day-name">Mié</div><div class="day-name">Jue</div><div class="day-name">Vie</div><div class="day-name">Sáb</div></div>`;
            const firstDay = new Date(year, month, 1).getDay(), lastDate = new Date(year, month + 1, 0).getDate();
            const grid = container.querySelector('.calendar-grid');
            for (let i = 0; i < firstDay; i++) grid.insertAdjacentHTML("beforeend", `<div class="day empty"></div>`);
            const userData = getUserData();
            for (let i = 1; i <= lastDate; i++) {
                const dateString = new Date(year, month, i).toISOString().split('T')[0];
                const isMarked = (userData.diasTrabajados || []).includes(dateString);
                grid.insertAdjacentHTML("beforeend", `<div class="day ${isMarked ? 'marked' : ''}" data-date="${dateString}">${i}</div>`);
            }
            document.getElementById("prev-month").addEventListener("click", () => { date.setMonth(date.getMonth() - 1); render(); });
            document.getElementById("next-month").addEventListener("click", () => { date.setMonth(date.getMonth() + 1); render(); });
        };
        render();
    }
    
    // MODAL & ACTIONS LOGIC
    document.getElementById('main-content').addEventListener('click', e => {
        const targetBtn = e.target.closest('button');
        if (targetBtn) {
            const id = targetBtn.id;
            if (id === 'registrarDivisorBtn') document.getElementById('divisorModal').style.display = 'flex';
            if (id === 'registrarAnticipoBtn') { document.getElementById('addAnticipoModal').style.display = 'flex'; document.getElementById('addAnticipoFechaInput').value = getTodayDateString(); }
            if (id === 'resetMesBtn') { if (confirm('¿Estás SEGURO de reiniciar el mes?')) { let userData = getUserData(); userData.montosPorFecha = {}; userData.anticipos = []; userData.divisor = 0; userData.diasTrabajados = []; saveUserData(userData); showToast('Datos reiniciados.'); setTimeout(() => location.reload(), 1000); }}
            if (id === 'registrarDivisorPTBtn') {
                const input = document.getElementById('divisorPTInput');
                const userData = getUserData();
                input.value = formatNumberWithPoints(userData.divisorPartTime || 1);
                input.dataset.cleanValue = userData.divisorPartTime || 1;
                document.getElementById('divisorPTModal').style.display = 'flex';
            }
        }
        const anticipoBtn = e.target.closest('.anticipo-item-btn');
        if (anticipoBtn) {
            const anticipoId = Number(anticipoBtn.dataset.id);
            let userData = getUserData();
            if (anticipoBtn.classList.contains('delete-anticipo-btn')) {
                userData.anticipos = userData.anticipos.filter(a => a.id !== anticipoId);
                saveUserData(userData); actualizarCalculoRetiro(); showToast("Anticipo eliminado.");
            }
            if (anticipoBtn.classList.contains('edit-anticipo-btn')) {
                const anticipoToEdit = userData.anticipos.find(a => a.id === anticipoId);
                if(anticipoToEdit) {
                    currentEditAnticipoId = anticipoToEdit.id;
                    const montoInput = document.getElementById('editAnticipoMontoInput');
                    montoInput.value = formatNumberWithPoints(anticipoToEdit.monto);
                    montoInput.dataset.cleanValue = anticipoToEdit.monto;
                    document.getElementById('editAnticipoFechaInput').value = anticipoToEdit.fecha;
                    document.getElementById('editAnticipoModal').style.display = 'flex';
                }
            }
        }
        if(e.target.classList.contains('day') && !e.target.classList.contains('empty')) {
            const dateString = e.target.dataset.date;
            const userData = getUserData();
            const dias = userData.diasTrabajados || [];
            const dateIndex = dias.indexOf(dateString);
            if (dateIndex > -1) { dias.splice(dateIndex, 1); } else { dias.push(dateString); }
            userData.diasTrabajados = dias;
            saveUserData(userData);
            e.target.classList.toggle('marked');
            actualizarCalculoPartTime();
            cargarYMostrarMontos(); 
        }
    });

    ['cancelAddAnticipoBtn', 'cancelEditAnticipoBtn', 'cancelDivisorBtn', 'cancelDivisorPTBtn'].forEach(id => { document.getElementById(id).addEventListener('click', () => { document.getElementById(id.replace('cancel', '').replace('Btn', 'Modal')).style.display = 'none'; }); });
    document.getElementById('saveAddAnticipoBtn').addEventListener('click', () => {
        const monto = parseFloat(document.getElementById('addAnticipoMontoInput').dataset.cleanValue) || 0;
        const fecha = document.getElementById('addAnticipoFechaInput').value;
        if (monto <= 0 || !fecha) { showToast('Datos inválidos.', 'error'); return; }
        const userData = getUserData();
        userData.anticipos.push({ id: Date.now(), monto, fecha });
        saveUserData(userData);
        document.getElementById('addAnticipoMontoInput').value = '';
        document.getElementById('addAnticipoModal').style.display = 'none';
        actualizarCalculoRetiro(); showToast("Anticipo registrado.");
    });
    document.getElementById('saveEditAnticipoBtn').addEventListener('click', () => {
        const newMonto = parseFloat(document.getElementById('editAnticipoMontoInput').dataset.cleanValue) || 0;
        const newFecha = document.getElementById('editAnticipoFechaInput').value;
        if (newMonto <= 0 || !newFecha) { showToast('Datos inválidos.', 'error'); return; }
        const userData = getUserData();
        const idx = userData.anticipos.findIndex(a => a.id === currentEditAnticipoId);
        if (idx > -1) {
            userData.anticipos[idx].monto = newMonto; userData.anticipos[idx].fecha = newFecha;
            saveUserData(userData);
            document.getElementById('editAnticipoModal').style.display = 'none';
            currentEditAnticipoId = null;
            actualizarCalculoRetiro(); showToast("Anticipo actualizado.");
        }
    });
    document.getElementById('saveDivisorBtn').addEventListener('click', () => {
        const divisor = parseFloat(document.getElementById('divisorInput').dataset.cleanValue) || 0;
        if (divisor <= 0) { showToast('Divisor inválido.', 'error'); return; }
        const userData = getUserData(); userData.divisor = divisor; saveUserData(userData);
        document.getElementById('divisorInput').value = '';
        document.getElementById('divisorModal').style.display = 'none';
        actualizarCalculoPlanta(); showToast("Divisor general guardado.");
    });
    document.getElementById('saveDivisorPTBtn').addEventListener('click', () => {
        const divisor = parseFloat(document.getElementById('divisorPTInput').dataset.cleanValue) || 1;
        if (divisor <= 0) { showToast('Divisor inválido.', 'error'); return; }
        const userData = getUserData(); userData.divisorPartTime = divisor; saveUserData(userData);
        document.getElementById('divisorPTModal').style.display = 'none';
        actualizarCalculoPartTime(); showToast("Divisor personal guardado.");
    });

    // APP INITIALIZATION
    function initApp() {
        if (!loggedInUser) return;
        
        document.getElementById('titulo-retiro').textContent = `Retiro de Propina (${loggedInUser.tipo})`;
        
        if (loggedInUser.tipo === 'Planta') {
            document.getElementById('vistaPlanta').style.display = 'block'; document.getElementById('vistaPartTime').style.display = 'none';
        } else {
            document.getElementById('vistaPlanta').style.display = 'none'; document.getElementById('vistaPartTime').style.display = 'block';
            renderCalendar(document.getElementById('calendar-container'));
        }
        cargarYMostrarMontos(); actualizarCalculoRetiro();
        document.getElementById('importarDesdeSheetsBtn').addEventListener('click', importarDesdeSheets);
        ['addAnticipoMontoInput', 'editAnticipoMontoInput', 'divisorInput', 'divisorPTInput'].forEach(id => setupNumericInputFormatting(document.getElementById(id)));
        importarDesdeSheets();
    }
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.service-worker.register('service-worker.js').then(reg => console.log('SW registered.')).catch(err => console.log('SW registration failed: ', err)); }); }
    
    // Initial theme setup
    const savedTheme = localStorage.getItem('theme') || 'light';
    applyTheme(savedTheme);

    checkLogin();
});
</script>
</body>
</html>
